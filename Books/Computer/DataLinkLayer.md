# 数据链路层的功能

- 数据链路层（Data Link Layer）将物理层提供的可能出错的物理连接改造为逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路。

## 为网络层提供服务

### 无确认的无连接服务

1. 源机器发送数据帧时不需要先建立链路连接
2. 目的机器收到数据帧时不需要返回确认
3. 对丢失的帧，数据链路层不负责重发而是交给上层处理

- 适用于实时通信或误码率较低的通信信道，如以太网。

### 有确认的无连接服务

1. 源机器发送数据帧时不需要先建立链路连接
2. 目的机器收到数据帧时必须返回确认，源机器在规定时间内未收到确定信号时，就重传丢失的帧。
3. 适用于误码率较高的通信信道，如无线通信。

### 有确认的面向连接服务

1. 链路管理：帧传输过程分为建立数据链路、传输帧、释放数据链路三个阶段。
2. 目的机器对收到的每一帧都要给出确认，源机器收到确认后才能发送下一帧，最可靠。
3. 适用于通信要求（可靠性、实时性）较高的场合。

## 帧

### 组帧

- 两台主机之间传输信息时，为了使接收方能够正确地接收并检查所传输的帧，发送方必须按照一定的规则将网络层递交的分组封装成帧（组帧），以帧的格式进行传送。
- 组帧要添加首部和尾部：在网络中信息是以帧为最小单位进行传输的，接受端要正确地接收帧，就必须要确认该帧在一串比特流中的开始和结束位置（帧定界）。

<details>
    <summary>
        在一个链路层协议中，使用下列字符编码：<br/>
        A 01000111;&nbsp;&nbsp;&nbsp;B 11100011;&nbsp;&nbsp;&nbsp;ESC（转义字符） 11100000;&nbsp;&nbsp;&nbsp;FLAG（首尾标志） 01111110<br/>
        在使用下列成帧方法的情况下，说明为传送4个字符A、B、ESC、FLAG所组织的帧而实际发送的二进制序列。<br/>
        （1）字符计数法<br/>
        （2）字符填充的首尾定界符法<br/>
        （3）比特填充的首尾标志法
    </summary>
    （1）第一个字节为计算字符，共有4+1个字符：00000101 01000111 11100011 11100000 01111110<br/>
    （2）FLAG A B ESC ESC ESC FLAG FLAG：01111110 01000111 11100011 11100000 11100000 11100000 01111110 01111110<br/>
    （3）FLAG A B ESC FLAG FLAG：01111110 01000111 11<u>0</u>100011 1110000 0011111<u>0</u>10 01111110
</details>

#### 字符计数法

- 字符计数法在帧头部使用一个计数字段来表明帧内字符数（包括该计数字符在内）。若计数字段出错，就失去了帧边界划分的依据，则接收方无法判断所传输帧的结束位和下一帧的开始位，收发双方将失去同步。

#### 字符填充的首尾定界符法

- 字符填充法使用特定字符来定界一帧的开始和结束。

1. 控制字符SOH：放在帧的最前面，表示帧的首部开始
2. 控制字符EOT：表示帧的结束
3. 转义字符ESC：发送方在信息位中出现的特殊字符（SOH、EOT、ESC）前面填充ESC来区分，以实现透明传输。接受方在接受到数据后，会自己删除这些插入的ESC字符，得到原来的数据。

<img src="../../pictures/计算机网络-字符填充法.drawio.svg" width="650"/> 

#### 零比特填充的首尾标志法

- 零比特填充法允许数据帧包含任意个数的比特，允许每个字符的编码包含任意个数的比特，使用特定的比特模式（01111110）来标志一帧的开始和结束。发送方的数据链路层在信息位中遇到5个连续的“1“时，自动在后面加入一个“0”；而接受方每受到5个连续的“1”，自动删除后面紧跟着的“0”，以恢复原信息。
- 零比特法容易使用硬件实现、性能优于字符填充法。

#### 违规编码法

- 在物理层进行比特编码时，通常采用违规编码法。局域网IEEE 802标准就利用违规编码来定界帧的起始和终止。
- 违规编码法不需要任何填充技术，便能实现数据传输的透明性，但只适合于采用冗余编码的特殊编码环境。

> 违规编码（没有采用的编码）：曼彻斯特编码方法将数据比特“1”编码为“高-低“电平对，“0”编码为“低-高”电平对，而“高-高”电平对和“低-低”电平对没有被采用，在数据比特中是违规的，即违规编码。

### 帧定界、帧同步、透明传输

- 帧定界：帧的首部和尾部中含有大量的控制信息，可以用于确定帧的界限。
- 帧同步：接收方应能从接收到的二进制比特流中区分区帧的起始和终止（HDLC协议中的帧标志位F）。

<img src="../../pictures/计算机网络-HDLC标准帧格式.drawio.svg" width="450"/> 

- 透明传输：不管所传数据是什么样的比特组合，都应当能在链路上传送。
- MTU（最大传送单元）：每种数据链路层协议都规定了帧的数据部分的长度上限。

## 差错控制

- 差错控制是用于使发送方确认接收方正确接收到其发送的数据的方法。

1. 位错（比特差错）：帧中的某些位出现错误。通常采用CRC（循环冗余校验）来发现位错，通过ARQ来重传出错的帧。
2. 帧错：帧的丢失、重复、失序等错误。在数据链路层引入定时器和编号机制，保证每一帧最终都能有且仅有一次正确地交付给目的结点。

- 对于位错，利用编码技术进行差错控制，分为检错编码和纠错编码。

1. ARQ（自动重传请求，Automatic Repeat reQuest）让发送方将要发送的数据帧附加一定的CRC冗余检错码一并发送，接受方根据检错码对数据帧进行错误校验，若发现错误则丢弃，发送方超时重传该数据帧，直到接收到正确的码字为止。ARQ只需要返回很少的控制信息就可有效地确认所发数据帧是否被正确接收。
2. FEC（前向纠错）的接受方不仅能发现差错，还能确定比特串的错误位置，从而加以纠正。

### 检错编码

- 检错编码都采用冗余编码技术，在有效数据（信息位）被发送前，先按某种关系附加一定的冗余位，构成一个符合某一规则的码字后再发送。当要发送的有效数据变化时，相应的冗余位也随之变化，使得码字遵从不变的规则。接收端根据收到的码字是否仍然符合原规则来判断是否出错。

#### 奇偶校验码

- 奇偶校验码包括奇校验码和偶校验码，是最基本的检错码，只能检测奇数位的出错情况，并不清楚哪些位出错，也不能发现偶数位的出错情况。
- 奇偶校验码由n-1位信息元和1位校验元组成。

1. 若为奇校验码，则在附加一个校验元后，码长为n的码字中“1”的个数为奇数
2. 若为偶校验码，则在附加一个校验元后，码长为n的码字中“1”的个数为偶数

#### 循环冗余码 CRC

- CRC（循环冗余码、多项式码，Cyclic Redundancy Code），任何一个由二进制数位串组成的代码都可以与一个只含有0和1两个系数的多项式建立一一对应的关系。一个k位帧可以视为从X<sup>k-1</sup>到X<sup>0</sup>的k次多项式的系数序列。
- FCS（帧检验序列）给定一个m bit的帧或报文，发送器生成一个r bit的序列（冗余码、校验码），形成的帧由m+r bit组成。发送方和接收方事先商定一个多项式G(x)（最高位和最低位必须为1），使这个带检验码的帧正好能够被G(X)整除，接受方用同样的G(x)来除收到的帧，若果没有余数，则认为无差错。计算冗余码的步骤如下：

1. 加0：假设G(x)的阶为r（冗余码的位数取决于G(x)的最高次数r），则在帧的低位端加上r个0。
2. 模2除法（实质上就是异或）：利用模2除法，用G(x)对应的数据串区除步骤1中得到的数据串，得到的余数为冗余码（共r位，前面的0不可省略）。

- 通过CRC的检错技术，数据链路层实现了对帧的无差错接收，认为只要是数据链路层接受的帧（而不仅仅是接收），在传输过程中都没有产生差错。

> CRC具有纠错功能，而数据链路层仅使用了其检错功能。

<details>
    <summary>
        在数据传输过程中，若接收方收到的二进制比特序列为1011011010，接收双方采用的生成多项式为 G(x) = x<sup>4</sup> + x<sup>3</sup> + 1，则该比特序列在传输过程中是否出错？如果未出现差错，那么发送数据的比特序列和CRC校验码的比特序列分别是什么？
    </summary>
    由G(x)得到，用于校验的除数为11001，CRC校验码为4位<br/>
    对1011011010和11001进行模2除法，计算是否出错<br/>
    <img src="../../pictures/计算机网络-CRC校验mod2.drawio.svg" width="200"/><br/>
    计算结果中，余数为0，故没有出错，发送数据的比特序列为101101，CRC校验码的比特序列为1010
</details>

### 纠错编码

- 在每个要发送的数据块上附加足够的冗余信息，使接收方能够推导出发送方实际送出的应该是什么样的比特串。

#### 汉明码

- 在有效信息位中加入几个校验位形成汉明码，并把汉明码的每个二进制位分配到几个奇偶校验组中。当某一位出错后，就会引起有关的几个校验位的值发生变化，不但可以发现错位，还能指出错位的位置，为自动纠错提供依据。

1. 汉明码的位数：假定n为有效信息的位数，k为校验位的位数，则信息位n和校验位k满足 n + k &le; 2<sup>k</sup>-1
2. 校验位的分布：规定校验位P<sub>i</sub>在汉明码位2<sup>i-1</sup>（H<sub>2<sup>i-1</sup></sub>）的位置上，其余各位为信息位，信息位按原来的顺序插入汉明码的空位。
3. 分组校验：每个数据位用多个校验位进行校验，被校验数据位的汉明位号等于校验该数据位的各校验位汉明位号之和，且校验位不需要再被校验。
4. 校验位的取值：校验位P<sub>i</sub>的值为第i组（由该校验位校验的数据位）所有位“异或“得到。
5. 校验：每个校验组利用校验位和参与形成该校验位的信息位进行奇偶校验检查，共有k个校验方程。若校验的结果全为0，则无错；否则出错，校验的结果就是错误位的汉明位号，直接将该位取反即可。

- 汉明码纠错d位，需要码距为2d+1位的编码方案；而汉明码检错d位，只需要码距为d+1位的编码方案。

<details>
    <summary>1010对应的汉明码为？</summary>
    1. 有效信息的位数n=4，校验位的位数k，满足n+k&le;2<sup>k</sup>-1，则k=3<br/>
    2. 形成汉明码：<br/>
    H<sub>7</sub>H<sub>6</sub>H<sub>5</sub>H<sub>4</sub>H<sub>3</sub>H<sub>2</sub>H<sub>1</sub><br/>
    D<sub>4</sub>D<sub>3</sub>D<sub>2</sub>P<sub>3</sub>D<sub>1</sub>P<sub>2</sub>P<sub>1</sub><br/>
    3. 分组校验<br/>
    D<sub>1</sub>（H<sub>3</sub>）由P<sub>2</sub>P<sub>1</sub>（H<sub>2</sub>H<sub>1</sub>）校验<br/>
    D<sub>2</sub>（H<sub>5</sub>）由P<sub>3</sub>P<sub>1</sub>（H<sub>4</sub>H<sub>1</sub>）校验<br/>
    D<sub>3</sub>（H<sub>6</sub>）由P<sub>3</sub>P<sub>2</sub>（H<sub>4</sub>H<sub>2</sub>）校验<br/>
    D<sub>4</sub>（H<sub>7</sub>）由P<sub>3</sub>P<sub>2</sub>P<sub>1</sub>（H<sub>4</sub>H<sub>2</sub>H<sub>1</sub>）校验<br/>
    4. 校验位取值：<br>
    P<sub>1</sub>=D<sub>1</sub>&oplus;D<sub>2</sub>&oplus;D<sub>4</sub>=0&oplus;1&oplus;1=0<br/>
    P<sub>2</sub>=D<sub>1</sub>&oplus;D<sub>3</sub>&oplus;D<sub>4</sub>=0&oplus;0&oplus;1=1<br/>
    P<sub>3</sub>=D<sub>2</sub>&oplus;D<sub>3</sub>&oplus;D<sub>4</sub>=1&oplus;0&oplus;1=0<br/>
    则汉明码为：1001010<br/>
    5. 校验：<br/>
    S<sub>1</sub>=P<sub>1</sub>&oplus;D<sub>1</sub>&oplus;D<sub>2</sub>&oplus;D<sub>4</sub><br/>
    S<sub>2</sub>=P<sub>2</sub>&oplus;D<sub>1</sub>&oplus;D<sub>3</sub>&oplus;D<sub>4</sub><br/>
    S<sub>3</sub>=P<sub>3</sub>&oplus;D<sub>2</sub>&oplus;D<sub>3</sub>&oplus;D<sub>4</sub><br/>
    S<sub>3</sub>S<sub>2</sub>S<sub>1</sub>，找到错位
</details>

## 流量控制

- 流量控制实际上是由接收方控制发送方的发送数据的速率，使其发送速率不超过接收方的接收能力。对于数据链路层，控制的是点到点的数据链路上的流量；对于传输层，控制的是端到端之间的流量。

> OSI体系结构中，数据链路层具有流量控制的功能；而TCP/IP体系结构中，流量控制的功能被移到了传输层。

- 数据链路层的可靠传输机制通常使用确认和超时重传两种机制，实际的有线网络的数据链路层很少使用可靠传输。

- 确认是一种无数据的控制帧，使得接收方可以让发送方知道哪些内容被正确接收。

1. 捎带确认是为了提高传输效率，将确认捎带在一个回复帧。
2. [累积确认](#累积确认)：GBN和SR都采用该方式。

- 超时重传（ARQ，Automatic Repeat reQuest）通过接收方请求发送方重传出错的数据帧来恢复出错的帧。（1）停止-等待（Stop-and-Wait）；（2）后退N帧（Go-Back-N）；（3）选择性重传（Selective Repeat）。后两种协议（连续ARQ协议）结合了滑动窗口技术和请求重发技术，由于窗口尺寸开到足够大时，帧在线路上可以连续地流动。

### 滑动窗口 可靠传输协议

- 任意时刻，发送方都维持一组连续的允许发送的帧的序号（发送窗口），接收方也维持一组连续的允许接收帧的序号（接收窗口）。发送窗口用来对发送方进行流量控制，而发送窗口的大小W<sub>T</sub>代表在还未收到对方确认信息的情况下，发送方最多还可以发送多少个数据帧。而接收方只有在收到的数据帧的序号都落入接收窗口时，才可以将该数据帧收下，否则一律丢弃。

1. 发送端每收到一个确认帧，发送窗口就向前滑动一个帧的位置，发送窗口内没有可以发送的帧（窗口内的帧全部是已发送但未收到确认的帧）时，发送方就会停止发送，直到收到接收方发送的确认帧使窗口移动，窗口内有可以发送的帧后，才开始继续发送。

2. 接收端收到数据帧后，将窗口向前移一个位置，并发回确认帧。若收到的数据帧落在接收窗口外，则丢弃。

- 滑动窗口 = 发送窗口 + 接收窗口，且窗口的大小在传输过程中是固定的：

1. 停止-等待协议：发送窗口W<sub>T</sub>=1，接收窗口W<sub>R</sub>=1
2. 后退N帧协议：发送窗口W<sub>T</sub>&gt;1，接收窗口W<sub>R</sub>=1
3. 选择重传协议：发送窗口W<sub>T</sub>&gt;1，接受窗口W<sub>R</sub>&gt;1

- 对滑动窗口协议而言，发送窗口尺寸范围 1 &le; W<sup>R</sup> &le; 2<sup>n</sup> -1；接收窗口的尺寸范围 W<sup>R</sup> + W<sup>T</sup> &le; 2<sup>n</sup>。（n为帧编号比特数）

<img src="../../pictures/计算机网络-滑动窗口-发送窗口-接收窗口.drawio.svg" width="900"/> 

#### 停止-等待协议

- 停止-等待协议（Stop-and-Wait）的发送方每发送一帧，都要等待接收方的应答信号，之后才能发送下一帧；接收方每接收一帧都要反馈一个应答信号，表示可接收下一帧，若接收方不反馈应答信号，则发送方必须一直等待。相当于W<sub>T</sub>和W<sub>R</sub>均为1的滑动窗口，传输效率低。
- 发送方和接收方都须设置一个帧缓冲区，发送端在发送完数据帧时，必须在其发送缓存中保留该数据帧的副本（用于出差错时进行重传），只有收到接收方发来的确认帧ACK时，才可以清除该副本。

1. 对于数据帧丢失、收到的帧被破坏的情况，发送端设置了一个计时器。发送一个帧之后，发送端等待确认，若在计时器计满后，仍未收到确认，则重发该帧。
2. 对于数据帧正确而确认帧被破坏的情况，接收端已经收到正确的数据帧，而发送端没有收到确认帧。发送方会重发该数据帧，而接收方收到该数据帧（之前已经正确接收）时，丢弃该数据帧，并重发该数据帧对应的确认帧。
3. 判定重复帧：停止-等待协议每发送一个数据帧就停止并等待，使用1bit编号即可，发送的帧交替使用0和1来标识，确认帧分别使用ACK0和ACK1来表示。若连续收到相同序号的确认帧，则表明接收端收到了重复帧。

<img src="../../pictures/计算机网络-stop-and-wait.drawio.svg" width="560"/> 

#### GBN 后退N帧协议

- 在后退N帧式ARQ中，发送方无须在收到上一帧的ACK后才能开始发送下一帧，而是可以连续发送帧，但只允许按顺序接收帧。

1. <span name="累积确认">累积确认</span>：GBN协议规定接收端可以在连续收到若干个正确的数据帧之后，才对最后一个数据帧发送确认信息，或捎带确认，意味着被确认的帧和其之前的所有帧都正确无误地被收到。
2. 顺序接收：（1）接收方检测出失序的数据帧之后，重复发送此前已经发送的最后一个确认帧ACKn，要求发送方重新发送该出差错的数据帧，而在此期间，若接收方收到在该出差错的数据帧后面的数据帧，则一律丢弃，不管是否正确，直到该出差错的数据帧被正确接收；（2）发送方发现某个已发送的数据帧的计时器超时后仍未收到对应的确认信息，判断该帧出错或丢失，发送方重传该数据帧及其随后的N个帧。因此，若信道的传输质量很差导致误码率较高，则后退N帧协议不一定优于停止-等待协议。

<img src="../../pictures/计算机网络-GBN协议的工作原理.drawio.svg" width="630"/> 

- 后退N帧协议的接收窗口W<sub>R</sub>=1，保证按序接收数据帧。若采用n比特对帧编号，则对应的发送窗口应满足1 &lt; W<sub>T</sub> &le; 2<sup>n</sup>-1。若W<sub>T</sub> &gt; 2<sup>n</sup>-1，则此时的发送窗口内存在至少一对编号相同的数据帧，导致接收方无法分辨这些帧。

#### SR 选择重传协议

- SR（选择重传协议，Selective Repeat）只重传出现差错的数据帧或计时器超时的数据帧。此时，必须加大接收窗口以缓冲发送序号不连续但仍处在接收窗口中的部分数据帧，等到收到所缺少的数据帧后再一并交付给主机。

1. 每个发送缓冲区对应一个计时器，计时器超时后，该缓冲区的帧就会被重传。
2. NAK机制：一旦接收方怀疑帧出错，就会发送一个否定帧NAK给发生方，要求发送方对NAK指定的帧进行重传。

<img src="../../pictures/计算机网络-SR协议的工作原理.drawio.svg" width="600"/> 

- 选择重传协议中的接收端所需的缓冲区的数目等于接收窗口的大小，要设置足够容量的缓冲区来暂存未按序但正确到达的帧，且不能接受超过接收窗口边界的序号的帧。

1. 对滑动窗口协议而言，发送窗口尺寸范围 1 &le; W<sup>R</sup> &le; 2<sup>n</sup> -1；接收窗口的尺寸范围 W<sup>R</sup> + W<sup>T</sup> &le; 2<sup>n</sup>。（n为帧编号比特数）

2. 对SR协议而言，接收窗口与接收窗口长度都不固定，但为提高传输效率，通常设置滑动窗口长度等于接收窗口长度，即W<sub>Tmax</sub> = W<sub>Rmax</sub> = 2<sup>n-1</sup>。

<img src="../../pictures/计算机网络-SR缓冲区工作原理.drawio.svg" width="700"/> 

### 信道利用率

- [信道利用率](./网络体系结构.md)（信道效率）是有效数据传输时间占总传输时间的比率，而在数据链路层的流量控制中特指发送方在一个发送周期的时间内 ，有效数据传输时间占整个发送周期的比率。

<img src="../../pictures/20231125201249.png" width="760"/> 

<details>
    <summary>两台主机之间的数据链路采用后退N帧协议（GBN）传输数据，数据传输速率为16kb/s，单向传播时延为270ms，数据帧长度范围是128~512字节，接收方总是以与数据帧等长的帧进行确认。为使信道利用率达到最高，帧序号的比特数至少为______。</summary>
    数据帧的长度范围是128~512字节，采用最小的数据帧长度128B，保证最少有效数据的信道利用率也达到最高<br/>
    一个数据帧的发送时延 t = 128B / 16 kbit/s = 64ms<br/> 
    发送周期 T = 一个数据帧的发送时延 + 一个数据帧的单向传播时延 + 确认帧的发送时延 + 确认帧的单向传播时延 = 64ms + 270ms + 64ms + 270ms = 668ms<br/>
    则，在发送周期T内，可以发送的帧数 = T / t = 668ms / 64 ms = 10.4 帧，至少需要4位进行编号，故，帧序号的比特数至少为4 bit。
</details>

<details>
    <summary>主机甲通过128kb/s卫星链路，采用滑动窗口协议向主机乙发送数据，链路单向传播时延为250ms，帧长为1000字节。不考虑确认帧的开销，为使链路利用率不小于80%，帧序号的比特数至少是______。</summary>
    信道利用率 = (L / 128kbit/s) / (1000B / 128kbit/s + 250ms + 250ms) &ge; 80%<br/>
    则 L &ge; 7200B ，在一个发送周期内，可以发送的帧数为 L / 1000B &ge; 7.2帧，故帧序号的比特数为4 bit
</details>
<details>
    <summary>主机甲与主机乙之间使用后退N帧协议（GBN）传输数据，甲的发送窗口尺寸为1000，数据帧长为1000字节，信道带宽为100Mb/s，乙每收到一个数据帧立即利用一个短帧（忽略其传输时延）进行确认，若甲乙之间的单向传播时延为50ms，则甲可以达到的最大平均数据传输速率约为______。
    </summary>
    甲的发送窗口尺寸为1000，则在甲收到第一个确认帧之前，最多能发送1000个数据帧，即甲在确认之前发送的最大信息量 = 发送窗口尺寸 * 数据帧长度 = 1000 * 1000B = 10<sup>6</sup>B<br/>
    从甲发出第一个数据帧到收到其确认的时间 = 1000B / 100Mbit/s + 50ms + 50ms = 0.1008s<br/>
    则，甲可以达到的最大数据传输速率 = 10<sup>6</sup>B / 0.1008s &asymp; 10MB/s = 80Mbit/s
</details>
## 介质访问控制

- MAC（介质访问控制子层，Medium Access Control），决定广播信道中信道分配的协议，为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号，以协调活动结点的传输。使广播信道逻辑上变为点到点的信道。

### 信道划分介质访问控制（多路复用）

- 信道划分介质访问控制将使用介质的每个设备与来自同一信道上的其他设备的通信隔离，将时域和频域资源合理地分配给网络上的设备。
- 多路复用技术：把多个信号组合在一条物理信道上进行传输，使多个计算机或终端设备共享信道资源（复用信道），提高信道的利用率。实质上就是通过分时、分频、分码等方法将原来的一条广播信道从逻辑上分为几条用于两个结点之间通信的互不干扰的子信道，实际上把广播信道转换为点对点信道。

#### FDM 频分多路复用

- 频分多路复用：将多路基带信号调制到不同频率载波上，再叠加形成一个复用信号。在物理信道的可用带宽超过单个原始信号所需带宽的情况下，可将该物理信道的总带宽分割成若干与传输单个信号带宽相同（或略宽）的子信道，每个子信道传输一种信号。每个子信道分配的带宽可不相同，但总和不能超过信道的总带宽。而为了防止子信道之间的干扰，相邻信道之间需要加入保护频带。
- FDM适用于传输模拟信号，FDM技术成熟、较易实现，充分利用了媒体的带宽。

<img src="../../pictures/计算机组成原理-FDM.drawio.svg" width="400"/> 

#### TDM 时分多路复用

- 时分多路复用：将一条物理信道按时间分成若干时间片，轮流地分配给多个信号使用，每个时间片由复用的一个信号占用。
- TDM适用于传输数字信号，抗干扰能力强、可以逐级再生整形、避免干扰的累积、且数字信号较易实现自动转换。

<img src="../../pictures/计算机组成原理-TDM.drawio.svg" width="400"/> 

##### STDM 统计时分多路复用

- STDM（统计时分多路复用、异步时分多路复用）：对TDM的一种改进，采用STDM帧，STDM帧并不固定分配时隙，而是按需动态地分配时隙，终端有数据需要传输时，才会分配到时间片。

#### WDM 波分多路复用

- 波分多路复用（光的频分多路复用）：在一根光纤中传输多种不同波长（频率）的光信号，由于波长不同，各路光信号互不干扰，最后再用波长分解复用器将各路波长分解出来。且光波处于频谱的高频段，有很高的带宽。

#### CDMA 码分多址

- CDM（码分多路复用）：采用不同的编码来区分各路原始信号，既共享信道的频率，又共享时间。
- CDMA（码分多址，Code Division Multiple Access）：每个比特时间再划分成m（m的值通常为64或128）个短的时间槽（码片，Chip）。每个站点被指派一个唯一的m位码片序列。发送1时，站点发送它的码片序列；发送0时，站点发送该码片序列的反码。两个及以上的站点同时发送时，各数据在信道中线性相加。为从信道中分离各路信号，要求各个站点的码片序列相互正交。

- 令向量S表示A站的码片向量、向量T表示B站的码片向量：

1. 两个不同站的码片序列正交：S和T的规格化内积（Inner Product）为0。

<img src="../../pictures/20231129000304.png" width="200"/> 

2. 任何一个码片向量和该码片向量自身的规格化内积都是1，任何一个码片向量和该码片向量反码的规格化内积都是-1。

<img src="../../pictures/20231129000528.png" width="450"/> 

- 按惯例将码片中的0写作-1，1写作+1。

1. 令向量S(-1 -1 -1 +1 +1 -1 +1 +1)表示A站的码片向量、向量T(-1 -1 +1 -1 +1 +1 +1 -1)表示B站的码片向量
2. 当A站向C站发送数据1时，就发送了向量S(-1 -1 -1 +1 +1 -1 +1 +1)，即0001 1011；当B站向C站发送数据时，就发送了向量T(+1 +1 -1 +1 -1 -1 -1 +1)。两个向量到了公共信道后就进行叠加（线性相加），得到S+T = (0 0 -2 2 0 -2 0 2)。
3. 到达C站后，进行数据分离，若要得到A站的数据，C站必须知道A站的码片序列，让S与S+T进行规格化内积。根据叠加原理，其他站点的信号都在内积的结果中被过滤掉（内积的相关项为0），只剩下A站的信号，得到S(S+T) = 1，即A站发送的数据是1。若要得到B站的数据，同理得到T(S+T) = -1，即B站发送的信号向量是反码向量（0）。

- 码分多路复用技术的频谱利用率高、抗干扰能力强、保密性强、语音质量好，可以降低投资和运行成本，主要用于无线通信系统、移动通信系统。

### 随机访问介质访问控制

- 随机访问协议不采用集中控制方式解决发送信息的次序问题，所有用户根据自己的意愿随机地发送信息，占用信道全部速率。而在总线型网络中，两个及以上的用户同时发送信息时，会产生帧的冲突（碰撞），导致所有用户的发送均失败。
- 随机访问介质访问控制协议（争用型协议）：为了解决碰撞问题，每个用户需要按照一定的规则反复地重传它的帧，直到该帧无碰撞地通过。

#### ALOHA协议

- ALOHA（随机接入系统，Additive Link On-line Hawaii system），分为纯ALOHA、时隙ALOHA。

##### 纯ALOHA

- 纯ALOHA：网络中的任何一个站点需要发送数据时，可以不进行任何检测就发送数据。若在一段时间内未收到确认，则该站点就认为传输过程中发送了冲突，让发生碰撞的站等待一段随机的时间，然后再进行重传。若再次发生碰撞，则需要再次等待一段随机地时间，直到发送成功。
- 假定纯ALOHA的网络负载（T<sub>0</sub>时间内所有站发送成功和未成功而重传的帧数）为G，则纯ALOHA网络的吞吐量（T<sub>0</sub>时间内成功发送的平均帧数）为S = Ge<sup>-2G</sup>。G=0.5时，S=0.5e<sup>-1</sup>&asymp;0.184，吞吐量达到可能的极大值，可见纯ALOHA网络的吞吐量很低。

##### 时隙ALOHA

- 时隙ALOHA：把所有站在时间上同步起来，并将时间划分为一段段等长的时隙（Slot），规定只能在每个时隙开始时发送帧，避免用户发送数据的随意性，减少了数据产生冲突的可能，提高了信道利用率。
- 时隙T<sub>0</sub>使得每个帧正好在一个时隙内发送完毕。每个帧在到达后，一般要在缓存中等待一段小于T<sub>0</sub>的时间，然后才能发送。若一个时隙内有两个及以上的帧到达，则在下一个时隙将发生碰撞。

- 时隙ALOHA网络的吞吐量 S = Ge<sup>-G</sup>，G=1时，S=e<sup>-1</sup>&asymp;0.368，吞吐量达到可能的极大值。

#### CSMA 载波监听多路访问协议

- CSMA（载波监听多路访问协议，Carrier Sense Multiple Access）：每个站点在发送之前都先监听一下共用信道，根据信道状态决定动作。

| 信道状态 | 1-persistent CSMA | Non-persistent CSMA                | p-persistent CSMA                        |
| -------- | ----------------- | ---------------------------------- | ---------------------------------------- |
| 空闲     | 立即发送数据      | 立即发送数据                       | 以概率p发送数据，概率p-1推迟到下一个时隙 |
| 忙       | 继续坚持监听      | 放弃监听，等待一段随机时间后再监听 | 持续监听，直到信道空闲                   |

##### 1-persistent CSMA

- 1-坚持 CSMA：一个结点要发送数据时，首先监听信道；若信道空闲，则立即发送数据（发送的概率为1）；若信道忙，则等待，并继续监听直到信道空闲（persistent，坚持监听）；若发送冲突，则随机等待一段时间后，再重新开始监听信道。
- 多个结点等待信道空闲后同时发送数据会发生冲突。

##### Non-persistent CSMA

- 非坚持 CSMA：一个结点要发送数据时，首先监听信道；若信道空闲，则立即发送数据；若信道忙，则放弃监听（Non-persistent），等待一个随机时间后再重复上述过程。
- 降低了多个结点等待信道空闲后同时发送数据导致冲突的概率，但代价是增加数据在网络中的平均延迟。即信道利用率的提升是以增加数据在网络中的延迟时间为代价的。

##### p-persistent CSMA

- p-坚持 CSMA：用于时分信道，一个结点要发送数据时，首先监听信道；若信道忙，则持续监听（persistent），直到信道空闲；若信道空闲，则以概率p发送数据，以概率1-p推迟到下一个时隙（发送的概率为p）。若推迟到下一个时隙且信道空闲，则仍然以概率p发送数据，以概率1-p推迟到下一个时隙；若推迟到下一个时隙且信道忙，则等待下一个时隙再重新开始监听。
- 以概率p发送的方式降低了多个结点等待信道空闲后同时发送数据导致冲突的概率，而持续监听是为了克服Non-persistent CSMA中由于随机等待而造成的延迟时间较长的缺点。

#### CSMA/CD 载波监听多路访问/碰撞检测协议

- CSMA/CD是对CSMA的改进，适用于总线形网络或半双工网络，采用CSMA/CD协议的以太网只能进行半双工通信；全双工网络采用两条信道分别用于发送和接收，收发双方在任何时间都可以发送或接收数据，不可能产生冲突，不需要CSMA/CD协议。

1. 载波监听：每个站点在发送前和发送中都必须不停地检测信道，在发送前检测信道是为了获得发送权（只有信道空闲才能发送），在发送中检测信道是为了及时发现发送的数据是否发送了碰撞。
2. CD （碰撞检测，Collision Detecion)：边发送边监听，若监听到碰撞，则立即停止数据发生，等待一段随机时间后，重新开始尝试发送数据。

- 电磁波在总线上的传播速率总是有限的，即使某个时刻检测到信道空闲时，此时的信道也不一定是空闲的。

- 假定&tau;为单程传播时延：

| 时刻                  | 事件                                                         |
| --------------------- | ------------------------------------------------------------ |
| t = 0                 | A发送数据                                                    |
| t = &tau; - &delta;   | A发送的数据还未到达B，此时，B检测信道空闲而发送数据          |
| t = &tau; - &delta;/2 | A发送的数据和B发送的数据发生碰撞，此时，A和B均不知道发生了碰撞 |
| t = &tau;             | B检测到碰撞，停止发送数据                                    |
| t = 2&tau; - &delta;  | A检测到碰撞，停止发送数据                                    |

<img src="../../pictures/计算机网络-CSMA-CD碰撞检测.drawio.svg" width="1000"/>

- 争用期（冲突窗口、碰撞窗口）：以太网的信号的最远端到端（<span name="冲突域">冲突域</span>）往返传播时延2&tau;。站点A在发送帧之后至多经过时间2&tau;（&delta;&rarr;0）就能指定所发送的帧是否发生碰撞。每个站在自己发送数据之后的一小段时间内，存在发送碰撞的可能性，只有经过争用期这段时间还未检测到碰撞时，才能确定这次发送不会发送碰撞。
- 最短帧长：以太网规定一个最短帧长（64B），即争用期内可发送的数据长度，若小于该长度，则在MAC子层于数据字段的后面加入一个整数字节的填充字段。如果在争用期内检测到碰撞，站点就s会停止发送，此时已经发送出去的数据一定小于最短帧长。因此，只要是长度小于最短帧长的帧都是由于冲突而异常中止的无效帧，可以通知接收到该帧的站点发生了碰撞，同时丢弃该无效帧。

最短帧长 =  2 x 总线传播时延 x 数据传输速率

- 动态退避（截断二进制指数退避算法）：发生碰撞后的策略，重传需要推迟的平均时间随重传次数的增大而增大，降低发送碰撞的概率

1. 确定基本退避时间，一般取争用期2&tau;
2. 定义参数 k = min\[重传次数, 10\]，重传次数不超过10时，k=重传次数；重传次数超过10次时，k不再增大而是一直等于10
3. 从离散的整数集合\[0, 1, ..., 2<sup>k</sup>\-1]中随机取出一个数r来确定重传所需的退避时间：2r&tau;，即k值越大，发生冲突的概率越低。
4. 重传16次仍不能成功时，认为该帧永远无法正确发出，抛弃该帧并向高层汇报错误

<details>
    <summary>
        如图，在Hub再生比特流的过程中会产生1.535us延时（Switch和Hub均为100Base-T设备），信号传播速率为200m/us，不考虑以太网帧的前导码，则H3和H4之间理论上可以相距的最远距离是_____。<br/>
        <img src="../../pictures/计算机网络-HubAndCSMACD.drawio.svg" width="500"/>
    </summary>
    100Base-T代表100Mbps的基带传输的以太网，而以太网的最短帧长规定为64B；且Hub没有分割冲突域，并且计算总线传播时延时还要加上其再生操作所耗费的时间<br/>
    最短帧长 = 2 x 总线传播时延 x 数据传输速率，故 64B = 2*(L / 200m/us + 1.535us)*100Mbit/s，得到L=205m
</details>


#### CSMA/CA 载波监听多路访问/碰撞避免协议

- CSMA/CD协议应用于使用有线连接的局域网；而在无线局域网环境下，应该采用CSMA/CA协议。无线局域网不采用CSMA/CD的原因如下：

1. 接收信号的强度往往会远小于发送信号的强度，且在无线介质上信号强度的动态变化范围很大，若要使用碰撞检测，则硬件上的花费过大。
2. 隐蔽站问题：在无线通信中，并非所有的站点都能听见对方。

- CSMA/CA协议对CSMA/CD协议进行改进，将碰撞检测改为CA（碰撞避免，Collision Avoidance）：并不是指协议可以完全避免碰撞，而是指协议的设计要尽量降低碰撞发生的概率。802.11 无线局域网不使用碰撞检测，故一旦站点开始发送一个帧，就会完全发送该帧，如果碰撞发生，会严重减低网络的效率（尤其是长数据帧）。
- 由于无线信道的通信质量远不如有线信道，802.11使用ARQ方案（链路层确认/重传）。


| 区别     | CSMA/CD                                            | CAMA/CA                                                      |
| -------- | -------------------------------------------------- | ------------------------------------------------------------ |
| 基本思想 | 发送前监听、边发送边监听、一旦发生碰撞立即停止发送 | 发送数据时先广播告知其他结点                                 |
| 碰撞检测 | 检测冲突，却无法避免                               | 发送数据的同时不能检测信道上是否有无冲突<br />本结点处没有冲突，不代表接收结点处没有冲突<br />只能尽量避免冲突 |
| 传输介质 | 总线形以太网                                       | 无线局域网 802.11a/b/g/n等                                   |
| 检测方式 | 通过电缆中的电压变化来检测                         | 采用能量检测、载波检测、能量载波混合检测三种方式检测信道空闲 |

- IFS（帧间间隔，InterFrame Space）：为了尽量避免碰撞，802.11规定，所有的站在完成发送之后，必须等待一段很短的时间（IFS）才能发送下一帧，该时间仍然继续监听。IFS的长度取决于该站要发送的帧的类型：

| IFS类型               | 说明                                                         |
| --------------------- | ------------------------------------------------------------ |
| SIFS（短IFS）         | 最短的IFS，用来分割属于一次对话的各帧<br />使用SIFS的帧类型包括ACK帧、CTS帧、分片后的数据帧、所有回答AP探询的帧等 |
| PIFS（点协调IFS）     | 中等长度的IFS，在PCF操作中使用                               |
| DIFS（分布式协调IFS） | 最长的IFS，用于异步帧竞争访问的时延                          |

- CSMA/CA的退避算法：信道从忙态变为空闲态时，任何一个站要发送数据帧，不仅都要等待一个时间间隔，而且要进入争用窗口，计算随机退避时间以便再次试图接入信道，降低了碰撞发生的概率。当且仅当检测到信道空闲且该数据帧是要发送的第一个帧时，才不使用退避算法，其他情况必须使用退避算法。

1. 若站点最初有数据要发送（不是重传），且检测到信道空闲，在等待时间DIFS后，就会发送整个数据帧。
2. 否则，站点执行CSMA/CA退避算法，选取一个随机回退值。一旦检测到信道忙，退避计时器就保存不变；只要信道空闲，退避计时器就进行倒计时。
3. 退避计时器减到0时（此时信道必定空闲），站点就发送整个帧并等待确认。
4. 若发送站收到确认，就知道已发送的帧被目的站正确接收。此时，若要发送第二帧，就回到步骤2。
5. 若发送站没有收到确认帧ACK（重传计时器超时），就必须重传该帧，再次使用CSMA/CA协议争用该信道（步骤2），直到收到确认；或经过若干次重传失败后放弃发送。

##### RTS和CTS 处理隐蔽站问题

- 隐蔽站问题：A和B都在AP的覆盖范围内，但A和B相距较远，彼此都听不见对方。若A和B检测到信道空闲时，都向AP发送数据，则导致碰撞发生。

<img src="../../pictures/计算机网络-AP隐蔽站问题.drawio.svg" width="320"/> 

- 802.11 允许发送站对信道进行预约，以避免隐蔽站问题：

1. A站点要发送数据之前先广播一个很短的RTS（请求发送，Request To Send）控制帧，包括源地址、目的地址、这次通信所持续的时间（包含相应的确认帧），该帧可以被其范围内包括AP在内的所有站点听到。
2. 若信道空闲，则AP广播一个CTS（允许发送，Clear To Send）控制帧，包括这次通信所需的持续时间（从RTS帧复制），该帧可以被其范围内包括A和B在内的所有站点听到。
3. A站点听到CTS后，等待一个SIFS之后发送数据；B和其他站点听到CTS后，在CTS帧中指明的时间内将抑制发送。

 <img src="../../pictures/计算机网络-RTS和CTS.drawio.svg" width="600"/> 

- 信道预约不是强制规定的，各站可以自己决定是否使用。虽然使用RTS和CTS会使网络的通信效率下降，但这两种控制帧很短，与数据帧相比开销小。若不采用这两种控制帧，一旦发生碰撞而导致数据帧重发，则浪费的时间更多。只有当数据帧长度超过某一数值时，使用RTS和CTS才比较有利。

### 轮询访问 令牌传递协议

- 轮询访问：用户不能随机地发送信息，而要通过一个集中控制的监控站，以循环发生轮询每个结点，再决定信道的分配。某个结点使用信道时，其他结点都不能使用信道。令牌传递协议是典型的轮询访问介质访问控制协议，主要用于令牌环局域网。
- 令牌传递协议：一个令牌（Token）沿着环形总线在各结点计算机间依次传递，令牌在设备间的传递通路逻辑上必须是一个环。
- 令牌（Token）：一个特殊的MAC控制帧，本身不包含信息，仅控制信道的使用。站点只有取得令牌后才能发送数据帧，确保同一时刻只有一个站点独占信道，因此不会发生冲突。令牌在网环上是按顺序传递的，对所有入网计算机而言，访问权是公平的。每个结点都可以在一定的时间内（令牌持有时间）获得发送数据的权力，而不是无限制地持有令牌。环上的一个站点希望传送帧时，必须等待令牌；一旦收到令牌，站点便可启动发送帧，帧中包含目的站点地址，以标识哪个站点应接收此帧。

1. 网络空闲时，环路中只有令牌帧在循环传递。即没有计算机需要发送数据时，令牌就在环形网上游荡。
2. 令牌传递到有数据要发送的站点时，该站点就修改令牌中的一个标志位，并在令牌中附加自己想要传输的数据，将令牌变成一个数据帧，并发出该数据帧。
3. 数据帧沿着环路传输，接收到的站点一边转发数据，一般查看帧的目的地址。若目的地址和自己的地址相同，则接收站就复制该数据帧以便进一步处理。
4. 数据帧沿着环路传输，直到到达该帧的源站点，源站点收到自己发出的帧后就不再转发。同时，通过检验返回的帧来查看数据传输过程中是否出错，若有错则重传。
5. 源站点发送完数据后，重新产生一个令牌并传递给下一站点，以交出信道控制权。

- 轮询介质访问控制非常适合负载很高的广播信道，限定了有权力发送数据的结点只能有一个。
