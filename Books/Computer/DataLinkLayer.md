# 数据链路层的功能

- 数据链路层（Data Link Layer）将物理层提供的可能出错的物理连接改造为逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路。

## 为网络层提供服务

### 无确认的无连接服务

1. 源机器发送数据帧时不需要先建立链路连接
2. 目的机器收到数据帧时不需要返回确认
3. 对丢失的帧，数据链路层不负责重发而是交给上层处理

- 适用于实时通信或误码率较低的通信信道，如以太网。

### 有确认的无连接服务

1. 源机器发送数据帧时不需要先建立链路连接
2. 目的机器收到数据帧时必须返回确认，源机器在规定时间内未收到确定信号时，就重传丢失的帧。
3. 适用于误码率较高的通信信道，如无线通信。

### 有确认的面向连接服务

1. 链路管理：帧传输过程分为建立数据链路、传输帧、释放数据链路三个阶段。
2. 目的机器对收到的每一帧都要给出确认，源机器收到确认后才能发送下一帧，最可靠。
3. 适用于通信要求（可靠性、实时性）较高的场合。

## 帧

### 组帧

- 两台主机之间传输信息时，为了使接收方能够正确地接收并检查所传输的帧，发送方必须按照一定的规则将网络层递交的分组封装成帧（组帧），以帧的格式进行传送。
- 组帧要添加首部和尾部：在网络中信息是以帧为最小单位进行传输的，接受端要正确地接收帧，就必须要确认该帧在一串比特流中的开始和结束位置（帧定界）。

#### 字符计数法

- 字符计数法在帧头部使用一个计数字段来表明帧内字符数。若计数字段出错，就失去了帧边界划分的依据，则接收方无法判断所传输帧的结束位和下一帧的开始位，收发双方将失去同步。

#### 字符填充的首尾定界符法

- 字符填充法使用特定字符来定界一帧的开始和结束。

1. 控制字符SOH：放在帧的最前面，表示帧的首部开始
2. 控制字符EOT：表示帧的结束
3. 转义字符ESC：发送方在信息位中出现的特殊字符（SOH、EOT、ESC）前面填充ESC来区分，以实现透明传输。接受方在接受到数据后，会自己删除这些插入的ESC字符，得到原来的数据。

<img src="../../pictures/计算机网络-字符填充法.drawio.svg" width="650"/> 

#### 零比特填充的首尾标志法

- 零比特填充法允许数据帧包含任意个数的比特，允许每个字符的编码包含任意个数的比特，使用特定的比特模式（01111110）来标志一帧的开始和结束。发送方的数据链路层在信息位中遇到5个连续的“1“时，自动在后面加入一个“0”；而接受方每受到5个连续的“1”，自动删除后面紧跟着的“0”，以恢复原信息。
- 零比特法容易使用硬件实现、性能优于字符填充法。

#### 违规编码法

- 在物理层进行比特编码时，通常采用违规编码法。局域网IEEE 802标准就利用违规编码来定界帧的起始和终止。
- 违规编码法不需要任何填充技术，便能实现数据传输的透明性，但只适合于采用冗余编码的特殊编码环境。

> 违规编码（没有采用的编码）：曼彻斯特编码方法将数据比特“1”编码为“高-低“电平对，“0”编码为“低-高”电平对，而“高-高”电平对和“低-低”电平对没有被采用，在数据比特中是违规的，即违规编码。

### 帧定界、帧同步、透明传输

- 帧定界：帧的首部和尾部中含有大量的控制信息，可以用于确定帧的界限。
- 帧同步：接收方应能从接收到的二进制比特流中区分区帧的起始和终止（HDLC协议中的帧标志位F）。

<img src="../../pictures/计算机网络-HDLC标准帧格式.drawio.svg" width="400"/> 

- 透明传输：不管所传数据是什么样的比特组合，都应当能在链路上传送。
- MTU（最大传送单元）：每种数据链路层协议都规定了帧的数据部分的长度上限。

## 差错控制

- 差错控制是用于使发送方确认接收方正确接收到其发送的数据的方法。

1. 位错（比特差错）：帧中的某些位出现错误。通常采用CRC（循环冗余校验）来发现位错，通过ARQ来重传出错的帧。
2. 帧错：帧的丢失、重复、失序等错误。在数据链路层引入定时器和编号机制，保证每一帧最终都能有且仅有一次正确地交付给目的结点。

- 对于位错，利用编码技术进行差错控制，分为检错编码和纠错编码。

1. ARQ（自动重传请求，Automatic Repeat reQuest）让发送方将要发送的数据帧附加一定的CRC冗余检错码一并发送，接受方根据检错码对数据帧进行错误校验，若发现错误则丢弃，发送方超时重传该数据帧，直到接收到正确的码字为止。ARQ只需要返回很少的控制信息就可有效地确认所发数据帧是否被正确接收。
2. FEC（前向纠错）的接受方不仅能发现差错，还能确定比特串的错误位置，从而加以纠正。

### 检错编码

- 检错编码都采用冗余编码技术，在有效数据（信息位）被发送前，先按某种关系附加一定的冗余位，构成一个符合某一规则的码字后再发送。当要发送的有效数据变化时，相应的冗余位也随之变化，使得码字遵从不变的规则。接收端根据收到的码字是否仍然符合原规则来判断是否出错。

#### 奇偶校验码

- 奇偶校验码包括奇校验码和偶校验码，是最基本的检错码，只能检测奇数位的出错情况，并不清楚哪些位出错，也不能发现偶数位的出错情况。
- 奇偶校验码由n-1位信息元和1位校验元组成。

1. 若为奇校验码，则在附加一个校验元后，码长为n的码字中“1”的个数为奇数
2. 若为偶校验码，则在附加一个校验元后，码长为n的码字中“1”的个数为偶数

#### 循环冗余码 CRC

- CRC（循环冗余码、多项式码，Cyclic Redundancy Code），任何一个由二进制数位串组成的代码都可以与一个只含有0和1两个系数的多项式建立一一对应的关系。一个k位帧可以视为从X<sup>k-1</sup>到X<sup>0</sup>的k次多项式的系数序列。
- FCS（帧检验序列）给定一个m bit的帧或报文，发送器生成一个r bit的序列（冗余码），形成的帧由m+r bit组成。发送方和接收方事先商定一个多项式G(x)（最高位和最低位必须为1），使这个带检验码的帧正好能够被G(X)整除，接受方用同样的G(x)来除收到的帧，若果没有余数，则认为无差错。假定该m bit的帧对应的多项式为M(x)，则计算冗余码的步骤如下：

1. 加0：假设G(x)的阶为r，则在帧的低位端加上r个0。
2. 模2除法：利用模2除法，用G(x)对应的数据串区除步骤1中得到的数据串，得到的余数为冗余码（共r位，前面的0不可省略）。

- 通过CRC的检错技术，数据链路层实现了对帧的无差错接收，认为只要是数据链路层接受的帧（而不仅仅是接收），在传输过程中都没有产生差错。

> CRC具有纠错功能，而数据链路层仅使用了其检错功能。

### 纠错编码

- 在每个要发送的数据块上附加足够的冗余信息，使接收方能够推导出发送方实际送出的应该是什么样的比特串。

#### 汉明码

- 在有效信息位中加入几个校验位形成汉明码，并把汉明码的每个二进制位分配到几个奇偶校验组中。当某一位出错后，就会引起有关的几个校验位的值发生变化，不但可以发现错位，还能指出错位的位置，为自动纠错提供依据。



## 流量控制

- 流量控制实际上是控制发送方的数据流量，使其发送速率不超过接收方的接收能力。对于数据链路层，控制的是点到点的数据链路上的流量；对于传输层，控制的是端到端之间的流量。

- OSI体系结构中，数据链路层具有流量控制的功能；而TCP/IP体系结构中，流量控制的功能被移到了传输层。