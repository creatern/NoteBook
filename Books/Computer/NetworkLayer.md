# 网络层的功能

- 网络层：向上只提供简单灵活的、无连接的、尽最大努力的数据报服务。

## 异构网络互连

- TCP/IP体系在网络层采用标准化协议，但相互连接的网络可以是异构的（网络层及数据链路层协议不同），即网络层必须使用相同的IP协议（虚拟互连网络、IP网络）。

## 路由与转发

- 路由表根据路由选择算法给出，转发表根据路由表给出。

1. 路由选择（路由表）：按照路由选择算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变选择的路由。
2. 分组转发（转发表）：路由器根据转发表将用户的IP数据报从合适的端口转发出去。

## SDN

- 网络层可以被抽象地分为数据平面（转发层面）和控制平面；数据平面实现转发，控制平面实现路由选择。
- 传统互联网：每个路由器既有转发表（数据平面）又有路由选择软件（控制平面）
- SDN（软件定义网络）：集中式的控制平面和分布式的数据平面，两个平面相互分离。控制平面通过控制-数据接口对数据平面上的路由器进行集中式控制，方便软件来控制网络，适用于一些大型数据中心之间的广域网。

<img src="../../pictures/Layered-view-of-SDN-Architecture.png" width="420"/> 

- 远程控制器掌握各主机和整个网络的状态，为每个分组计算出最佳路由，通过Openflow协议（或其他途径）将流表（转发表）下发给路由器。
- SDN的可编程性：

1. 北向接口：SDN提供的编程接口，开发者可在此基础上设计自己的应用，而不必关心底层的硬件细节。
2. 南向接口：SDN控制器和转发器设备建立双向会话的接口，SDN控制器通过不同的南向接口协议（Openflow）来兼容不同的硬件设备，并实现上层应用的逻辑。
3. 东西向接口：SDN控制器集群内部控制器之间的通信接口，用于增强整个控制平面的可靠性和可拓展性。

- SDN的优点：

1. 全局集中式控制和分布式高速转发，既利于控制平面的全局优化，又利于高性能的网络转发。
2. 灵活可编程与性能的平衡，控制和转发功能分离后，使得网络可以由专有的自动化工具以编程方式配置。
3. 降低成本，控制和数据平面分离后，尤其是在使用开放的接口协议后，就实现了网络设备的制造与功能软件的开发相分离，从而有效降低了成本。

- SDN的问题：

1. 安全风险，集中管理容易受攻击，如果崩溃，整个网络会受到影响。
2. 瓶颈问题，原本分布式的控制平面集中化后，随着网络规模扩大，控制器可能成为网络性能的瓶颈。

## 拥塞控制

- 拥塞：通信子网中，因出现过量的分组而引起网络性能下降的现象。
- 拥塞判断，即观察网络的吞吐量和网络负载之间的关系：

- 拥塞控制：确保子网能够承载所达到的流量，是全局性的。

| 拥塞控制 | 方法                                                         |
| -------- | ------------------------------------------------------------ |
| 开环控制 | 设计网络时事先考虑发生拥塞的因素，做决定时不考虑当前网络的状态 |
| 闭环控制 | 基于反馈环路，监测网络系统，及时检测拥塞的发生               |

# 路由算法

| 路由算法                         | 说明                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| 静态路由算法（非自适应路由算法） | 网络管理员手动配置和修改路由信息，不能及时适应网络状态的变化，用于简单的小型网络 |
| 动态路由算法（自适应路由算法）   | 路由器上的路由表项由相互连接的路由器之间彼此交换信息，根据一定的算法优化而来，不断更新 |

- 动态路由算法对动态反应过快而引起振荡，反应过慢而影响网络的一致性。
- 动态路由算法分为距离-向量算法和链路状态路由算法。

## 距离-向量算法 RIP

- 距离-向量算法：迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短路径。所有结点定期地将其整个路由选择表传送给与之相邻的所有结点，路由表中包含每条路径的目的地（另一结点）、路径的代价（距离）。
- 距离：不同的算法对距离的定义不同。RIP将距离定义为跳数，即从源端口到达目的端口所经过的路由个数，每经过一个路由器，跳数加1。
- 所有结点都必须监听从其他结点出来的路由选择更新信息（参与距离向量交换），并在下列情况下更新它们的路由选择表，且每次更新时都要将其全部路由表发送给所有相邻结点，以保证路由的一致性和有效性：

1. 被通告一条新的路由，此时，本地系统加入这条新的路由
2. 发来的路由信息中有某条到达某个目的地的路由比当前使用的路由的代价更小，此时，替换该路由

## 链路状态路由算法 OSPF

- 链路状态路由算法要求每个参与该算法的结点都具有完全的网络拓扑信息，它们执行下述两项任务：

1. 主动测试所有邻接结点的状态。两个共享一条链接的结点是相邻结点，即连接到同一条链路，或者连接到同一广播型物理网络。
2. 定期地将链路状态传播给所有其他结点（路由结点）。

- 典型的链路状态算法是OSPF算法：在一个链路状态路由选择中，一个结点检查所有直接链路的状态，并将所得的状态信息发送给网上的所有其他结点，每个结点都用这种方式从网上所有其他的结点接收包含直接链路状态的路由选择信息。每当链路状态报文到达时，路由结点便使用这些状态信息去更新自己的网络拓扑和状态“视野图”，一旦链路状态发生变化，结点就对更新的网络图利用Dikstra最短路径算法重新计算路由，从单一的源出发计算到达所有目的结点的最短路径。

- 链路状态路由算法主要有三个特征：

1. 洪泛法向本自治系统中所有路由器发送信息，即路由器通过所有端口向所有相邻的路由器发送信息（广播），而每个相邻路由器又将此信息发往其所有相邻路由器（但不再发送给刚刚发来信息的那个路由器）。
2. 发送的信息是与路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。

> 所谓“链路状态”，是指说明本路由器与哪些路由器相邻及该链路的“度量”。对于OSPF 算法，链路状态的“度量”主要用来表示费用、距离、时延、带宽等。

3. 只有当链路状态发生变化时，路由器才向所有路由器发送此信息。

- 由于一个路由器的链路状态只涉及相邻路由器的连通状态，而与整个互联网的规模并无直接关系，因此链路状态路由算法可以用于大型的或路由信息变化聚敛的互联网环境。
- 链路状态路由算法的主要优点是：

1. 每个路由结点都使用同样的原始状态数据独立地计算路径，而不依赖中间结点的计算
2. 链路状态报文不加改变地传播，因此采用该算法易于查找故障。当一个结点从所有其他结点接收到报文时，它可以在本地立即计算正确的通路，保证一步汇聚。
3. 最后，由于链路状态报文仅运载来自单个结点关于直接链路的信息，其大小与网络中的路由结点数目无关，因此链路状态算法比距离-向量算法有更好的规模可伸展性。

## 层次路由

- 因特网将整个互联网分为许多较小的自治系统，每个自治系统自主决定内部采用的路由选择协议，而两个自治系统通信时需要屏蔽这些差异。

| 路由选择协议分类                  | 具体协议  |
| --------------------------------- | --------- |
| IGP（内部网关协议、域内路由选择） | ROP、OSPF |
| EGP（外部网关协议、域间路由选择） | BGP       |

- 使用层次路由时，OSPF将一个自治系统再划分为若干区域（Area），每个路由器都知道在本区域内如何将分组路由到目的地的细节，而不用知道其他区域的内部结构。

# IPv4

- IP协议定义数据传送的基本单元（IP分组）及其确切的数据格式，一套规则指明分组如何处理、错误如何控制，非可靠传递的思想、分组路由选择思想。

## IPv4分组

### IPv4首部

- 一个IPv4分组由首部和数据部分组成。首部前一部分的长度固定，共20B，是所有IP分组必须具有的；首部固定部分后面是一些可选字段，长度可变，用来提供错误检测及安全等机制。

<img src="../../pictures/计算机网络-IPv4首部.drawio.svg" width="600"/> 

| 字段                                  | 位   | 含义                                                         |
| ------------------------------------- | ---- | ------------------------------------------------------------ |
| 版本                                  | 4    | IP协议的版本（IPv4的版本号为4）                              |
| 首部长度                              | 4    | 以32位为单位，最大值为60B（15\*4B），最常用的首部长度为20B（不使用可选字段时） |
| 总长度                                | 16   | 以字节为单位，首部和数据之和的长度，IP数据报的最大长度为2<sup>16</sup>-1B，但受到数据链路层MTU的限制，超过就需要分片 |
| <span name="IPv4标识">标识</span>     | 16   | 标识号（计数器），每产生一个数据报就加1并赋值给标识字段（不是序号）。<br />分片后，每个数据报片的标识都与原分组的标识字段值相同 |
| <span name="IPv4标志">标志</span>     | 3    | 标志字段的最低位为MF（More Fragment）：MF=1表示后面还有分片；MF=0表示最后一个分片<br />标志中段的中间位为DF（Don't Fragment）：只有DF=0时才允许分片 |
| <span name="IPv4片偏移">片偏移</span> | 13   | 指出较长的分组分片之后，某片在原分组的相对位置。<br />以8B为偏移单位，除了最后一个分片外，每个分片的长度必定是8B的整数倍 |
| TTL                                   | 8    | 生存时间，数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命。<br />路由器在转发分组前，先把TTL减1，若TTL被减为0，则丢弃该分组 |
| 协议                                  | 8    | 指出该分组携带的数据使用何种协议，即分组的数据部分应交付给哪个协议处理<br />值6表示TCP；值17表示UDP |
| 首部检验和                            | 16   | 首部检验和只检验分组的首部，而不检验数据部分                 |
| 源地址字段                            | 32   | 标识发送方的IP地址                                           |
| 目的地址字段                          | 32   | 标识接收方的IP地址                                           |

### IP数据报分片

- MTU（最大传送单元）：一个数据链路层的帧所能承载的最大数据量，以太网帧的MTU为1500B。IP数据报封装在数据链路层的帧中，故MTU严格限制IP数据报的长度，且IP数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的MTU。
- 分片：IP数据报的总长度大于链路的MTU时，需要将IP数据报中的数据分装在多个较小的IP数据报（片）中。片在目的主机的网络层被重新组装，目的主机使用IP首部的[标识](#IPv4标识)、[标志](IPv4标志)和[片偏移](#IPv4片偏移)字段来完成对片的重组。

## IPv4地址与NAT

### IPv4地址

- IP地址：32bit的全球唯一标识符，连接到因特网上的每台主机（或路由器）都至少分配一个IP地址。IP地址由互联网名字和数字地址分配机构ICANN进行分配。
- 一个IP地址在整个因特网范围内是唯一的，IP地址:: =\{&lt;网络号&gt;，&lt;主机号&gt;\}。互联网早期采用的是分类的IP地址（ABCDE），而无论哪类IP地址，都由网络号和主机号两部分组成。（现在已经基本不采用分类IP地址）

1. 网络号标志主机（或路由器）所连接到的网络。一个网络号在整个因特网范围内必须是唯一的。
2. 主机号标志该主机（或路由器）。一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。

<img src="../../pictures/20231207220200.png" width="800"/> 

| 特殊的IP地址 | 含义                                                         |
| ------------ | ------------------------------------------------------------ |
| 主机号全为0  | 表示本网络本身                                               |
| 主机号全为1  | 表示本网络的广播地址（直接广播地址）                         |
| 127.x.x.x    | 保留为环回自检（Loopback Test）地址，此地址表示任意主机本身<br />环回地址的IP数据报永远不会出现在任何网络上 |
| 32位全为0    | 0.0.0.0表示本网络上的本主机                                  |
| 32位全为1    | 255.255.255.255表示整个TCP/IP网络的广播地址（受限广播地址）<br />实际使用时，由于路由器对广播域的隔离，255.255.255.255等效为本网络的广播地址 |

1. IP地址由网络号和主机号两部分组成，是一种分等级的地址结构：（1）IP地址管理机构在分配IP地址时只分配网络号，而主机号则由得到该网络号的单位自行分配；（2）路由器仅根据目的主机所连接的网络号来转发分组。
2. IP地址是标志一台主机（或路由器）和一条链路的接口。当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的IP地址，每个IP地址的网络号必须与所在网络的网络号相同，且这两个IP地址的主机号是不同的。因此IP网络上的一个路由器必然至少应具有两个IP地址（路由器每个端口必须至少分配一个IP地址）。
3. 在同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的。（1）转发器或桥接器（网桥等）连接的若干LAN仍然是同一个网络（同一个广播域），因此该LAN中所有主机的IP地址的网络号必须相同，但主机号必须不同；（2）路由器总是具有两个或两个以上的IP地址，路由器的每个端口都有一个不同网络号的IP地址。
4. 在IP地址中，所有分配到网络号的网络（无论是LAN还是WAN）都是平等的。

### NAT 网络地址转换
