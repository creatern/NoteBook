# 日志文件

- Linux日志一般放在/var/log下，需要root用户权限

**日志类型**

| 类型         | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| 系统连接日志 | 记录系统的登录记录和用户名，写录到/var/log/wtmp和/var/log/utmp |
| 进程统计     | 系统内核执行，当一个进程终止时为每个进程往进程统计文件中写一个记录 |
| 错误日志     | 各种系统守护进程、用户程序和内核，通过syslog向/var/log/messages写录 |

**常用日志文件**

| 日志       | 说明                                       | 文件类型   |
| :--------- | :----------------------------------------- | :--------- |
| access-log | 记录Web服务访问日志，错误信息存于error-log |            |
| acct/pacct | 记录用户命令                               |            |
| btmp       | 记录失败的记录                             |            |
| messages   | 服务器的系统日志                           | 文本       |
| sudolog    | 记录使用sudo发出的命令                     |            |
| sulog      | 记录su命令的使用                           |            |
| syslog     | 从syslog中记录信息                         |            |
| secure     | 记录系统登录行为                           | 文本       |
| utmp       | 记录当前登录的每个用户                     | 二进制文件 |
| wtmp       | 一个用户每次登录和退出时间的永久记录       | 二进制文件 |
| lastlog    | 记录最后一次失败的登录和最近几次成功的登录 |            |


<img src="../../../pictures/Snipaste_2022-11-29_15-22-13.png" width="900"/> 

##  查看日志文件

**常用命令**

- 对一般的文本日志文件：cat、tail、head
  - /var/log/messages
- 对二进制日志文件：who、w、users、last、ac、
  - /var/log/wtmp
  - /var/log/utmp

### who 显示目前登录系统的用户信息

<img src="../../../pictures/Snipaste_2022-11-29_15-31-13.png" width="900"/> 

- 参数：/var/log/wtmp

```shell
[root@bogon ~]# who 
root     pts/0        2022-11-29 14:58 (192.168.186.1)
[root@bogon ~]# who /var/log/wtmp
zjk      :0           2022-11-13 21:34 (:0)
zjk      pts/0        2022-11-13 21:34 (:0)
root     :1           2022-11-13 21:34 (:1)
root     pts/0        2022-11-13 21:36 (:1)
root     pts/1        2022-11-13 21:38 (:1)
root     pts/1        2022-11-13 21:42 (192.168.186.1)
root     pts/0        2022-11-27 20:23 (192.168.186.1)
root     pts/1        2022-11-27 20:24 (192.168.186.1)
root     pts/0        2022-11-27 23:21 (192.168.186.1)
root     pts/0        2022-11-27 23:35 (192.168.186.1)
root     pts/0        2022-11-28 19:48 (192.168.186.1)
root     pts/0        2022-11-28 23:18 (192.168.186.1)
root     pts/0        2022-11-29 14:58 (192.168.186.1)
[root@bogon ~]# who /var/log/utmp
[root@bogon ~]# who -q
root
# users=1
[root@bogon ~]# who -H
NAME     LINE         TIME             COMMENT
root     pts/0        2022-11-29 14:58 (192.168.186.1)
```

### w 显示目前登入系统的用户信息

<img src="../../../pictures/Snipaste_2022-11-29_15-34-45.png" width="400"/> 


```shell
[root@bogon ~]# w
 15:35:12 up  3:02,  1 user,  load average: 0.00, 0.01, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     pts/0    192.168.186.1    14:58    8.00s  0.22s  0.05s w
[root@bogon ~]# w /var/log/utmp
 15:35:27 up  3:02,  1 user,  load average: 0.00, 0.01, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
```

### users 显示当前登录系统的所有用户

- 如果一个用户有不止一个登录会话，那他的用户名将显示相同的次数

<img src="../../../pictures/Snipaste_2022-11-29_15-36-53.png" width="300"/> 

```shell
[root@bogon ~]# users
root
```

### last 列出目前与过去登入系统的用户相关信息

- 用于显示用户最近登录信息。单独执行last命令，它会读取/var/log/wtmp的文件，并把该给文件的内容记录的登入系统的用户名单全部显示出来

<img src="../../../pictures/Snipaste_2022-11-29_15-38-09.png" width="400"/> 


```shell
[root@bogon ~]# last -3
root     pts/0        192.168.186.1    Tue Nov 29 14:58   still logged in   
root     pts/0        192.168.186.1    Mon Nov 28 23:18 - 00:18  (00:59)    
root     pts/0        192.168.186.1    Mon Nov 28 19:48 - 21:08  (01:19) 
```

### dmesg 显示Linux系统启动信息

- 被用于检查和控制内核的环形缓冲区。
- 内核会将开机信息存储在ring buffer中。若是开机时来不及查看信息，可利用dmesg来查看。
- 开机信息保存在/var/log/dmesg文件里。

<img src="../../../pictures/Snipaste_2022-11-29_15-42-37.png" width="400"/> 

**常用**

| 组合                   | 说明             |
| :--------------------- | :--------------- |
| dmesg \| grep -i error | 查看系统异常情况 |

# rsyslog日志系统

**配置文件 /etc/rsyslog.conf rsyslog**

<img src="../../../pictures/Snipaste_2022-11-29_19-47-09.png" width="800"/> 

**设备**

<img src="../../../pictures/Snipaste_2022-11-29_19-48-07.png" width="800"/> 

**优先符限定符**

| 限定符 | 说明                                                         |
| :----- | :----------------------------------------------------------- |
| *      | 服务生成的<mark>所有日志消息</mark>都发送到操作动作指定的地点 |
| =      | 服务生成的<mark>本优先级的日志消息</mark>都发送到操作动作指定的地点 |
| !      | 服务生成的所有日志消息都发送到操作动作指定的地点，但本<mark>优先级的消息不包括在内</mark> |

**操作动作**

- 每条消息都会经过所有的规则，并非唯一匹配的。

<img src="../../../pictures/Snipaste_2022-11-29_19-52-55.png" width="800"/> 

```shell
# 编辑/etc/rsyslog.conf

# 把邮件中除info级别外都写入/var/log/maillog文件
mail.*;mail.!=info                          /var/log/maillog

# 仅仅把邮件的通知消息发送给tty12终端设备
main.=info                       /dev/tty12

# 如果root或zjk用户登入，则把紧急消息通知给这些用户
*.alert root,zjk

# 把所有的信息发送给127.0.0.1主机
*.* @127.0.0.1
```

# logrotate 日志轮转

- 用于对系统日志进行轮转、压缩和删除，也可以将日志发送到指定邮箱。
- 每个记录文件都可被设置成每日，每周或每月处理，也能在文件太大时立即处理。
- 必须自行编辑，指定配置文件，预设的配置文件存放在 **/etc/logrotate.conf** 文件中。

<img src="../../../pictures/Snipaste_2022-11-29_20-05-50.png" width="600"/> 

```shell
[root@bogon ~]# vim /etc/logrotate.conf

# see "man logrotate" for details
# rotate log files weekly 每周轮转
weekly

# keep 4 weeks worth of backlogs 保存过去四周的文件
rotate 4

# create new (empty) log files after rotating old ones 轮转以后创建新的空白日志文件
create

# use date as a suffix of the rotated file 轮转的文件以日期结尾
dateext

# uncomment this if you want your log files compressed 如果需要对轮转后的日志压缩，去掉此行注释
#compress

# RPM packages drop log rotation information into this directory 其他配置存放的文件目录;即用户自定义的配置
include /etc/logrotate.d

# no packages own wtmp and btmp -- we'll rotate them here 一些系统日志的轮转规则
/var/log/wtmp {
    monthly
    create 0664 root utmp
        minsize 1M
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}

# system-specific logs may be also be configured here.
```

## 自定义配置轮转

**配置的文件主目录：/etc/logrotate.d**

**logrotate配置文件参数**

<img src="../../../pictures/Snipaste_2022-11-29_20-11-41.png" width="800"/> 

## 测试轮转

```shell
/user/sbin/logrotate -vf /etc/logrotate.conf
```

- 无error日志，则正常生成轮转配置文件。

## 查看每日执行的轮转

```shell
[root@bogon ~]# cat -n /etc/cron.daily/logrotate
     1  #!/bin/sh
     2
     3  /usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf
     4  EXITVALUE=$?
     5  if [ $EXITVALUE != 0 ]; then
     6      /usr/bin/logger -t logrotate "ALERT exited abnormally with [$EXITVALUE]"
     7  fi
     8  exit 0
```
