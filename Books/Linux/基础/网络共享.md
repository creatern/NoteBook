# NFS 网络文件系统

- NFS是一种分布式文件系统，允许网络中不同操作系统的计算机间共享文件，其通信协议基于TCP/IP协议层，可以将远程计算机磁盘挂载（mount）到本地并进行读写。
- NFS在文件传送/信息传送过程中依赖于RPC协议，该协议可以在不同的系统之间使用，此通信协议设计于主机及操作系统无关。

## 配置NFS服务器

### 1.安装rpm

- nfs-utils 基本的NFS命令与脚本
- rpcbind 管理RPC连接

#### nfs 主要文件和进程

| 文件和进程  | 说明                                                         |
| :---------- | :----------------------------------------------------------- |
| nfs.service | NFS服务启停控制单元，位于/usr/lib/systemd/system/nfs.service |
| rpc.nfsd    | NFS守护进程，控制客户端是否可以登录服务器，是nfs-utils的一部分存放在usr/sbin目录，可以结合/etc/hosts.allow和/etc/hosts.deny |
| rpc.mountd  | RPC安装守护进程，管理NFS的文件系统，初始化客户端的mount请求，是nfs-utils的一部分存放在usr/sbin目录 |
| rpc.statd   | 抓取文件锁，是nfs-utils的一部分存放在usr/sbin目录            |
| rpc.rquotad | 对客户文件的磁盘配额限制，是nfs-utils的一部分存放在usr/sbin目录 |
| rpcbind     | 管理RPC连接，对NFS是必需的。因为是NFS的动态端口分配守护进程，如果rpcbind不启动，NFS服务无法启动 |
| exportfs    | 如果修改了**/etc/exports**，则不需要重新激活NFS，只需要重新扫描一遍/etc/exports文件，并重新将设定加载即可 |

##### exportfs 管理NFS共享文件系统列表

<img src="../../../pictures/Snipaste_2022-12-07_17-00-45.png" width="1100"/> 

##### showmount 查询“mountd”守护进程，以显示NFS服务器加载的信息。

<img src="../../../pictures/Snipaste_2022-12-07_17-01-59.png" width="300"/> 

### 2.配置文件/etc/ports

- 在/etc/ports文件中，每一行代表一个共享目录，并且描述了该目录如何被共享。

<img src="../../../pictures/Snipaste_2022-12-07_17-09-36.png" width="800"/> 

```shell
[root@bogon /]# mkdir /root/nfsshare
[root@bogon /]# chmod 777 /root/nfsshare
[root@bogon /]# cat /etc/exports
# <共享目录> [客户端1(选项)] [客户端2(选项)]
/root/nfsshare *(rw,all_squash,sync,anonuid=1001,anongid=1001)
```

### 3.启动服务

```shell
[root@bogon /]# systemctl start rpcbind
[root@bogon /]# systemctl start nfs
[root@bogon /]# systemctl status nfs
```

```shell
# 检查是否正确加载
[root@localhost ~]# showmount -e localhost
Export list for localhost:
/root/nfsshare *
```

### 4. 配置NFS客户端

```shell
[root@mylinuxHost ~]# mkdir /test
[root@mylinuxHost ~]# mount -t nfs -o rw 192.168.186.154:/root/nfsshare /test
[root@mylinuxHost ~]# cd /test
[root@mylinuxHost ~]# ll
```

- 如果mount.nfs: No route to host，则关闭服务器的防火墙和SELinux

[nfs错误合集](https://developer.aliyun.com/article/47560#)

# Samba 文件服务器

- Samba基于Server Message Block协议（SMB信息服务块），SMB是客户机/服务器型协议，是在局域网上共享文件和打印的通信协议，客户通过SMB可访问服务器上的共享文件系统和打印机等资源。

## Samba 服务配置

### 安装

```shell
# 安装依赖
cd /mnt/room/Packages
rpm -aq gcc
rpm -ivh python-devel-2.7.5-58.el7.x86_64.rpm
rpm -ivh gnutls-3.3.26-9.el7.x86_64.rpm
rpm -ivh gnutls-c++-3.3.26-9.el7.x86_64.rpm
rpm -ivh libtasn1-devel-4.10-1.el7.x86_64.rpm
rpm -ivh libtasn1-4.10-1.el7.x86_64.rpm
rpm -ivh zlib-devel-1.2.7-17.el7.x86_64.rpm
rpm -ivh zlib-1.2.7-17.el7.x86_64.rpm
rpm -ivh gmp-devel-6.0.0-15.el7.x86_64.rpm
rpm -ivh nettle-devel-2.7.1-8.el7.x86_64.rpm
rpm -ivh p11-kit-devel-0.23.5-3.el7.x86_64.rpm
rpm -ivh libattr-devel-2.4.46-12.el7.x86_64.rpm
rpm -ivh libacl-devel-2.2.51-12.el7.x86_64.rpm
rpm -ivh cyrus-sasl-devel-2.1.26-21.el7.x86_64.rpm
rpm -ivh openldap-devel-2.4.44-5.el7.x86_64.rpm
rpm -ivh ldns-1.6.16-10.el7.x86_64.rpm
rpm -ivh unbound-libs-1.4.20-34.el7.x86_64.rpm
rpm -ivh unbound-1.4.20-34.el7.x86_64.rpm
rpm -ivh gnutls-dane-3.3.26-9.el7.x86_64.rpm
rpm -ivh gnutls-devel-3.3.26-9.el7.x86_64.rpm
rpm -ivh pytalloc-2.1.9-1.el7.x86_64.rpm
rpm -ivh samba-libs-4.6.2-8.el7.x86_64.rpm
rpm -ivh samba-common-libs-4.6.2-8.el7.x86_64.rpm
rpm -ivh samba-common-tools-4.6.2-8.el7.x86_64.rpm
rpm -ivh samba-4.6.2-8.el7.x86_64.rpm
```

#### 包含的程序

| 程序      | 说明                                                         |
| :-------- | :----------------------------------------------------------- |
| smbd      | SMB服务器，为客户机提供文件和打印服务                        |
| nmbd      | NetBIOS名字服务器，可以提供浏览器支持                        |
| smbclient | SMB客户程序，用于从Linux或其他操作系统上访问SMB服务器上的资源 |
| smbmount  | 挂载SMB文件系统的工具，对应的卸载工具：smbunmount            |
| smbpasswd | 用户增删服务器的用户和密码                                   |

### 配置文件 /etc/samba/samba.conf

**配置文件/etc/samba/samba.conf**

```shell
[root@localhost ~]# vim /etc/samba/smb.conf

[global] 
# 表示全局配置
    # 与主机名相关的设置
    
    workgroup = sambausers  
    # 工作组名称

    netbios name = mySamba   
    # 主机名称，不是hostname，在同一个组中，netbios name必须唯一

    serverstring = this is a test samba server 
    # 说明性文字，内容无关紧要

    # 与登录文件有关的设置
    #log file = /var/log/samba/log.%m   # 日志文件的存储文件名，%m代表的是client端Internet主机名，就是hostname
    #max log size = 50      # 日志文件最大的大小为50Kb

    # 与密码相关的设置
    security = user       
    # share表示不需要密码,user需要用户名和密码，可设置的值为share、user和server

    #passdb backend = tdbsam
    # 打印机加载方式

    load printer = no # 不加载打印机
# 删除[home][printer]
[sambaTest]       
# 共享资源名称
    comment = Temporary file space 
    # 简单的解释，内容无关紧要
    path = /root/sambaTest       
    # 实际的共享目录
    writeable = yes    
    # 设置为可写入
    browseable = yes  
    # 可以被所有用户浏览到资源名称，
    guest ok = yes    
    # 是否允许匿名用户以guest身份登入
```

**配置登入用户**

```shell
# smbpasswd 命令的用法 
smbpasswd -a # 增加用户（要增加的用户必须以是系统用户）   
smbpasswd -d # 冻结用户，就是这个用户不能在登录了   
smbpasswd -e # 恢复用户，解冻用户，让冻结的用户可以在使用   
smbpasswd -n # 把用户的密码设置成空.   
                # 要在global中写入 null passwords -true   
smbpasswd -x # 删除用户  
```

```shell
mkdir /root/sambaTest
groupadd sambausers
useradd -g sambausers sambauser #该用户或组的权限就是登录samba的权限
chown -R sambauser.sambausers /root/sambaTest #没有root用户的权限，无法访问该文件，但是可以看见有这个文件
smbpasswd -a sambauser

#添加一个root用户的smbpasswd
smbpasswd -a root
```

### 启动服务

```shell
/usr/sbin/smbd
/usr/sbin/nmbd
```

#### testparm命令 查看是否无误

```shell
testparm
echo $?
```

**可能需要关闭防火墙**

### Windows使用

- 在Windows打开相关的服务
  <img src="../../../pictures/Snipaste_2022-12-08_19-09-06.png" width="500"/> 
- 在Windows的运行或文件资源管理器，输入`\\192.168.186.155`（Samba对应的IP地址）

# FTP服务器

- FTP服务器中的文件按目录结构进行组织，用户通过网络与服务器建立连接。FTP仅基于TCP的服务，不支持UDP。
- FTP使用两个端口，通常：命令端口(21)，数据端口(20)

**主动FTP和被动FTP**

<img src="../../../pictures/Snipaste_2022-12-08_19-27-20.png" width="800"/> 


## ftp

### ftp命令

<img src="../../../pictures/Snipaste_2022-12-08_22-58-25.png" width="500"/> 

| 常用命令    | 说明                                                         |
| :---------- | :----------------------------------------------------------- |
| cd          | 切换路径                                                     |
| dir 和 ls   | dir查看FTP服务器中的文件及目录，ls仅查看文件                 |
| get 和 mget | get一次只下载一个文件；mget一次可以下载多个文件，而且支持通配符，需要注意的是在mget的时侯，需要对每一个文件都选择y/n，如果想不交互的下载全部的文件，可以先用prompt命令关掉交互方式（关闭：prompt off；打开：prompt on）。 获得的文件默认在当前的工作目录下（即执行加入FTP服务器的目录） |
| bye         | 退出                                                         |

### 安装ftp

```shell
cd /mnt/room/Packages
rpm -ivh ftp-0.17-67.el7.x86_64.rpm
```

### ftp访问方式

1. cmd中：ftp FTP服务器地址
2. 浏览器访问(已弃用)。使用命令`ftp://username:password@hostname:port`
3. 资源管理器访问。打开我的电脑，在文件路径中，输入ftp://网址
4. 客户端工具访问
5. 在桌面上新建快捷方式。方便需要时不时连接FTP的用户，右键单击选择新建快捷方式，直接访问快捷方式地址：`%SystemRoot%/explorer.exe ftp://用户名:密码@服务器网址`；如`D:\software\firefox\firefox.exe ftp:admin:admin@127.0.0.1:1990`。

```
C:\Users\zjk10>ftp 192.168.186.155
连接到 192.168.186.155。
220 (vsFTPd 3.0.2)
200 Always in UTF8 mode.
用户(192.168.186.155:(none)): anonymous
331 Please specify the password.
密码:
230 Login successful.
ftp>
```

- 对于cmd方式：匿名用户使用 anonymous,无密码登录

``` 
# 浏览器登录
ftp://user1:pass1@192.168.186.155:20
```

### 系统用户和虚拟用户

**ftp的登录方式分为系统用户和虚拟用户**

- **系统用户**是指使用当前shell中的系统用户登录FTP服务器，用户登录后对于主目录具有和Shell中相同的权限。
- **虚拟用户**只能访问服务器为其提供的FTP服务，而不能访问系统的其他资源。在vsftp中，认证这些虚拟用户使用的是单独的口令库文件（pam_userdb），由可插入认证模块（PAM）认证，更安全灵活。

## vsftp的安装与配置

### 安装

```shell
# 安装
rpm -ivh vsftpd-3.0.2-22.el7.x86_64.rpm
# 查看主要文件和安装路径
rpm -qpl vsftpd-3.0.2-22.el7.x86_64.rpm
```

```shell
# vsftp启停控制单元
/usr/lib/systemd/system/vsftpd.service
/usr/lib/systemd/system/vsftpd.target
/usr/lib/systemd/system/vsftpd@.service
# 保存认证用户
/etc/vsftpd/ftpusers
/etc/vsftpd/user_list
# 主配置文件
/etc/vsftp/vsftpd.conf
# 主程序
/usr/bin/vsftpd
```

### 匿名FTP设置

```shell
# FTP服务器中可以访问的文件
chown -R ftp.users /var/ftp/pub
# 修改配置文件
vim /etc/vsftpd/vsftpd.conf
```

**配置文件/ect/vsftpd/vsftpd.conf**

```shell
# 修改：/etc/vsftpd/vsftpd.conf
listen=YES
# 允许匿名登录
anonymous_enable=YES
# 允许上传文件
write_enable=YES
anon_upload_enable=YES
# 启用日志
xferlog_enable=YES
# 日志路径
vsftpd_log_file=/var/log/vsftpd.log
# 使用匿名用户登录时，映射到的用户名
ftp_username=ftp
# 允许本地登录
local_enable=YES

# 即如下：
listen=YES
anonymous_enable=YES
write_enable=YES
anon_upload_enable=YES
xferlog_enable=YES
vsftpd_log_file=/var/log/vsftpd.log
ftp_username=ftp
local_enable=YES
```

**重启服务**

```shell
systemctl restart vsftpd
```

#### 登录

### 实名FTP设置

#### 1. 修改/etc/vsftpd/vsftpd.conf

```shell
vim /etc/vsftpd/vsftpd.conf
# 修改如下
listen=YES
# 绑定本地主机IP
listen_address=192.168.186.155
# 禁止匿名用户登录
anonymous_enable=NO
anon_upload_enable=NO
anon_mkdir_write_enable=NO
anon_other_write_enable=NO
# 不允许FTP用户离开自己的主目录
chroot_list_enable=NO
# 虚拟用户列表，每行一个用户名
chroot_list_file=/etc/vsftpd.chroot_list
# 允许本地访问
local_enable=YES
# 允许写入
write_enable=YES
allow_writeable_chroot=YES
# 上传的文件默认的权限掩码
local_umask=022
# 禁止本地用户离开自己的FTP主目录
chroot_local_user=YES
# 权限验证需要的加密文件
pam_service_name=vsftpd.vu
# 开启虚拟用户的性能
guest_enable=YES
# 虚拟用户的宿主目录
guest_username=ftp
# 用户登录后操作主目录和本地用户具有同样的权限
virtual_use_local_privs=YES
# 虚拟用户主目录设置文件
user_config_dir=/etc/vsftpd/vconf

# 即如下：
listen=YES
listen_address=192.168.186.155
anonymous_enable=NO
anon_upload_enable=NO
anon_mkdir_write_enable=NO
anon_other_write_enable=NO
chroot_list_enable=NO
chroot_list_file=/etc/vsftpd.chroot_list
local_enable=YES
write_enable=YES
allow_writeable_chroot=YES
local_umask=022
chroot_local_user=YES
pam_service_name=vsftpd.vu
guest_enable=YES
guest_username=ftp
virtual_use_local_privs=YES
user_config_dir=/etc/vsftpd/vconf
```

#### 2.编辑用户文件/etc/vsftpd.chroot_list

- 一行一个用户名

```shell
vim /etc/vsftpd.chroot_list
#user1
#user2
```

#### 3.增加用户并指定主目录

```shell
mkdir -p /data/{user1,user2}
chmod -R 777 /data/user1 /data/user2
```

#### 4.设置用户密码数据库

```shell
echo -e "user1\npass1\nuser2\npass2">/etc/vsftpd/vusers.list
cd /etc/vsftpd
db_load -T -t hash -f vusers.list vusers.db
chmod 600 vusers.*
```

#### 5.指定认证方式

```shell
echo -e "#%PAM-1.0\n\nauth    required pam_userdb.so    db=/etc/vsftpd/vusers\naccount    required pam_userdb.so    db=/etc/vsftpd/vusers">/etc/pam.d/vsftpd.vu
mkdir vconf
```

#### 6.编辑对用户的用户文件，指定主目录

```shell
cd /etc/vsftpd/vconf
vim user1
# local_root=/data/user1
vim user2
# local_root=/data/user2
```

#### 7.创建标识文件

```shell
touch /data/user1/user1
touch /data/user2/user2
```

#### 8.重启服务

```shell
systemctl restart vsftpd
```

#### 使用

- 如匿名，只不过需要用户密码

## proftpd的安装配置 

### 安装

```shell
cd /root/install
# 速度过慢，下不动
#wget ftp://ftp.proftpd.org/distrib/source/proftpd-1.3.8.tar.gz
#tar -xvf proftpd-1.3.8.tar.gz
# 使用git clone https://github.com/proftpd/proftpd.git 得到已经解压的
cd /mnt/room/Packages
rpm -ivh m4-1.4.16-10.el7.x86_64.rpm
rpm -ivh autoconf-2.69-11.el7.noarch.rpm
rpm -ivh perl-CPAN-Meta-YAML-0.008-14.el7.noarch.rpm
rpm -ivh perl-JSON-PP-2.27202-2.el7.noarch.rpm
rpm -ivh perl-Parse-CPAN-Meta-1.4404-5.el7.noarch.rpm
rpm -ivh perl-Thread-Queue-3.02-2.el7.noarch.rpm
rpm -ivh perl-Test-Harness-3.28-3.el7.noarch.rpm
rpm -ivh automake-1.13.4-3.el7.noarch.rpm
rpm -ivh libtool-2.4.2-22.el7_3.x86_64.rpm
rpm -ivh libtool-ltdl-2.4.2-22.el7_3.x86_64.rpm
rpm -ivh libtool-ltdl-devel-2.4.2-22.el7_3.x86_64.rpm
cd /root/install/proftp
# 替换该解压目录下的config.sub和config.guess文件
cp /usr/share/libtool/config/config.guess .
cp /usr/share/libtool/config/config.sub .
./configure --prefix=/usr/local/proftp
# 出问题
make
make install
```

### 匿名FTP设置

- 配置文件 /usr/local/proftp/etc/proftpd.conf

```shell
chown -R ftp.users /var/ftp
vim /usr/local/proftp/etc/proftpd.conf
#修改内容：
```

```
ServerName    "ProFTP Default Installation"
ServerType    standalone
DefaultServer    on
Port    21
Umask    022
# 最大实例数
MaxInstances    30
# FTP启动后将切换到此用户和组运行
User    myftp
Group    myftp
AllowOverwrite    on
# 匿名服务器配置
<Anonymous ~>
    User    ftp
    Group    ftp
    UserAlias    anonymous ftp
    MaxClients    10
# 控制权限
<Limit WRITE>
    AllowAll
</Limit>
</Anonymous>
```

#### 启动服务

```shell
# 添加用户 useradd myftp
# 启动服务
/usr/local/proftp/sbin/proftpd
# 关闭SELinux
setenforce 0
# 检查是否成功
ps -ef | grep proftpd
```

#### 匿名用户登录

- 使用的用户名为 anonymous，无密码登录。

```shell
ftp 192.168.186.155
```

### 实名FTP设置 

```shell
useradd -d /data/proftpuser1 -m proftpuser1
useradd -d /data/proftpuser2 -m proftpuser2
passwd proftpuser1
passwd proftpuser2
```

**编辑  /usr/local/proftp/etc/proftpd.conf**

```shell
# 添加以下：
<VirtualHost 192.168.186.155>
    DefaultRoot    /data/guest
    AllowOverwrite    no
    <Limit STOR MKD RETR>
        AllowAll
    </Limit>
    <Limit DIRS WRITE READ DELE RMD>
        AllowUser proftpuser1 proftpuser2
        DenyAll
    </Limit>
</VirtualHost>
```

#### 启动服务

```shell
/usr/local/proftp/sbin/proftpd
mkdir /data/guest
chmod -R 777 /data/guest/
```

#### 登录
