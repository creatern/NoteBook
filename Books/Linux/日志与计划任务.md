# 日志系统

## /var/log 日志目录

- Linux日志一般放在/var/log下，需要root用户权限

| 日志类型     | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| 系统连接日志 | 记录系统的登录记录和用户名，写录到/var/log/wtmp、/var/log/utmp |
| 进程统计     | 系统内核执行，当一个进程终止时为每个进程往进程统计文件中写一个记录 |
| 错误日志     | 各种系统守护进程、用户程序和内核，通过syslog向/var/log/messages写录 |

| /var/log文件 | 说明                                       |
| :----------- | :----------------------------------------- |
| btmp         | 记录失败的记录                             |
| syslog       | 从syslog中记录信息                         |
| wtmp         | 一个用户每次登录和退出时间的永久记录       |
| lastlog      | 记录最后一次失败的登录和最近几次成功的登录 |
| dmesg        | Linux系统启动信息                          |
| **rpm系**    | **说明**                                   |
| messages     | 服务器的系统日志                           |
| access-log   | 记录Web服务访问日志，错误信息存于error-log |
| acct/pacct   | 记录用户命令                               |
| sudolog      | 记录使用sudo发出的命令                     |
| sulog        | 记录su命令的使用                           |
| secure       | 记录系统登录行为                           |
| utmp         | 记录当前登录的每个用户                     |

## 日志信息查看命令

| 命令   | 说明                                                         | 对应文件       |
| ------ | ------------------------------------------------------------ | -------------- |
| who、w | 显示目前登录系统的用户信息                                   | /var/log/wtmp  |
| users  | 显示当前登录系统的所有用户<br />如果一个用户有不止一个登录会话，那他的用户名将显示相同的次数 |                |
| last   | 列出目前与过去登录系统的用户相关信息                         | /var/log/wtmp  |
| dmesg  | 显示Linux系统启动信息，检查和控制内核的环形缓冲区            | /var/log/dmesg |

## /etc/rsyslog.conf 日志系统

```shell
# 服务1.优先级;服务2.优先级    操作动作
*.info;mail.none  /var/log/messages
```

| 日志设备       | 功能                              |
| -------------- | --------------------------------- |
| auth           | pam\_pwdb报告的认证活动           |
| authpriv       | 包括特权信息在内的认证活动        |
| cron           | 与cron、at相关的计划任务信息      |
| daemon         | 与inetd守护进程相关的后台进程信息 |
| kern           | 内核信息，先通过klogd传递         |
| lpr            | 与打印服务有关的信息              |
| mail           | 与电子邮件有关的信息              |
| mark           | syslog内部功能，用于生成时间戳    |
| news           | 来自新闻服务器的信息              |
| syslog         | syslog生成的信息                  |
| user           | 用户程序生成的信息                |
| uucp           | uucp生成的信息                    |
| local0\~local7 | 自定义程序使用                    |

| 优先级限定符 | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| \*           | 服务生成的所有日志消息都发送到操作动作指定的地点             |
| =            | 服务生成的本优先级的日志消息都发送到操作动作指定的地点       |
| \!           | 服务生成的所有日志消息都发送到操作动作指定的地点，但本优先级的消息不包括在内 |

- 操作动作：每条消息都会经过所有的规则，并非唯一匹配的

<img src="../../pictures/Snipaste_2022-11-29_19-52-55.png" width="700"/> 

## /etc/logrotate.conf 日志轮转

- /etc/logrotate.conf：对系统日志进行轮转、压缩、删除、发送到指定邮箱。每个记录文件都可被设置成每日/周/月处理、或文件太大时处理。

```shell
# rotate log files weekly 每周轮转
weekly

# keep 4 weeks worth of backlogs 保存过去四周的文件
rotate 4

# create new (empty) log files after rotating old ones 轮转以后创建新的空白日志文件
create

# use date as a suffix of the rotated file 轮转的文件以日期结尾
dateext

# uncomment this if you want your log files compressed 如果需要对轮转后的日志压缩，去掉此行注释
# compress

# RPM packages drop log rotation information into this directory 其他配置存放的文件目录;即用户自定义的配置
include /etc/logrotate.d

# no packages own wtmp and btmp -- we'll rotate them here 一些系统日志的轮转规则
/var/log/wtmp {
    monthly
    create 0664 root utmp
        minsize 1M
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}

# system-specific logs may be also be configured here.
```

### /etc/logrotate.d 自定义配置轮转

<img src="../../pictures/Snipaste_2022-11-29_20-11-41.png" width="800"/> 

```shell
# 测试轮转：无error日志，则正常生成轮转配置文件。
/user/sbin/logrotate -vf /etc/logrotate.conf
```

# rtcwake

- `rtcwake`：停止系统时，将其设置为ACPI（Advanced Configuration and Power Interface，高级配置和电源接口）睡眠状态；在执行该命令时需要注意将硬件的时钟设置为UTC

>RTC（Real-Time Clock，实时时钟）；UTC（Coordinated Universal Time，协调世界时）
>
>RTC唤醒是最不靠谱的方式

```shell
 -a, --auto               reads the clock mode from adjust file (default)
 -A, --adjfile <file>     specifies the path to the adjust file
                            the default is /etc/adjtime
     --date <timestamp>   date time of timestamp to wake
 -d, --device <device>    select rtc device (rtc0|rtc1|...)
 -n, --dry-run            does everything, but suspend
 -l, --local              RTC uses local timezone
     --list-modes         list available modes
 -m, --mode <mode>        standby|mem|... sleep mode
 -s, --seconds <seconds>  seconds to sleep
 -t, --time <time_t>      time to wake
 -u, --utc                RTC uses UTC
 -v, --verbose            verbose messages

 -h, --help               display this help
 -V, --version            display version
```

```shell
# 在系统以mem模式休眠20秒后，唤醒
sudo rtcwake -s 20 -m mem

# 在指定的时间唤醒系统
rtcwake -t `date -d 10:53 +%s` -m mem
```

- `/sys/power/state`：当前系统支持的ACPI睡眠状态。ACPI是用于管理睡眠状态的现代电源管理标准，不依赖任何供应商，独立于硬件，但硬件供应商通常只实现其功能的一个子集，且Linux内核只能支持最多4个，不同的发行版支持的种类和数量也不同

| ACPI state | mode                 | 意义                                                         |
| ---------- | -------------------- | ------------------------------------------------------------ |
| S0         | -                    | 系统正常运行状态，所有设备均处于活动状态，CPU全速运行，系统可以响应用户输入并执行程序 |
| S1         | standby<br />suspend | 默认，系统挂起，CPU停止，CPU和内存的电源未切断               |
| S2         | -                    | CPU断电，脏缓存被保存到内存                                  |
| S3         | mem                  | 待机、睡眠、挂起到内存，数据可能未写入磁盘                   |
| S4         | disk                 | 内容保存到硬盘上，然后系统完全断电。唤醒时从硬盘载入内存数据，唤醒时间较长但最省电 |
| S5         | off<br />shutdown    | 完全关机状态，通过系统的关机命令进入；所有电源供应切断，系统状态不保留，重新启动时需要进行全面的系统初始化 |

| 非ACPI规范 | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| freeze     | 冻结，系统暂停所有非关键进程，并且阻止用户输入的一种临时挂起模式；CPU仍在运行，但大部分用户空间任务被冻结，内核仍然可以响应特定的管理和控制操作 |
| no         | 不进入睡眠状态，只设置唤醒时间                               |

