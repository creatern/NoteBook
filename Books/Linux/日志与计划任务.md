# 日志系统

## /var/log 日志目录

- Linux日志一般放在/var/log下，需要root用户权限

| 日志类型     | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| 系统连接日志 | 记录系统的登录记录和用户名，写录到/var/log/wtmp、/var/log/utmp |
| 进程统计     | 系统内核执行，当一个进程终止时为每个进程往进程统计文件中写一个记录 |
| 错误日志     | 各种系统守护进程、用户程序和内核，通过syslog向/var/log/messages写录 |

| /var/log文件 | 说明                                       |
| :----------- | :----------------------------------------- |
| btmp         | 记录失败的记录                             |
| syslog       | 从syslog中记录信息                         |
| wtmp         | 一个用户每次登录和退出时间的永久记录       |
| lastlog      | 记录最后一次失败的登录和最近几次成功的登录 |
| dmesg        | Linux系统启动信息                          |
| **rpm系**    | **说明**                                   |
| messages     | 服务器的系统日志                           |
| access-log   | 记录Web服务访问日志，错误信息存于error-log |
| acct/pacct   | 记录用户命令                               |
| sudolog      | 记录使用sudo发出的命令                     |
| sulog        | 记录su命令的使用                           |
| secure       | 记录系统登录行为                           |
| utmp         | 记录当前登录的每个用户                     |

## 日志信息查看命令

| 命令   | 说明                                                         | 对应文件       |
| ------ | ------------------------------------------------------------ | -------------- |
| who、w | 显示目前登录系统的用户信息                                   | /var/log/wtmp  |
| users  | 显示当前登录系统的所有用户<br />如果一个用户有不止一个登录会话，那他的用户名将显示相同的次数 |                |
| last   | 列出目前与过去登录系统的用户相关信息                         | /var/log/wtmp  |
| dmesg  | 显示Linux系统启动信息，检查和控制内核的环形缓冲区            | /var/log/dmesg |

## /etc/rsyslog.conf 日志系统

```shell
# 服务1.优先级;服务2.优先级    操作动作
*.info;mail.none  /var/log/messages
```

| 日志设备       | 功能                              |
| -------------- | --------------------------------- |
| auth           | pam\_pwdb报告的认证活动           |
| authpriv       | 包括特权信息在内的认证活动        |
| cron           | 与cron、at相关的计划任务信息      |
| daemon         | 与inetd守护进程相关的后台进程信息 |
| kern           | 内核信息，先通过klogd传递         |
| lpr            | 与打印服务有关的信息              |
| mail           | 与电子邮件有关的信息              |
| mark           | syslog内部功能，用于生成时间戳    |
| news           | 来自新闻服务器的信息              |
| syslog         | syslog生成的信息                  |
| user           | 用户程序生成的信息                |
| uucp           | uucp生成的信息                    |
| local0\~local7 | 自定义程序使用                    |

| 优先级限定符 | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| \*           | 服务生成的所有日志消息都发送到操作动作指定的地点             |
| =            | 服务生成的本优先级的日志消息都发送到操作动作指定的地点       |
| \!           | 服务生成的所有日志消息都发送到操作动作指定的地点，但本优先级的消息不包括在内 |

- 操作动作：每条消息都会经过所有的规则，并非唯一匹配的

<img src="../../pictures/Snipaste_2022-11-29_19-52-55.png" width="700"/> 

## /etc/logrotate.conf 日志轮转

- /etc/logrotate.conf：对系统日志进行轮转、压缩、删除、发送到指定邮箱。每个记录文件都可被设置成每日/周/月处理、或文件太大时处理。

```shell
# rotate log files weekly 每周轮转
weekly

# keep 4 weeks worth of backlogs 保存过去四周的文件
rotate 4

# create new (empty) log files after rotating old ones 轮转以后创建新的空白日志文件
create

# use date as a suffix of the rotated file 轮转的文件以日期结尾
dateext

# uncomment this if you want your log files compressed 如果需要对轮转后的日志压缩，去掉此行注释
# compress

# RPM packages drop log rotation information into this directory 其他配置存放的文件目录;即用户自定义的配置
include /etc/logrotate.d

# no packages own wtmp and btmp -- we'll rotate them here 一些系统日志的轮转规则
/var/log/wtmp {
    monthly
    create 0664 root utmp
        minsize 1M
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}

# system-specific logs may be also be configured here.
```

### /etc/logrotate.d 自定义配置轮转

<img src="../../pictures/Snipaste_2022-11-29_20-11-41.png" width="800"/> 

```shell
# 测试轮转：无error日志，则正常生成轮转配置文件。
/user/sbin/logrotate -vf /etc/logrotate.conf
```

# 计划任务

## at 定时任务

| 命令 | 说明                           |
| ---- | ------------------------------ |
| at   | 在指定时间执行任务，只执行一次 |
| atq  | 显示当前所有定时任务           |
| atrm | 删除指定序号的定时任务         |

| 指定时间的格式 | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 绝对计时法     | 当天的hh:mm。若该时间已过去，那么就放在第二天执行。<br />midnight（深夜），noon（中午），teatime（一般是下午4点）等比较模糊的词语来指定时间。<br />12小时计时制，时间后面加上AM（上午）、PM（下午）。<br />具体日期，指定格式为month day、mm/dd/yy、dd.mm.yy。指定的日期必须跟在指定时间的后面。 |
| 相对计时法     | now + count time-units：now当前时间、time-units是时间单位 minutes（分钟）、hours（小时）、days（天）、weeks（星期）、count是时间的数量，究竟是几天，还是几小时，等等。<br />直接使用today（今天）、tomorrow（明天）。 |

```shell
# at 23:43 today
at> date >/root/today.log            
at> <EOT>
job 3 at Sun Nov 27 23:43:00 2022
```

```shell
# atq
4       Wed Nov 30 08:40:00 2022 a root
```

## cron 周期任务

### crontab

- <span name="crontab"><code>crontab</code></span>（cron table）：提交和管理用户需要周期性执行的任务。默认会安装此服务工具，并自动启动[crond](#crond)进程，crond进程每分钟会定期检查是否有要执行的任务，如果有要执行的任务，则自动执行该任务。

```shell
crontab [选项] [crontab 的任务列表文件]
```

<table><tbody><tr><td>-e</td><td>编辑任务</td><td rowspan="3">&nbsp;</td><td>-r</td><td>删除任务</td></tr><tr><td>-i</td><td>删除前询问用户是否确认</td><td>-u</td><td>设置用户名</td></tr><tr><td>-l</td><td>显示任务</td><td>--help</td><td>显示帮助信息</td></tr></tbody></table>

```shell
# 打开cron配置文件进行编辑，产生的文件最终保存到/var/spool/cron/crontabs
sudo crontab -e
```

```shell
# m h  dom mon dow   command
0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
# at 5 a.m every week with:
```

#### /var/spool/cron

- `/var/spool/cron/crontabs`：用户任务调度，用户定期要执行的工作，比如用户数据备份、定时邮件提醒等。所有用户定义的crontab文件（crontab命令）都被保存在`/var/spool/cron/crontabs`目录中，其文件名与用户名一致

### /etc/crontab

- `/etc/crontab`：系统任务调度的配置文件，系统周期性所要执行的工作，比如写缓存数据到硬盘、日志清理等。

```shell
# sudo vim /etc/crontab

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
```

```shell
# 每1分钟执行一次command
* * * * * command

# 每小时的第3和第15分钟执行
3,15 * * * * command

# 在上午8点到11点的第3和第15分钟执行
3,15 8-11 * * * command

# 每隔两天的上午8点到11点的第3和第15分钟执行
3,15 8-11 */2 * * command

# 每个星期一的上午8点到11点的第3和第15分钟执行
3,15 8-11 * * 1 command

# 每晚的21:30重启smb 
30 21 * * * /etc/init.d/smb restart

# 每月1、10、22日的4 : 45重启smb 
45 4 1,10,22 * * /etc/init.d/smb restart

# 每周六、周日的1:10重启smb
10 1 * * 6,0 /etc/init.d/smb restart

# 每天18 : 00至23 : 00之间每隔30分钟重启smb 
0,30 18-23 * * * /etc/init.d/smb restart

# 每星期六的晚上11:00 pm重启smb 
0 23 * * 6 /etc/init.d/smb restart

# 每一小时重启smb 
* */1 * * * /etc/init.d/smb restart

# 晚上11点到早上7点之间，每隔一小时重启smb
* 23-7/1 * * * /etc/init.d/smb restart

# 每月的4号与每周一到周三的11点重启smb 
0 11 4 * mon-wed /etc/init.d/smb restart

# 一月一号的4点重启smb
0 4 1 jan * /etc/init.d/smb restart

# 每小时执行/etc/cron.hourly目录内的脚本
01 * * * * root run-parts /etc/cron.hourly
```

## crond进程

- <span name="crond">crond进程</span>每分钟会定期检查是否有要执行的任务，如果有要执行的任务，则自动执行该任务

```shell
service crond status # 查看crond服务状态
/sbin/service crond start    # 启动服务
/sbin/service crond stop     # 关闭服务
/sbin/service crond restart  # 重启服务
/sbin/service crond reload   # 重新载入配置
ntsysv # 查看crond服务是否已经设置为开机启动
chkconfig –level 35 crond on # 加入开机自动启动
```

## rtcwake

- `rtcwake`：停止系统时，将其设置为ACPI（Advanced Configuration and Power Interface，高级配置和电源接口）睡眠状态；在执行该命令时需要注意将硬件的时钟设置为UTC

>RTC（Real-Time Clock，实时时钟）；UTC（Coordinated Universal Time，协调世界时）
>
>RTC唤醒是最不靠谱的方式

```shell
 -a, --auto               reads the clock mode from adjust file (default)
 -A, --adjfile <file>     specifies the path to the adjust file
                            the default is /etc/adjtime
     --date <timestamp>   date time of timestamp to wake
 -d, --device <device>    select rtc device (rtc0|rtc1|...)
 -n, --dry-run            does everything, but suspend
 -l, --local              RTC uses local timezone
     --list-modes         list available modes
 -m, --mode <mode>        standby|mem|... sleep mode
 -s, --seconds <seconds>  seconds to sleep
 -t, --time <time_t>      time to wake
 -u, --utc                RTC uses UTC
 -v, --verbose            verbose messages

 -h, --help               display this help
 -V, --version            display version
```

```shell
# 在系统以mem模式休眠20秒后，唤醒
sudo rtcwake -s 20 -m mem

# 在指定的时间唤醒系统
rtcwake -t `date -d 10:53 +%s` -m mem
```

- `/sys/power/state`：当前系统支持的ACPI睡眠状态。ACPI是用于管理睡眠状态的现代电源管理标准，不依赖任何供应商，独立于硬件，但硬件供应商通常只实现其功能的一个子集，且Linux内核只能支持最多4个，不同的发行版支持的种类和数量也不同

| ACPI state | mode                 | 意义                                                         |
| ---------- | -------------------- | ------------------------------------------------------------ |
| S0         | -                    | 系统正常运行状态，所有设备均处于活动状态，CPU全速运行，系统可以响应用户输入并执行程序 |
| S1         | standby<br />suspend | 默认，系统挂起，CPU停止，CPU和内存的电源未切断               |
| S2         | -                    | CPU断电，脏缓存被保存到内存                                  |
| S3         | mem                  | 待机、睡眠、挂起到内存，数据可能未写入磁盘                   |
| S4         | disk                 | 内容保存到硬盘上，然后系统完全断电。唤醒时从硬盘载入内存数据，唤醒时间较长但最省电 |
| S5         | off<br />shutdown    | 完全关机状态，通过系统的关机命令进入；所有电源供应切断，系统状态不保留，重新启动时需要进行全面的系统初始化 |

| 非ACPI规范 | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| freeze     | 冻结，系统暂停所有非关键进程，并且阻止用户输入的一种临时挂起模式；CPU仍在运行，但大部分用户空间任务被冻结，内核仍然可以响应特定的管理和控制操作 |
| no         | 不进入睡眠状态，只设置唤醒时间                               |

