# Linux用户概述

- 影子密码套件（Shadow Password Suite）：[/etc/login.defs](#/etc/login.defs)是主要的Linux管理用户和组的命令的配置文件；影子密码套件将用户的哈希密码保存到只有root用户可以访问的[/etc/shadow](#shadow)和`/etc/gshadow`，而不再是[/etc/passwd](#/etc/passwd)和[/etc/group](#/etc/group)

| 用户类型 | 说明                                                         |
| :------- | :----------------------------------------------------------- |
| 超级用户 | root；UID: 0                                                 |
| 系统用户 | 正常运行时，系统使用的用户，每个进程在系统中都有一个相应的属主<br />系统用户不能用来登录（bin、daemon、mail等） |
| 普通用户 | user                                                         |

# 用户与用户组

## 用户管理命令

### useradd

- <span name="useradd"><code>useradd</code></span>：添加用户，自动完成用户信息、基本组、主目录等的创建工作（主要根据[/etc/default/useradd](#/etc/default/useradd)的配置），并在创建过程中对用户初始信息进行定制，并不包括用户密码的设置（[passwd](#passwd)）

<table><tbody><tr><td>-c</td><td>添加备注文字</td><td rowspan="11">&nbsp;</td><td>-M</td><td>不建立用户主目录（home）</td></tr><tr><td>-d</td><td>设置新用户登录时所使用的家目录</td><td>-n</td><td>不建立以用户名称为名的组</td></tr><tr><td>-D</td><td>设置新用户的预设值</td><td>-o</td><td>允许创建重复UID的用户</td></tr><tr><td>-e</td><td>设置用户的终止日期</td><td>-p</td><td>设置用户的密码</td></tr><tr><td>-f</td><td>设置用户过期几日后永久停权</td><td>-r</td><td>建立系统用户</td></tr><tr><td>-g</td><td>设置用户对应的基本用户组</td><td>-R</td><td>设置根目录</td></tr><tr><td>-G</td><td>设置用户对应的扩展用户组</td><td>-s</td><td>设置新用户的默认Shell终端</td></tr><tr><td>-h</td><td>显示帮助信息</td><td>-u</td><td>设置用户ID</td></tr><tr><td>-k</td><td>设置用户的骨架目录</td><td>-U</td><td>创建与用户同名的组，并将其加入</td></tr><tr><td>-l</td><td>不将用户添加到最近登录和登录失败数据库文件</td><td>-Z</td><td>设置用户的SELinux映射角色</td></tr><tr><td>-m</td><td>用户目录不存在时则自动创建</td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table>

```shell
# 创建用户的同时，将用户添加到其他扩展用户组（必须是已经存在的组）
useradd zjk -G group1,group2,...
```

#### -r 系统用户的创建

```shell
# 创建一个无主目录和登录shell的系统用户，并自动在系统用户ID范围内指定一个实际ID
sudo useradd -rs /bin/false mysys
```

#### -D /etc/default/useradd

- <span name="/etc/default/useradd"><code>/etc/default/useradd</code></span>：`useradd`命令创建用户时的预设值

<table>
    <tr>
        <th>预设值</th>
        <th>意义</th>
    </tr>
    <tr>
        <td width="20%" rowspan="2">GROUP</td>
        <td width="80%">指定默认的用户组。</td>
    </tr>
    <tr>
        <td>只有<code>-n</code>被使用时，该默认值才生效；若<code>-n</code>和<code>-g</code>都没有使用，则创建和用户名相同的个人私有组</td>
    </tr>
    <tr>
        <td>HOME</td>
        <td>指定创建用户时的默认主目录（/home）</td>
    </tr>
    <tr>
        <td rowspan="2">INACTIVE</td>
        <td>指定密码到期后，用户即将被封禁的默认倒计天数</td>
    </tr>
    <tr>
        <td><code>0</code>：密码过期后立即封禁；<code>-1</code>：不封禁</td>
    </tr>
    <tr>
        <td>EXPIRE</td>
        <td>指定账户何时过期的默认日期（<code>YYYY-MM-DD</code>），空则永不过期</td>
    </tr>
    <tr>
        <td>SHELL</td>
        <td>指定该用户的默认命令shell</td>
    </tr>
    <tr>
        <td rowspan="2">SKEL</td>
        <td>skeleton 骨架。指定目录，将该目录下的文件自动分发到用户的主目录（<code>HOME</code>）下</td>
    </tr>
    <tr>
        <td><code>/etc/skel</code>：Linux配置好的用户主目录需要的骨架</td>
    </tr>
    <tr>
        <td>CREATE_MAIL_SPOOL</td>
        <td>设置为yes即可</td>
    </tr>
</table>

```shell
# 查看useradd命令创建用户时的预设值
useradd -D
sudo vim /etc/default/useradd
```

### usermod

- `usermod`：修改用户（user modify），不允许改变正在线上的使用者帐号名称；若要改变UID，则必须确认此时该用户没在电脑上执行任何程序

<table><tbody><tr><td>-a</td><td>追加，将用户添加至扩展组中</td><td rowspan="8">&nbsp;</td><td>-L</td><td>锁定用户密码，使密码立即失效</td></tr><tr><td>-c</td><td>修改用户的备注文字</td><td>-m</td><td>将用户家目录内容移动到新位置</td></tr><tr><td>-d</td><td>修改用户登录时的家目录</td><td>-o</td><td>允许重复的用户ID</td></tr><tr><td>-e</td><td>修改用户的有效期限</td><td>-p</td><td>设置用户的新密码</td></tr><tr><td>-f</td><td>设置在密码过期多少天后关闭该用户</td><td>-s</td><td>修改用户登录后使用的Shell终端</td></tr><tr><td>-g</td><td>修改用户所属的基本群</td><td>-u</td><td>修改用户的ID</td></tr><tr><td>-G</td><td>修改用户所属的扩展群</td><td>-U</td><td>解除密码锁定，使密码恢复正常</td></tr><tr><td>-l</td><td>修改用户名称</td><td>-Z</td><td>设置用户的SELinux映射用户</td></tr></tbody></table>

```shell
# 为zjk用户追加扩展组zjk,root
usermod -aG zjk,root zjk

# 只有-G参数时，直接覆盖test用户原有的扩展组
usermod -G zjk,root test
```

### userdel

- `userdel`：删除用户（user delete），删除用户的同时会一并删除其对应的基本组

<table><tbody><tr><td>-f</td><td>强制删除用户而不询问</td><td rowspan="2">&nbsp;</td><td>-r</td><td>同时删除该用户的相关任务和文件（home）</td></tr><tr><td>-h</td><td>显示帮助信息</td><td>-Z</td><td>删除用户的SELinux映射用户</td></tr></tbody></table>

```shell
# 删除test用户及其相关任务和文件
sudo userdel -r test
```

### passwd

- <span name="#passwd"><code>passwd</code></span>：（password）设置用户的认证信息，包括用户密码、密码过期时间等；只有管理者可以指定用户名称，一般用户只能变更自己的密码

<table><tbody><tr><td>-d</td><td>清除已有密码</td><td rowspan="6">&nbsp;</td><td>-S</td><td>显示当前密码状态</td></tr><tr><td>-e</td><td>下次登录时强制修改密码</td><td>-u</td><td>解锁用户的密码值，允许修改</td></tr><tr><td>-f</td><td>强制执行操作而不询问</td><td>-w</td><td>设置密码到期前几天收到警告信息</td></tr><tr><td>-k</td><td>设置用户在期满后能仍能正常使用</td><td>-x</td><td>设置最大密码有效期</td></tr><tr><td>-l</td><td>锁定用户的密码值，不允许修改</td><td>--help</td><td>显示帮助信息</td></tr><tr><td>-n</td><td>设置最小密码有效期</td><td>--usage</td><td>显示简短的使用信息提示</td></tr></tbody></table>

```shell
# 查看用户密码状态
passwd -S
# zjk P 04/21/2022 0 99999 7 -1

# 重置root用户的密码
sudo passwd root
```

### id

- `id`：显示真实有效的用户ID（UID）、组ID（GID）
- UID：每个UID必须是唯一的，其编号范围由[/etc/login.defs](#/etc/login.defs)定义；通常，普通用户的UID从1000开始，并由<a href="#useradd"><code>useradd</code></a>自动分配

<table>
    <tbody>
        <tr><td>-g</td><td>显示用户所属基本组的ID（GID）</td><td rowspan="4">&nbsp;</td><td>-Z</td><td>显示用户的安全上下文</td></tr>
        <tr><td>-G</td><td>显示用户所属扩展组的ID（GID）</td><td>--help</td><td>显示帮助信息</td></tr>
        <tr><td>-n</td><td>显示用户所属基本组或扩展组的名称</td><td>--version</td><td>显示版本信息</td></tr>
        <tr><td>-u</td><td>显示用户的ID（UID）</td><td>-r</td><td>显示实际UID，但在默认环境时不可用</td></tr>
    </tbody>
</table>

| ID类型      | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| 实际UID/GID | 用户在创建时被赋予的UID和主GID                               |
| 有效UID/GID | 用户在运行不属于自己的特权的进程时，所使用的UID；如`passwd`命令属于root用户 |
| 暂存UID/GID | 用于需要提升特权的进程，一个进程需要做一些暂时不需要特权的操作时，可临时切换到非特权用户ID，而原有的UID会保存到SUID（Saved User ID，暂存用户ID），进程需要再次提升权限时，恢复SUID |

```shell
# 查看当前有效用户的ID
id

# 查看sudo的ID
sudo id
```

### su、sudo 切换用户

#### su

- su：切换用户，默认切换至root

```shell
# 切换用户但不改变环境变量
su [用户]

# 切换用户并改变环境变量
su - 用户

# 切换用户执行命令之后，返回原用户
su -c 命令 用户
```

#### sudo

- `sudo`：普通用户获取超级权限、以其他身份来执行命令，预设的身份为root

1. 该命令比`su`更安全，赋予用户的root权限仅限于执行特定的任务，且会记录活动，缓存的用户密码默认限定的时间为15分钟，之后需要重新输入密码；
2. sudo用户使用的是sudo的密码（不同的Linux发行版使用的用户密码不同），而不是root用户的密码
3. 大多数的应用可以通过shell逃离等方式来获取root权限

##### /etc/sudoers

- `/etc/sudoers`：设置可执行sudo指令的用户，通过`visudo`命令来编辑

```shell
#
# This file MUST be edited with the 'visudo' command as root.
#
# Please consider adding local content in /etc/sudoers.d/ instead of
# directly modifying this file.
#
# See the man page for details on how to write a sudoers file.
#
Defaults        env_reset
Defaults        mail_badpass
Defaults        secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"

# Host alias specification

# User alias specification

# Cmnd alias specification

# User privilege specification
# 指定了root用户具有所有权限，可以以任何用户身份（ALL）在任何主机（ALL）上运行任何命令（ALL）
root    ALL=(ALL:ALL) ALL

# Members of the admin group may gain root privileges
# % 表示引用/etc/group内的组
# "admin" 的用户组中的所有成员，可以在任何主机上以任何用户身份执行任意命令，也就是和root用户相当
%admin ALL=(ALL) ALL

# Allow members of group sudo to execute any command
# "sudo" 用户组的所有用户同样可以在任何主机上以任何用户身份执行任意命令，从而赋予他们完整的root权限
%sudo   ALL=(ALL:ALL) ALL

# See sudoers(5) for more information on "#include" directives:

#includedir /etc/sudoers.d
```

```shell
# 设置sudo缓存密码的默认间隔（分钟）
Defaults timestamp_timeout=60

# server1可以是域名或IP地址
# 给于test1用户在server1主机上执行/bin/rpm, /usr/bin/yum的权限
test1 sever1 = /bin/rpm, /bin/yum

# 自定义命令别名SOFTWARE,SYSTEMD
Cmnd_Alias SOFTWARE = /bin/rpm, /usr/bin/yum, /usr/bin/dnf
Cmnd_Alias SYSTEMD = /usr/bin/systemctl start, /usr/bin/systemctl stop, /usr/bin/systemctl reload, /usr/bin/systemctl restart, /usr/bin/systemctl status, /usr/bin/systemctl enable, /usr/bin/systemctl disable, /usr/bin/systemctl mask, /usr/bin/systemctl unmask
# 给于test2用户在server1主机上执行SOFTWARE和SYSTEMD内的所有命令的权限
test2 server2 = SOFTWARE, SYSTEMD
# 自定义用户组别名（与/etc/group内的用户组无关）JRADMIN包含test3和test4用户，并赋予在server3主机的SOFTWARE和SYSTEMD命令别名
User_Alias JRADMIN = test3, test4
JRADMIN server3 = SOFTWARE, SYSTEMD
# 自定义Host_Aliad别名
Host_Alias SERVERS = server1, server2, server3
test5 SERVERS = SOFTWARE
```

##### /etc/sudoers.d

- `/etc/sudoers.d`：为用户创建单独的sudo配置，相当于特定用户对`/etc/sudoers`的补充，其配置项的配置方式相同

### 主目录特殊目录

#### /etc/xdg/user-dirs.conf

- `/etc/xdg/user-dirs.conf`：定义用户首次进入<a href="./服务单元控制.md#target">graphical.target</a>时，系统自动在用户主目录下创建的目录与其对应的映射

```shell
DESKTOP=Desktop
DOWNLOAD=Downloads
TEMPLATES=Templates
PUBLICSHARE=Public
DOCUMENTS=Documents
MUSIC=Music
PICTURES=Pictures
VIDEOS=Videos
```

#### ~/.config/user-dirs.conf

- `~/.config/user-dirs.conf`：用户个人主目录映射文件，

```shell
XDG_DESKTOP_DIR="$HOME/Desktop"
XDG_DOWNLOAD_DIR="$HOME/Downloads"
XDG_TEMPLATES_DIR="$HOME/Templates"
XDG_PUBLICSHARE_DIR="$HOME/Public"
XDG_DOCUMENTS_DIR="$HOME/Documents"
XDG_MUSIC_DIR="$HOME/Music"
XDG_PICTURES_DIR="$HOME/Pictures"
XDG_VIDEOS_DIR="$HOME/Videos"
```

#### xdg-user-dirs-update

- `xdg-user-dirs-update`：命令的结果作用于`~/.config/user-dirs.conf`

```shell
# 设置主目录特殊目录的映射，必须是/etc/xdg/user-dirs.conf允许的映射，且目标目录已经创建
xdg-user-dirs-update --set DOWNLOAD=$HOME/myDownloads

# 重置为/etc/xdg/user-dirs.conf的预设值
xdg-user-dirs-update --force
```

### 禁用用户

- 禁用用户不等于删除用户，只是临时停用

```shell
# 禁用test用户的密码，该方式仅阻止密码登录，而无法阻止SSH秘钥等其他身份验证的登录方式
sudo passwd -l test

# 解锁
sudo passwd -u test
```

```shell
# 完全禁用test用户（使用户过期）
sudo usermod --expiredate 1 test

# 恢复
sudo usermod --expiredate -1 test
```

```shell
# 修改/etc/passwd
sudo vim /etc/passwd
# test:x:1001:1004::/home/test:/bin/sh 替换x
# test:*:1001:1004::/home/test:/bin/sh
```

## 用户组管理命令

- 用户创建的同时默认创建一个与用户名同名的用户组。
- 每个用户都有一个用户组，一个用户可以属于多个用户组，一个用户组可以有多个用户。
- 系统对一个用户组的用户集中管理，赋予用户组的权限可以被该用户获取；用户的权限为其所在的所有用户组的权限之和。

| 用户组文件                  | 说明                                 |
| --------------------------- | ------------------------------------ |
| [/etc/passwd](#/etc/passwd) | 定义的用户组为基本组，其他的为附加组 |
| [/etc/group](#/etc/group)   | 用户组的操作基于对该文件的更新       |

### groupadd

- `groupadd`：添加用户组

<table><tbody><tr><td>-f</td><td>若用户组已存在，则以成功状态退出</td><td rowspan="4">&nbsp;</td><td>-o</td><td>允许创建重复ID的用户组</td></tr><tr><td>-g</td><td>设置用户组ID</td><td>-p</td><td>设置用户组密码</td></tr><tr><td>-h</td><td>显示帮助信息</td><td>-r</td><td>创建系统用户组</td></tr><tr><td>-K</td><td>覆盖配置文件<a href="#/etc/login.defs">/etc/login.defs</a></td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table>

### groupdel

- `groupdel`：删除用户组（修改的系统文件包括`/ect/group`和`/ect/shadow`）；若该群组中仍包括某些用户，则必须先删除这些用户后，方能删除群组

### groupmod

- `groupmod`：修改用户组

### groups

- `groups`：查看用户所在用户组 

## 用户与组配置文件

### /etc/login.defs

- <span name="/etc/login.defs"><code>/etc/login.defs</code></span>：主要的Linux管理用户和组的命令的配置文件

### /etc/passwd

- <span name="/etc/passwd"><code>/etc/passwd</code></span>：普通用户的UID默认1000之后

```shell
# 用户名:加密密码:UID:GID:用户相关注释:用户主目录:用户使用的shell
root:x:0:0:root:/root:/bin/bash
```

| 字段         | 说明                                                      |
| ------------ | --------------------------------------------------------- |
| 用户名       | 大小写敏感                                                |
| 加密密码     | 存储在/etc/shadow（用户密码文件），只有root用户可以查看   |
| UID          | 用户标识号，相同UID的用户被认为是同一用户，UID最大为65535 |
| GID          | 组标识号，与/etc/group文件相关                            |
| 用户相关注释 |                                                           |
| 用户的主目录 |                                                           |
| 使用的shell  | 用户登录系统时运行的shell，通常为/bin/bash                |

### /etc/shadow

- <span name="/etc/shadow"><code>/etc/shadow</code></span>：存储用户密码等重要信息，需要root用户才能查看，不可编辑

```shell
# 用户名:加密密码:上次修改密码的时间:需要再次修改密码的最少间隔天数:密码的有效期:提前提醒用户密码过期的天数:密码过期几天后禁用该用户:用户过期时间:保留字段
root:$y$j9T$winqvu47uxSPB73JG1Cuu0$rWfYs20SLEtRak3NDJLSK7RHDody7iYD.8.lzX2QxS4:19526:0:99999:7:::
```

1. 需要再次修改密码的最少间隔天数：0表示禁用该选项；非0则表示经过n天之后必须修改密码
2. 提前提醒用户密码过期的天数：99999表示密码基本不用修改
3. 保留字段：置空，永久可用

- 计时：从1970-01-01开始计算的天数

### /etc/group

- <span name="/etc/group"><code>/etc/group</code></span>：用户登录时默认的组放在[/etc/passwd](#/etc/passswd)

```shell
# 用户组名:用户密码:GID:组内用户列表
zjk:x:1000:
```

### /etc/gshadow

- `/etc/gshadow`：需要root用户才能查看，不可编辑

### 相关命令

#### pwck

- `pwck`：检查`/etc/paswd`和`/etc/shadow`的完整性

#### grpck

- `grpck`：检查`/etc/group`和`/etc/gshadow`的完整性

# 用户行为控制

## who/w

- `who、w`：`who`返回的是在线用户以及登录时间、登录的IP；`w`返回的是在线用户、登录的地址IP，登录时间、在线时间

```shell
# 查看当前用户的登录信息
who am i
```

### 注销在线用户

```shell
# 查看所有在线用户
w

# 查看在线用户的pid
ps -u zjk

# 发送注销信号（15）使用户正常退出，需要有root权限来注销其他用户
sudo kill -15 [pid]
```
