# 文件系统

## 常用的文件系统

### Ext4

- Ext4属于日志文件系统，Linux发行版的默认文件系统；数据变更写入磁盘之前，Ext4会通过日志记录所有变更

### XFS

- XFS属于日志文件系统，高性能的UNIX 64位文件系统

### Btrfs

- Btrfs属于COW文件系统（Copy-on-write，写入时复制），

### FAT16/32

- FAT32是最通用的文件系统，通常用于便携式媒体，但文件大小限制在4GB以内

### exFAT

- exFAT是FAT32的升级版，64位，轻量级的文件系统，适用于U盘和SD媒体；没有日志或COW

## /proc/filesystems

- nodev：虚拟文件系统，只存在于内存，由Systemd管理

```shell
# 查看已安装的文件系统
cat /proc/filesystems
```

## 挂载/卸载文件系统

- 文件系统必须先挂载到正在运行的文件系统，然后才能访问，且需要一个挂载点
- <span name="挂载点">挂载点</span>：

1. 每个挂载点只能挂载一个文件系统，若挂载了多个，则被最后挂载的文件系统覆盖。
2. 挂载点的目录通常是[/mnt和/media](./文件管理.md)，只是惯例；`/mnt`通常用于静态挂载（[/etc/fstab](#/etc/fstab)），而`/media`通常用于自动挂载可移动媒体

### mount

- <span name="mount"><code>mount</code></span>：虚拟目录[挂载点](#挂载点)通常是在/mnt中新建一个目录来挂载。

```
mount [-lhV]
mount -a [options]
mount [options] [--source] <source> | [--target] <directory>
mount [options] <source> <directory>
mount <operation> <mountpoint> [<target>]
```

### umount

- <code>umount</code>（unmount）：与mount挂载命令需要同时提供设备名与挂载目录不同，umount卸载命令只需要提供设备名或挂载目录之一即可完成卸载。

```
umount [参数] 设备或目录名
```

<table><tbody><tr><td>-a</td><td data-immersive-translate-effect="1" data-immersive_translate_walked="7c05567e-e5ff-4670-b322-b61cd71b9233">卸载“/etc/mtab”文件中记录的所有设备</td></tr><tr><td>-F</td><td>强制卸载设备而不询问</td></tr><tr><td>-h</td><td>显示帮助信息</td></tr><tr><td>-n</td><td>卸载时不要将信息写入“/etc/mtab”文件中</td></tr><tr><td>-r</td><td>使用只读方式重新挂载文件系统</td></tr><tr><td>-t</td><td>仅卸载指定的文件系统</td></tr><tr><td>-v</td><td>显示执行过程详细信息</td></tr><tr><td>-V</td><td>显示版本信息</td></tr></tbody></table>

```shell
# 卸载指定的文件系统并显示过程
umount -v /dev/sdb
```

### mountpoint

- <span name="mountpoint"><code>mountpoint</code></span>：查看指定目录是否为挂载点

```shell
mountpoint /
```

### <span name="/etc/fstab">/etc/fstab</span>

- `/etc/fstab`：自动挂载文件，在该文件内设置的挂载点和设备会在系统启动时自动挂载 

```shell
# 测试/etc/fstab配置
sudo findmnt --verbose --verify

# 挂载/etc/fstab内的新配置
sudo mount -a
```

<img src="../../pictures/Snipaste_2022-11-29_00-08-22.png" width="850"/> 

<table>
    <tr>
        <td width="20%" rowspan="2">device</td>
        <td width="80%" colspan="2">UUID或文件系统标签；不要使用/dev名称，该类名称不唯一且会改变</td>
    </tr>
    <tr><td colspan="2"><code>lsblk -o UUID,LABEL</code></td></tr>
    <tr>
        <td>mountpoint</td>
        <td colspan="2">挂载点</td>
    </tr>
    <tr>
        <td>type</td>
        <td colspan="2">文件系统类型，设置为<code>auto</code>可自动检测文件系统类型</td>
    </tr>
    <tr>
        <td rowspan="15">options</td>
        <td colspan="2">挂载选项列表，定义权限，逗号分割</td>
    </tr>
    <tr><td>defaults</td><td>默认选项，包括<code>rw、suid、dev、exec、auto、nouser、async</code>，在之后追加其他选项会覆盖默认值；或者去除default仅设置部分权限</td></tr>
    <tr><td>rw</td><td>读写</td></tr>
    <tr><td>ro</td><td>只读</td></tr>
    <tr><td>suid</td><td>允许setuid、setgid 位操作</td></tr>
    <tr><td>dev</td><td>块设备和字符设备</td></tr>
    <tr><td>exec</td><td>允许二进制文件运行</td></tr>
    <tr><td>auto</td><td>指定哪些文件系统应在引导时启动</td></tr>
    <tr><td>nouser</td><td>非root用户不能挂载或卸载文件系统</td></tr>
    <tr><td>async</td><td>异步I/O，Linux的标准模式</td></tr>
    <tr><td>user</td><td>非root用户可以挂载或卸载自己的设备</td></tr>
    <tr><td>users</td><td>任何用户都可以挂载或卸载设备</td></tr>
    <tr><td>noauto</td><td>禁止在启动时自动挂载</td></tr>
    <tr><td>noatime</td><td>不更新文件的“time accessed”属性，以提供性能（只提高一点点）</td></tr>
    <tr><td>gid</td><td>仅限指定的组可以访问</td></tr>
    <tr>
        <td rowspan="2">dump</td>
        <td colspan="2">备份设置</td>
    </tr>
    <tr>
        <td colspan="2"><code>0</code>：不进行备份；<code>1</code>：每天备份一次；<code>2</code>每两天备份一次；以此类推</td>
    </tr>
    <tr>
        <td rowspan="3">pass</td>
        <td colspan="2">文件系统检查器<code>fsck</code>在启动时首先检查哪个文件系统</td>
    </tr>
    <tr><td colspan="2"><code>0</code>：不运行检查；<code>1</code>：每次都运行检查；<code>2</code>：仅在非正常关机、达到最大加载次数、一定天数后运行检查</td></tr>
    <tr><td colspan="2">推荐设置：根文件系统 1，任何其他Linux文件系统 2，非Linux文件系统 0</td></tr>
</table>

## 调整文件系统大小

- 扩展文件系统：

1. 文件系统Ext4、XFS、Btrfs，允许在离线或在线时扩展；而文件系统FAT16/32只能离线且必须卸载之后再调整大小
2. 必须确保分区末尾有可用空间

```shell
# Ext4
sudo resize2fs /dev/sdc

# XFS
sudo xfs_growfs -d /dev/sdc

# Btrfs
sudo btrfs filesystem resize max /dev/sdc

# FAT16/32，必须先卸载
sudo fatresize -i /dev/sdc
```

- 缩小文件系统：

1. XFS文件系统只能扩展而不能缩小；Ext4、FAT16/32缩小前必须先卸载；Btrfs可以在线缩小
2. 必须确保文件系统已使用的空间小于收缩后的大小；为保存元数据、浪费的块空间以及以防万一，需要留出大约40%的空间，即 `已使用空间 * 1.4`
3. 若分区位于外部设备，则先卸载；若分区属于正在运行的系统，则必须从可引导的救援磁盘上运行parted，或通过另一个启动的Linux来执行

## tune2fs

- `tune2fs`：调整/查看磁盘的文件系统参数

## mkfs

- mkfs（make file system）：对设备进行格式化文件系统操作

<table><tbody><tr><td>-c</td><td>检查指定设备是否损坏</td></tr><tr><td>-t</td><td>设置档案系统的模式</td></tr><tr><td>-V </td><td>显示执行过程详细信息</td></tr><tr><td>--help</td><td>显示帮助信息</td></tr><tr><td>--version</td><td>显示版本信息</td></tr></tbody></table>

```shell
# 查看当前系统中支持mkfs的文件系统格式
ls -l /usr/sbin/mkfs.*

# 对指定的硬盘进行格式化文件系统操作，并输出详细过程信息
sudo mkfs -V -t xfs /dev/sdb
```

## e2label ntfs格式、ext2/3/4格式

# 磁盘分区

## Linux磁盘分区

- Linux的所有文件和目录都存在于根分区/中，Linux系统中的每一个硬件设备都映射到系统的一个文件；且Linux上的磁盘总是以`/dev`（device）为根目录
- 硬盘分区类型主要有：主分区、扩展分区、逻辑分区。每一个硬盘设备最多只能由4个主分区构成，任何一个扩展分区都要占用一个主分区号码（主分区和扩展分区数量最多为4），占用分区号1~4。当分区数量大于4时，要用到扩展分区和逻辑分区。先划分扩展分区，再在扩展分区的基础上建立逻辑分区。在进行系统分区时，主分区一般设置为激活状态，用于在系统启动时引导系统。分区时，每个分区的大小可以由用户指定。
- 每个分区可以有不同的文件系统

### [分区方案](./文件管理.md)

<table>
    <tr>
        <th width="20%">目录</th>
        <th width="80%">建立单独分区的优势</th>
    </tr>
    <tr>
        <td>/boot</td>
        <td>更轻松的管理多重启动系统；引导文件不依赖于安装或删除的操作系统</td>
    </tr>
    <tr>
        <td>/home</td>
        <td>与根文件系统隔离，重装时可不影响/home，甚至可以在单独的驱动器</td>
    </tr>
    <tr>
        <td>/var、/tmp</td>
        <td>防止进程失控时占用大量空间而影响到其他文件系统</td>
    </tr>
    <tr>
        <td>swap</td>
        <td>可启用挂起到磁盘的功能</td>
    </tr>
</table>

### 分区表

#### MSDOS

- MSDOS

#### GPT

- GPT（Globally Unique Identifier Partition Table，GUID分区表）：UEFI（Unified Extensible Firmware Interface，统一可扩展固件接口）规范的一部分，UEFI替代老旧的BIOS（Basic Input Output System）

1. 分区最多可达128个，编号为`1~128`，不需要区分主分区和扩展分区
2. 容错性，多个位置都保存了分区表的副本
3. 磁盘和分区拥有唯一的ID
4. 支持传统的BIOS/MBR引导模式
5. 可验证自身的完整性和分区表
6. 支持安全引导

## du

- `du`：显示某个指定目录下的磁盘使用情况

## df

- df（report file system disk space usage）：显示的磁盘使用量情况含可用、已用及使用率等信息，默认单位为KB。

<table><tbody><tr><td>-a<strong></strong></td><td>显示所有文件系统</td><td rowspan="5"><strong>&nbsp;</strong></td><td>-l<strong></strong></td><td>只显示本地文件系统 </td></tr><tr><td>-h<strong></strong></td><td>以更易读的方式显示<strong></strong></td><td>-t</td><td>只显示指定类型文件系统 <strong></strong></td></tr><tr><td>-H<strong></strong></td><td>以1KB=1000B为换算单位</td><td>-T<strong></strong></td><td>显示文件系统的类型<strong></strong></td></tr><tr><td>-i</td><td>显示索引字节信息<strong></strong></td><td>--sync <strong></strong></td><td>在获取磁盘使用信息前先执行sync同步命令</td></tr><tr><td>-k<strong></strong></td><td>设置显示时的块大小<strong></strong></td><td>&nbsp;</td><td><strong>&nbsp;</strong></td></tr></tbody></table>

```shell
# 显示系统全部磁盘的使用量情况（带容量单位）
df -h
```

## fdisk

- fdisk：固定磁盘（fixed disk）或格式化磁盘（format disk），管理磁盘的分区信息。

<table><tbody><tr><td>-b</td><td>设置每个分区的大小</td><td rowspan="5">&nbsp;</td><td>-l</td><td>显示指定的外围设备分区表状态</td></tr><tr><td>-c</td><td>关闭DOS兼容模式</td><td>-s</td><td>显示指定的分区大小</td></tr><tr><td>-C</td><td>设置硬盘的柱面数量</td><td>-S</td><td>设置每个磁道的扇区数</td></tr><tr><td>-h</td><td>显示帮助信息</td><td>-u</td><td>以分区数目代替柱面数目</td></tr><tr><td>-H</td><td>设置硬盘的磁头数</td><td>-v</td><td>显示版本信息</td></tr></tbody></table>

## parted

- <code>parted</code>：管理分区，会立即应用更改

```shell
# 进入交互模式
parted

# 对指定的磁盘设备/dev/sda操作
parted /dev/sda

# 执行命令而不是进入交互
parted parted命令
```

### parted交互模式

#### print

- `print`：打印磁盘设备的信息

```shell
# 查看所有磁盘设备的所有信息
print all

# 查看空闲空间
print free
```

```shell
GNU Parted 3.3
Using /dev/mmcblk0
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) print all                                                        
Model: SD SD32G (sd/mmc) # 设备制造商的名称
Disk /dev/mmcblk0: 30.9GB # 设备名称和大小
Sector size (logical/physical): 512B/512B # 逻辑块和物理块大小
Partition Table: msdos # 分区类型 msdos/gpt
Disk Flags:  # 标志

Number  Start   End     Size    Type     File system  Flags
 1      1049kB  269MB   268MB   primary  fat32        boot, lba
 2      269MB   30.9GB  30.7GB  primary  ext4
```

#### mkpart

- `mkpart`：创建分区

1. 创建新分区的起点不能从0开始，因为前33个扇区是为EFI标签保留的
2. 两个分区的起点和终点不应该离太近
3. 新分区必须在建立文件系统后使用

```shell
# 卸载设备
sudo unmount /dev/sdc

# 新建分区表 gpt/msdos，同时会擦除磁盘上的所有数据
sudo parted /dev/sdc
mklabel gpt

# 创建分区 mkpart name fs-type start end ；该步骤并没有创建文件系统，其中的fs-type只是标记
mkpart "images" ext4 1MB 2004MB
mkpart "audio files" xfs 2005MB 100%
```

#### rm

- `rm`：删除分区以及文件系统，删除分区时，如果分区内的文件正在使用，且无视警告继续删除，则这些文件会被保存在内存

```shell
# 序号删除（number）
rm 2
```

#### rescue

- `rescue`：恢复分区，指定分区近似的起点和终点位置来恢复

```shell
rescue 1MB 2004MB
```

#### resizepart

- `resizepart`：调整分区大小

```shell
# 按序号调整至指定终点，并没有同步扩展文件系统
resizepart 2 4010MB
```

## lsblk

- `lsblk`（list block devices）：查看系统的磁盘使用情况

<table><tbody><tr><td width="5%">-a</td><td width="42.5%">显示所有设备信息</td><td rowspan="7" width="5%">&nbsp;</td><td width="5%">-m</td><td width="42.5%">显示权限信息</td></tr><tr><td>-b</td><td>显示以字节为单位的设备大小</td><td>-n</td><td>不显示标题</td></tr><tr><td>-e</td><td>排除指定设备</td><td>-o</td><td>输出列信息</td></tr><tr><td>-f</td><td>显示文件系统信息</td><td>-P</td><td>使用key=value格式显示信息</td></tr><tr><td>-h</td><td>显示帮助信息</td><td>-r</td><td>使用原始格式显示信息</td></tr><tr><td>-i</td><td>仅使用字符</td><td>-t</td><td>显示拓扑结构信息</td></tr><tr><td>-l</td><td>使用列表格式显示</td><td>-V</td><td>显示版本信息</td></tr></tbody></table>

```shell
# 仅查看设备名和文件系统类型
lsblk -o NAME,FSTYPE
```

## ntfslabel 磁盘分区改名

# <span name="磁盘IO监控">系统IO监控</span>

## iostat 磁盘活动统计

- iostat：汇报磁盘活动统计情况、CPU使用情况。

```shell
# iostat -x /dev/sda1
Linux 3.10.0-693.el7.x86_64 (bogon)     12/12/2022      _x86_64_        (12 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.01    0.00    0.03    0.00    0.00   99.96

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda1              0.00     0.00    0.18    0.00     0.56     0.20     8.34     0.00    0.13    0.12    3.00   0.12   0.00
```

