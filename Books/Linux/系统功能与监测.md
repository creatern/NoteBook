# 服务单元控制

| 文件扩展名               | 类型                          |
| ------------------------ | ----------------------------- |
| \.device                 | 能被内核识别的设备            |
| \.service                | 系统服务                      |
| \.target                 | 一组系统服务（Linux启动相关） |
| \.mount<br />\.automount | 挂载点<br />自动挂载点        |
| \.path                   | 文件系统的文件/目录           |
| \.scope                  | 外部创建的进程                |
| \.slice                  | 一组分层次管理的系统进程      |
| \.snapshot               | 系统服务状态管理              |
| \.socket                 | 进程间通讯套接字              |
| \.swap                   | 定义swap文件、swap设备        |
| \.timer                  | 定时器                        |

## 服务单元控制命令 systemctl、systemd

| **运行级别**                                               | **说明**                                                     |
| ---------------------------------------------------------- | ------------------------------------------------------------ |
| systemctl set-default                                      | 更改默认运行级别，重启后生效<br />（/etc/systemd/ssytem/default.target 的指向） |
| systemctl rescue                                           | 紧急模式                                                     |
| **服务单元**                                               | **说明**                                                     |
| systemctl start<br />systemctl restart<br />systemctl stop | 启动服务<br />重新启动服务<br />停止服务                     |
| systemctl enable<br />systemctl disable                    | 设置开机自启动<br />禁止开机自启动                           |
| systemctl status                                           | 查看服务当前状态                                             |
| **电源控制**                                               | **说明**                                                     |
| systemctl poweroff                                         | 关机                                                         |
| systemctl reboot                                           | 重启                                                         |
| systemctl suspend                                          | 待机                                                         |

| systemctl set-default参数 | 指向                                      | 运行级别 |
| :------------------------ | :---------------------------------------- | :------- |
| default.target            | /etc/systemd/system/default.target        | -        |
| multi-user.target         | /usr/lib/systemd/system/multi-user.target | 3        |
| graphical.target          | /usr/lib/systemd/system/graphical.target  | 5        |

## /etc/systemd/system 单元配置文件

| 存放位置                | 说明                             |
| ----------------------- | -------------------------------- |
| /usr/lib/systemd/system | 软件包安装的单元                 |
| /etc/systemd/system     | 系统管理员安装的与系统密切的单元 |

# 运行级别

<img src="../../pictures/Linux-Linux启动运行级别202310121316.drawio.svg" width="600"/> 

<img src="../../pictures/Snipaste_2022-12-01_16-14-09.png" width="800"/> 

<img src="../../pictures/Snipaste_2022-12-01_16-13-01.png" width="700"/> 

## runlevel 当前用户运行级别

## init 系统运行级别

- init：改变系统运行级别。init进程是所有Linux进程的父进程，它的进程号为1。

## /etc/inittab init配置文件

# 进程管理

| 进程       | 说明                                                         |
| :--------- | :----------------------------------------------------------- |
| 交互进程   |                                                              |
| 批处理进程 |                                                              |
| 守护进程   | 系统开机时通过脚本自动激活启动或root用户启动。<br />后台运行，一直运行。<br />等待请求处理任务。 |

| 进程属性 | 说明                                               |
| :------- | :------------------------------------------------- |
| PID      | 进程ID，唯一值，区分进程                           |
| PPID     | 父进程和父进程的PID                                |
| UID、GID | 启动进程的用户ID和所归属的组ID                     |
| 进程状态 | R（运行）、S（休眠）、Z（僵尸）                    |
| 其他     | 进程执行的优先级、进程所连接的终端名、进程资源占用 |

| 参数 | 进程状态                             |
| ---- | ------------------------------------ |
| D    | 不能被中断                           |
| R    | 运行中、在队列中可过行的             |
| S    | 休眠                                 |
| T    | 停止、或被跟踪                       |
| W    | 进入内存交换（内核2.6之后失效）      |
| X    | 死亡                                 |
| Z    | 僵尸（进程完成了，但父进程没有响应） |
| &lt; | 优先级较高                           |
| N    | 优先级较低                           |
| L    | 部分页被锁进内存                     |
| S    | 进程的领导者（拥有子进程）           |
| L    | 多个进程的宿主                       |
| \+   | 后台                                 |

## 进程状态检测

### ps 静态进程监视

- ps：进程监视，报告当前系统的进程状态（非动态）

<img src="../../pictures/Snipaste_2022-12-03_14-55-49.png" width="1100"/>

### top 实时状态监视

- top：系统实时状态监视，动态交互命令，默认每5秒刷新一次。

<img src="../../pictures/Snipaste_2022-12-03_15-20-11.png" width="1000"/>

- 应用程序实际占用的内存：MemTotal - MemFree - Buffer - Cached (KB)而不是MemUsed。

## sleep 睡眠

- 进程没有置入后台时，在当前的CLI睡眠，直到该进程睡眠结束才可以在该DLI上输入下一个命令。睡眠结束时，若进程在后台，则直接恢复到前台。

## coproc 协程

- coproc（协程）：同时处理两件事情，后台生成一个子shell并在该子shell中执行命令。

```shell
coproc 进程名 { 命令; 命令; }
```

## 前台进程、后台进程

| 进程     | 前台     | 后台            |
| -------- | -------- | --------------- |
| 终端窗口 | 占用     | 不占用          |
| 启动     | 正常启动 | 启动命令加上`$` |

| 命令 | 说明                       |
| ---- | -------------------------- |
| jobs | 获取当前存在的进程的作业号 |
| bg   | 从前台进程切换到后台       |
| fg   | 从后台进程切换到前台       |

- Ctrl + Z 让正在执行的前台进程暂停。

## kill、killall 终止进程

- 当父进程被终止时，子进程也被终止；而子进程的终止不会导致父进程的终止。只有进程的属主、root用户可以杀死该进程。

| 命令    | 说明                         |
| ------- | ---------------------------- |
| kill    | 按PID杀死单个进程。          |
| killall | 按进程名杀死同名的所有进程。 |

- kill、killall命令预设终止程序的信号为SIGTERM(15)；SIGKILL(9)强制删除程序（尽量避免使用）。

## nice、renice 进程优先级

- 优先级的数值为-20\~19（负值、0是高优先级）。启动进程时，其默认优先级是0。
- 进程的优先级是父进程shell优先级的值与（nice命令）所指定优先级的值相加和。

| 命令 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| nice | 创建进程时指定进程的优先级。<br />指定的并不就是该进程的优先级，而是一个增量。 |

- 指定优先级时：`nice -19 进程`表示优先级是19而不是-19，如果要-19则：`nice --19 进程`；也可以使用`nice -n -19 进程`表示-19。

# 防火墙

- Linux内核的防火墙由netfiter框架实现。

## netfiter框架

- netfiter的通用框架不依赖于具体的协议，而是为每种网络协议定义一套**钩子函数**。在数据包经过协议栈的几个关键点时，调用这些钩子函数，同时协议栈将数据包和钩子函数作为参数传递给netfiter框架。对于每种网络协议定义的钩子函数，任何内核模块可以对每种协议的一/多个钩子函数进行注册，实现**挂接**。

> 当某个数据包被传递给netfiter框架时，内核能检测到是否有相关模块对该协议和钩子函数进行了注册，若发现注册信息，则调用该模块注册时使用的回调函数，然后对应模块去检查、修改、丢弃该数据包并指示netfiter将该数据包传入用户空间的队列。

<img src="../../pictures/Linux-数据包通信步骤2023101122131.drawio.svg" width="500"/>

| 钩子函数           | 说明                                                         |
| ------------------ | ------------------------------------------------------------ |
| NF_IP_PRE_ROUTING  | 所有进入该系统的数据报都要由该函数处理。<br />是否替换IP包的目的地址（DNAT）。 |
| NF_IP_LOCAL_IN     | 所有发送给本机的数据报都要由该函数处理。                     |
| NF_IP_FORWARD      | 所有不是发给本机的数据报都要由该函数处理。                   |
| NF_IP_LOCAL_OUT    | 所有从本地进程发出的数据报都要由该函数处理。                 |
| NF_IP_POST_ROUTING | 所有发送给其他主机的数据报都要由该函数处理。<br />是否替换IP包的源地址（SNAT）。 |

### 包过滤

- 每个函数都可以对数据包进行处理，最基本的操作就是对数据包进行过滤。root用户可以通过iptables工具向内核模块注册多个过滤规则，并且指明过滤规则的优先权，每个钩子函数按照规则进行匹配，如果匹配则执行过滤操作。

| 过滤操作   | 说明                   |
| :--------- | :--------------------- |
| NF\_ACCEPT | 继续正常地传送包       |
| NF\_DROP   | 丢弃包，停止传送       |
| NF\_STOLEN | 已经接管包，不继续传送 |
| NF\_REPEAT | 再次使用该钩子函数     |

### 包选择

- 在netfiter框架上已经创建了一个包选择系统，这个包选择工具默认注册了3个表：过滤filter表、网络地址转换NAT表：mangle表。

<img src="../../pictures/Snipaste_2022-12-12_19-42-30.png" width="600"/> 

- 在调用钩子函数时，按照如上的顺序来调用需要的表。
- 包过滤表只是过滤包，而不改变包，实际中由网络过滤框架来通过NF\_IP\_FORWARD钩子的输入和输出接口。NF\_IP\_LOCAL\_IN和NF\_IP\_LOCAL\_OUT也可以过滤，但只对本机。
- NAT表分别服务于两套不同的网络过滤挂钩的包，对于非本地包，NF\_IP\_PRE\_ROUTING和NF\_IP\_POST\_ROUTING挂钩可以很好地解决源地址和目标地址的变更问题。
- NAT表与Filter表的区别在于NAT表只有新建连接的第一个包会在表中传送，结果将被用于以后所有来自这一连接的包。如：某一连接的第一个数据包在这个表中被替换了源地址，则接下来的这条连接的所有包都将被替换源地址。
- Mangle表用于真正改变包的信息，Mangle表和所有的5个网络过滤的钩子都有关。

## firewalld

### Zone 防火墙区域/网络区域

- Zone：防火墙区域/网络区域，是一系列可以被快速执行到网络接口的预设置。一个网络接口只能与一个网络区域对应。当数据包进入区域后，防火墙会依据区域内的规则进行逐一过滤，只有符合规则的数据包才能通过区域到达本机应用。

<img src="../../pictures/Snipaste_2022-12-12_19-52-57.png" width="630"/> 

| 区域（从信任到不信任）  | 说明                                                         |
| :---------------------- | :----------------------------------------------------------- |
| trusted （信任）        | 信任所有的网络连接                                           |
| internal （内部网络）   | 企业等的内部网络<br />基本信任内部网络中的计算机不会威胁计算机安全 |
| home （家庭网络）       | 基本信任家庭网络中的计算机不会危害计算机安全                 |
| work （工作网络）       | 基本信任工作网络中的计算机不会危害计算机的安全               |
| dmz （非军事区/隔离区） | 此区域内的电脑可以公开访问，可以有限的进入内部网络           |
| external  （外部网络）  | 通常是使用了伪装的外部网络<br />该区域内的计算机可能会危害计算机安全 |
| public （公共区域）     | 在公共区域使用，<br />该区域内的计算机可能会危害计算机安全   |
| block （阻塞/拒绝）     | 任何进入的网络连接都会被拒绝，并返回IPv4/IPv6的拒绝报文      |
| drop （丢弃）           | 任何进入的网络连接都会被丢弃，没有任何回复                   |

- 无论处于哪个区域，防火墙都不会拒绝由本机主动发起的网络连接，即：本地发起的数据包（包含对方响应或返回的数据包）将通过该区域。虽然这些区域已经有所描述，但实际通行规则由区域内的规则决定，最终决定连接是否被放行的是规则而不是区域的描述。

### firewalld（firewall-cmd、firewall-config）

- firewall-cmd是firewalld的字符界面管理工具。firewalld支持动态更新，不用重启服务，可以动态修改单条规则。
- firewalld自身并不具备防火墙的功能，需要通过内核的netfilter来实现。

# 磁盘分区

- Linux的所有文件和目录都存在于根分区/中，Linux系统中的每一个硬件设备都映射到系统的一个文件。

> **硬盘分区类型主要有：主分区、扩展分区、逻辑分区。**
>
> 每一个硬盘设备最多只能由4个主分区构成，任何一个扩展分区都要占用一个主分区号码（主分区和扩展分区数量最多为4），占用分区号1~4。当分区数量大于4时，要用到扩展分区和逻辑分区。先划分扩展分区，再在扩展分区的基础上建立逻辑分区。在进行系统分区时，主分区一般设置为激活状态，用于在系统启动时引导系统。分区时，每个分区的大小可以由用户指定。

| 命令                   | 说明                                                         |
| ---------------------- | ------------------------------------------------------------ |
| df                     | 显示每个有数据的已挂载文件系统（当前值）。                   |
| du                     | 显示某个指定目录下的磁盘使用情况。                           |
| tune2fs                | 调整/查看磁盘的文件系统参数                                  |
| fdisk                  | 磁盘管理                                                     |
| parted                 | 磁盘管理                                                     |
| lsblk                  | 磁盘管理                                                     |
| mkfs                   | 格式化文件系统。<br />查看当前系统中支持mkfs的文件系统格式：`ls -l /usr/sbin/mkfs.* ` |
| mount                  | 挂载/卸载文件系统                                            |
| umount                 | 卸载                                                         |
| lsof                   | 获取使用指定文件的进程                                       |
| ntfslabel<br />e2label | 磁盘分区改名<br />ntfs格式、ext2/3/4格式                     |

## 挂载/卸载文件系统

### mount 挂载/卸载文件系统

- 虚拟目录挂载点通常是在/mnt中新建一个目录来挂载。

<img src="../../pictures/Snipaste_2022-11-29_00-08-22.png" width="850"/> 

### /etc/fstab 挂载文件

## 磁盘分区管理

### fdisk

# 网络管理

## 网络状态

### ping 连通性

- ping：测试主机之间网络的连通性（ICMP传输协议）。

### netstat 网络状态

- netstat：查看当前主机的所有详细的网络信息。

## IP 网卡配置

| 配置工具 | 说明                                |
| -------- | ----------------------------------- |
| ifconfig | 配置和显示Linux系统网卡的网络参数。 |
| ifdown   | 禁用指定的网络接口。                |

### ifconfig 网络接口参数

```
wlp1s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.22.175.88  netmask 255.255.0.0  broadcast 10.22.255.255
        inet6 fe80::77bc:d47b:c023:d7aa  prefixlen 64  scopeid 0x20<link>
        ether 48:e7:da:0e:38:f7  txqueuelen 1000  (Ethernet)
        RX packets 6769  bytes 7814090 (7.8 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 4049  bytes 401429 (401.4 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

| 特殊网络接口 | 说明                         |
| ------------ | ---------------------------- |
| lo           | 主机回环地址                 |
| virbr0       | 虚拟桥接网络，主要用于虚拟机 |
| docker0      | docker网络                   |

```
flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
```

| flags参数 | 标识                   |
| --------- | ---------------------- |
| LOOPBACK  | 回环地址               |
| UP        | 网络接口处于启用状态   |
| RUNNIG    | 网卡设备处于连接状态   |
| BROADCAT  | 支持广播               |
| MULTICAST | 支持组播               |
| **mtu**   | **数据包最大传输单元** |

```
inet 10.22.175.88  netmask 255.255.0.0  broadcast 10.22.255.255
inet6 fe80::77bc:d47b:c023:d7aa  prefixlen 64  scopeid 0x20<link>
```

| IPv4地址信息     | 说明     |
| ---------------- | -------- |
| inet             | IPv4地址 |
| netmask          | 子网掩码 |
| broadcast        | 广播地址 |
| **IPv6地址信息** | **说明** |
| inet6            | IPv6地址 |
| prefixlen        |          |
| scopeid          |          |

```
ether 48:e7:da:0e:38:f7  txqueuelen 1000  (Ethernet)
```

| MAC 硬件地址    | 说明                                               |
| --------------- | -------------------------------------------------- |
| ether<br />loop | Ethernet（以太网）<br />Local Loopback（本地环回） |
| txqueuelen      |                                                    |

```
RX packets 6769  bytes 7814090 (7.8 MB)
RX errors 0  dropped 0  overruns 0  frame 0
TX packets 4049  bytes 401429 (401.4 KB)
TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

| 数据包信息 | 说明                                                 |
| ---------- | ---------------------------------------------------- |
| RX packets | 接收数据包情况统计                                   |
| RX errors  | 接收数据包异常情况统计                               |
| TX packets | 发送数据包情况统计                                   |
| TX errors  | 发送数据包异常情况统计<br />collisions：发送冲突次数 |

### 网络配置文件

#### /etc/sysconfig/network\-scripts/ifcfg\-\* 网络接口文件

- 网络接口文件：设置网卡参数，`*`为网卡编号/回环网卡，配置IP地址，修改之后需要重启网络服务才开始生效。

> /etc/sysconfig目录仅rpm系的Linux系统使用。

#### /etc/resolv\.conf 域名解析文件

- 域名解析文件：设置DNS的相关信息，用于将域名解析到IP。

#### /etc/hosts 主机名查询静态表

- 主机名查询静态表：定义IP地址和主机名的映射关系。输入域名时，系统会先从hosts文件中寻找对应的IP地址，若没有找到，才将域名发送到DNS服务器进行IP地址解析。

##### /etc/hostname 主机名文件

- /etc/hostname：修改主机名称（hostname指令），修改完主机名后，还需要修改相应的/etc/hosts文件，使主机能够顺利地解析该主机名。

#### /etc/nsswitch\.conf 名字服务切换配置文件

- 名字服务切换配置文件：设置DNS解析优先还是本地设置优先等。

#### /etc/sysconfig/network 默认网关

```shell
# 该文件在重启network服务后生效
systemctl restart network
```

## 路由

| 命令       | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| route      | 显示/添加/修改路由器（主要是静态路由）                       |
| traceroute | 追踪数据包在网络上的传输时的全部路径，默认发送的数据包大小是40字节。 |

### route 路由器配置

```
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         _gateway        0.0.0.0         UG    600    0        0 wlp1s0
10.22.0.0       0.0.0.0         255.255.0.0     U     600    0        0 wlp1s0
link-local      0.0.0.0         255.255.0.0     U     1000   0        0 wlp1s0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
```

| route信息   | 说明             |
| ----------- | ---------------- |
| Destination | 目标             |
| Gateway     | 无网关           |
| Genmask     | 子网掩码         |
| Flags       | 路由标识         |
| Metric      | 跃点数           |
| Ref         | 引用             |
| Use         | 使用             |
| Iface       | 网络接口（网卡） |

| Flags参数 | 标识                                                 |
| --------- | ---------------------------------------------------- |
| U         | UP，此路由处于启动状态。                             |
| \!        | 此路由处于关闭状态                                   |
| H         | Host，此网关是一个主机。                             |
| G         | Gateway，此网关是一个路由器。                        |
| R         | Reinstate Route，动态路由重新初始化的路由            |
| D         | Dynamically，此路由是动态写入的。                    |
| M         | Modified，此路由是路由守护进程、或导向器动态修改的。 |

### ip rule 路由策略

- Linux系统负责维护4个路由表（0、253、254、255）。RHEL系统中最多可以同时存在256个路由表（0\~255），每个路由表都各自独立，数据包传输时根据路由策略数据库中的策略决定数据包应该由哪个路由表传输。

| 路由表             | 说明                                                         |
| ------------------ | ------------------------------------------------------------ |
| 0号表（unspec）    | 系统保留表。                                                 |
| 253号表（default） | 默认路由表，一般，默认的路由都存放在253号表。                |
| 254号表（main）    | 主路由表，若没有指明路由所属的表，则所有的路由都默认放在这个表。 |
| 255号表（local）   | 本地路由表，由系统自动维护，管理员不能直接修改。<br />存放本地接口地址、广播地址、NAT地址。 |

### /etc/iproute2/rt\_tables 路由表文件

```shell
cat /etc/iproute2/rt_tables
255     local
254     main
253     default
0       unspec
```

## 端口

# 日志与计划任务

## 日志系统

### /var/log 日志目录

- Linux日志一般放在/var/log下，需要root用户权限。

| 日志类型     | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| 系统连接日志 | 记录系统的登录记录和用户名，写录到/var/log/wtmp、/var/log/utmp |
| 进程统计     | 系统内核执行，当一个进程终止时为每个进程往进程统计文件中写一个记录 |
| 错误日志     | 各种系统守护进程、用户程序和内核，通过syslog向/var/log/messages写录 |

| /var/log   | 说明                                       |
| :--------- | :----------------------------------------- |
| btmp       | 记录失败的记录                             |
| syslog     | 从syslog中记录信息                         |
| wtmp       | 一个用户每次登录和退出时间的永久记录       |
| lastlog    | 记录最后一次失败的登录和最近几次成功的登录 |
| dmesg      | Linux系统启动信息                          |
| **rpm系**  | **说明**                                   |
| messages   | 服务器的系统日志                           |
| access-log | 记录Web服务访问日志，错误信息存于error-log |
| acct/pacct | 记录用户命令                               |
| sudolog    | 记录使用sudo发出的命令                     |
| sulog      | 记录su命令的使用                           |
| secure     | 记录系统登录行为                           |
| utmp       | 记录当前登录的每个用户                     |

### 日志命令

#### 用户登录信息

##### who、w 当前登录的用户

- who、w：显示目前登录系统的用户信息（/var/log/wtmp）。

##### users 当前登录的所有用户

- users：显示当前登录系统的所有用户。如果一个用户有不止一个登录会话，那他的用户名将显示相同的次数。

##### last 目前与过去登录的用户

- last：列出目前与过去登录系统的用户相关信息（/var/log/wtmp）。

#### dmesg 启动信息

- dmesg：显示Linux系统启动信息，检查和控制内核的环形缓冲区。（开机信息保存在/var/log/dmesg文件）

### /etc/rsyslog.conf 日志系统

```shell
# 服务1.优先级;服务2.优先级    操作动作
*.info;mail.none  /var/log/messages
```

| 日志设备       | 功能                              |
| -------------- | --------------------------------- |
| auth           | pam\_pwdb报告的认证活动           |
| authpriv       | 包括特权信息在内的认证活动        |
| cron           | 与cron、at相关的计划任务信息      |
| daemon         | 与inetd守护进程相关的后台进程信息 |
| kern           | 内核信息，先通过klogd传递         |
| lpr            | 与打印服务有关的信息              |
| mail           | 与电子邮件有关的信息              |
| mark           | syslog内部功能，用于生成时间戳    |
| news           | 来自新闻服务器的信息              |
| syslog         | syslog生成的信息                  |
| user           | 用户程序生成的信息                |
| uucp           | uucp生成的信息                    |
| local0\~local7 | 自定义程序使用                    |

| 优先级限定符 | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| \*           | 服务生成的所有日志消息都发送到操作动作指定的地点。           |
| =            | 服务生成的本优先级的日志消息都发送到操作动作指定的地点。     |
| \!           | 服务生成的所有日志消息都发送到操作动作指定的地点，但本优先级的消息不包括在内。 |

- 操作动作：每条消息都会经过所有的规则，并非唯一匹配的。

<img src="../../pictures/Snipaste_2022-11-29_19-52-55.png" width="700"/> 

### /etc/logrotate.conf 日志轮转

- /etc/logrotate.conf：对系统日志进行轮转、压缩、删除、发送到指定邮箱。每个记录文件都可被设置成每日/周/月处理、或文件太大时处理。用户自定义日志配置文件（/etc/logrotate.d）。

```shell
# rotate log files weekly 每周轮转
weekly

# keep 4 weeks worth of backlogs 保存过去四周的文件
rotate 4

# create new (empty) log files after rotating old ones 轮转以后创建新的空白日志文件
create

# use date as a suffix of the rotated file 轮转的文件以日期结尾
dateext

# uncomment this if you want your log files compressed 如果需要对轮转后的日志压缩，去掉此行注释
# compress

# RPM packages drop log rotation information into this directory 其他配置存放的文件目录;即用户自定义的配置
include /etc/logrotate.d

# no packages own wtmp and btmp -- we'll rotate them here 一些系统日志的轮转规则
/var/log/wtmp {
    monthly
    create 0664 root utmp
        minsize 1M
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}

# system-specific logs may be also be configured here.
```

#### /etc/logrotate.d 自定义配置轮转

<img src="../../pictures/Snipaste_2022-11-29_20-11-41.png" width="800"/> 

```shell
# 测试轮转：无error日志，则正常生成轮转配置文件。
/user/sbin/logrotate -vf /etc/logrotate.conf
```

## 计划任务

### at 定时任务

| 命令 | 说明                           |
| ---- | ------------------------------ |
| at   | 在指定时间执行任务，只执行一次 |
| atq  | 显示当前所有定时任务           |
| atrm | 删除指定序号的定时任务         |

| 指定时间的格式 | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 绝对计时法     | 当天的hh:mm。若该时间已过去，那么就放在第二天执行。<br />midnight（深夜），noon（中午），teatime（一般是下午4点）等比较模糊的词语来指定时间。<br />12小时计时制，时间后面加上AM（上午）、PM（下午）。<br />具体日期，指定格式为month day、mm/dd/yy、dd.mm.yy。指定的日期必须跟在指定时间的后面。 |
| 相对计时法     | now + count time-units：now当前时间、time-units是时间单位 minutes（分钟）、hours（小时）、days（天）、weeks（星期）、count是时间的数量，究竟是几天，还是几小时，等等。<br />直接使用today（今天）、tomorrow（明天）。 |

```shell
[root@localhost ~]# at 23:43 today
at> date >/root/today.log            
at> <EOT>
job 3 at Sun Nov 27 23:43:00 2022
```

```shell
[root@localhost ~]# atq
4       Wed Nov 30 08:40:00 2022 a root
```

### crontab 周期任务

- crontab：提交和管理用户需要周期性执行的任务。默认会安装此服务工具，并自动启动crond进程，crond进程每分钟会定期检查是否有要执行的任务，如果有要执行的任务，则自动执行该任务。

```shell
crontab [选项] [crontab 的任务列表文件]
```

#### 任务调度

##### 系统任务调度 /etc/crontab

- 系统任务调度的配置文件`/etc/crontab`：系统周期性所要执行的工作，比如写缓存数据到硬盘、日志清理等。

```shell
[root@localhost etc]# ll | grep cron
-rw-------.  1 root root      541 Mar 30  2017 anacrontab
drwxr-xr-x.  2 root root       54 Nov 13 21:16 cron.d
drwxr-xr-x.  2 root root       70 Nov 13 21:16 cron.daily
-rw-------.  1 root root        0 Mar 30  2017 cron.deny
drwxr-xr-x.  2 root root       41 Nov 13 21:16 cron.hourly
drwxr-xr-x.  2 root root        6 Dec 28  2013 cron.monthly
-rw-r--r--.  1 root root      451 Dec 28  2013 crontab
drwxr-xr-x.  2 root root        6 Dec 28  2013 cron.weekly
```

##### 用户任务调度 /var/spool/cron

- 用户定期要执行的工作，比如用户数据备份、定时邮件提醒等。
- 所有用户定义的crontab文件都被保存在`/var/spool/cron`目录中。其文件名与用户名一致，

| 使用者权限文件   | 说明                                        |
| ---------------- | ------------------------------------------- |
| /etc/cron\.deny  | 该文件中所列用户不允许使用crontab命令       |
| /var/spool/cron/ | 所有用户crontab文件存放的目录，以用户名命名 |

```shell
# 每1分钟执行一次command
* * * * * command

# 每小时的第3和第15分钟执行
3,15 * * * * command

# 在上午8点到11点的第3和第15分钟执行
3,15 8-11 * * * command

# 每隔两天的上午8点到11点的第3和第15分钟执行
3,15 8-11 */2 * * command
# 每个星期一的上午8点到11点的第3和第15分钟执行
3,15 8-11 * * 1 command

# 每晚的21:30重启smb 
30 21 * * * /etc/init.d/smb restart

# 每月1、10、22日的4 : 45重启smb 
45 4 1,10,22 * * /etc/init.d/smb restart

# 每周六、周日的1:10重启smb
10 1 * * 6,0 /etc/init.d/smb restart

# 每天18 : 00至23 : 00之间每隔30分钟重启smb 
0,30 18-23 * * * /etc/init.d/smb restart

# 每星期六的晚上11:00 pm重启smb 
0 23 * * 6 /etc/init.d/smb restart

# 每一小时重启smb 
* */1 * * * /etc/init.d/smb restart

# 晚上11点到早上7点之间，每隔一小时重启smb
* 23-7/1 * * * /etc/init.d/smb restart

# 每月的4号与每周一到周三的11点重启smb 
0 11 4 * mon-wed /etc/init.d/smb restart

# 一月一号的4点重启smb
0 4 1 jan * /etc/init.d/smb restart

# 每小时执行/etc/cron.hourly目录内的脚本
01 * * * * root run-parts /etc/cron.hourly
```

#### crond服务进程

```shell
service crond status # 查看crond服务状态
/sbin/service crond start    # 启动服务
/sbin/service crond stop     # 关闭服务
/sbin/service crond restart  # 重启服务
/sbin/service crond reload   # 重新载入配置
ntsysv # 查看crond服务是否已经设置为开机启动
chkconfig –level 35 crond on # 加入开机自动启动
```

# 性能检测

## CPU

### 检测命令

#### uptime 负载信息

- uptime：查看Linux系统负载信息。

<img src="../../pictures/20231011231831.png" width="600"/> 

#### vmstat 虚拟内存状态

```shell
# vmstat
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 4128428   2116 428040   0    0     3     0   14   11  0  0 100 0  0
```

| vmstat参数 | 参数值 | 说明                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| **Procs**  | r      | 运行队列中进程数量，可判断是否需要增加CPU。（长期大于1）     |
|            | b      | 等待IO的进程数量。                                           |
| **Memory** | swpd   | 当前使用虚拟内存大小。<br />若swpd不为0，而si、si长期为0，并不会影响系统性能。 |
|            | free   | 空闲物理内存大小。                                           |
|            | buff   | 缓冲的内存大小。                                             |
|            | cache  | 缓存的内存大小。<br />若频繁访问到的文件都能被cache处理，则磁盘的读IO bi会非常小。 |
| **Swap**   | si     | 每秒从交换区写到内存的大小，由磁盘调入内存。                 |
|            | so     | 每秒写入交换区的内存大小，由内存调入磁盘。                   |
|            |        | 内存够用的时候，这2个值都是0。<br />若si、so长期大于0，影响系统性能，磁盘IO和CPU资源都会被消耗。 |
| **IO**     | bi     | 每秒读取的块数。                                             |
|            | bo     | 每秒写入的块数。                                             |
|            |        | 随机磁盘读写时，bi、bo越大，能看到CPU在IO等待的值也会越大。  |
| **system** | in     | 每秒中断数，包括时钟中断。                                   |
|            | cs     | 每秒上下文切换数。                                           |
|            |        | in、cs值越大，由内核消耗的CPU时间会越大。                    |
| **CPU**    | us     | 用户进程执行时间百分比（user time）。<br />值高时，说明用户进程消耗的CPU时间多。<br />若长期超50%的使用，就该考虑优化程序算法、进行加速。 |
|            | sy     | 内核系统进程执行时间百分比（system time）。<br />值高时，说明系统内核消耗的CPU资源多，非良性。 |
|            | wa     | IO等待时间百分比。<br />值高时，说明IO等待比较严重，这可能由于磁盘大量作随机访问造成，也有可能磁盘出现瓶颈（块操作）。 |
|            | id     | 空闲时间百分比                                               |

#### 系统内存状态

##### free 静态

<img src="../../pictures/20231011233307.png" width="600"/> 

<img src="../../pictures/Snipaste_2022-11-27_20-59-05.png" width="700"/> 

##### top 动态

## IO

### 监测命令

#### iostat 磁盘活动统计

- iostat：汇报磁盘活动统计情况、CPU使用情况。

```shell
# iostat -x /dev/sda1
Linux 3.10.0-693.el7.x86_64 (bogon)     12/12/2022      _x86_64_        (12 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.01    0.00    0.03    0.00    0.00   99.96

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda1              0.00     0.00    0.18    0.00     0.56     0.20     8.34     0.00    0.13    0.12    3.00   0.12   0.00
```
