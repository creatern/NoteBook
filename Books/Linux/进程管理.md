# 进程属性与参数

- 进程：交互进程、批处理进程、守护进程。
- 守护进程：系统开机时通过脚本自动激活启动或root用户启动；后台运行，一直运行；等待请求处理任务。

| 进程属性 | 说明                                               |
| :------- | :------------------------------------------------- |
| PID      | 进程ID，唯一值，区分进程                           |
| PPID     | 父进程和父进程的PID                                |
| UID、GID | 启动进程的用户ID和所归属的组ID                     |
| 进程状态 | R（运行）、S（休眠）、Z（僵尸）                    |
| 其他     | 进程执行的优先级、进程所连接的终端名、进程资源占用 |

| 参数 | 进程状态                             |
| ---- | ------------------------------------ |
| D    | 不能被中断                           |
| R    | 运行中、在队列中可过行的             |
| S    | 休眠                                 |
| T    | 停止、或被跟踪                       |
| W    | 进入内存交换（内核2.6之后失效）      |
| X    | 死亡                                 |
| Z    | 僵尸（进程完成了，但父进程没有响应） |
| &lt; | 优先级较高                           |
| N    | 优先级较低                           |
| L    | 部分页被锁进内存                     |
| S    | 进程的领导者（拥有子进程）           |
| L    | 多个进程的宿主                       |
| \+   | 后台                                 |

# 进程状态检测

## ps 静态进程监视

- ps（process）：进程监视，报告当前系统的进程状态（非动态）

<table><tbody><tr><td data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5">-a<strong data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5"></strong></td><td>显示所有进程信息 </td><td rowspan="14"><strong>&nbsp;</strong></td><td>-t <strong></strong></td><td data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5">显示属于指定终端主机的程序状态 </td></tr><tr><td>-c <strong></strong></td><td>不显示程序路径 <strong></strong></td><td>-T </td><td>显示当前终端主机下的所有程序 <strong></strong></td></tr><tr><td>-d <strong></strong></td><td>不显示阶段作业程序 </td><td>-u <strong></strong></td><td>使用用户为主的格式来显示程序状态 <strong></strong></td></tr><tr><td>-e </td><td>显示环境变量信息 <strong></strong></td><td>-U <strong></strong></td><td>显示属于指定用户的程序状态 </td></tr><tr><td>-f <strong></strong></td><td data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5">用ASCII字符显示树状结构 <strong data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5"></strong></td><td>-v </td><td>使用虚拟内存的格式显示程序状态 <strong></strong></td></tr><tr><td>-g <strong></strong></td><td>显示所有程序及其所属组的程序 </td><td>-w <strong></strong></td><td>使用宽阔的格式显示程序状态 <strong></strong></td></tr><tr><td>-h </td><td>不显示标题列信息 <strong></strong></td><td>-x <strong></strong></td><td>不区分终端主机 </td></tr><tr><td>-H <strong></strong></td><td>使用树状结构展示程序间的相互关系 <strong></strong></td><td>-X </td><td>使用旧式登录格式显示程序状态 <strong></strong></td></tr><tr><td>-j</td><td>使用工作控制格式显示程序状态</td><td>--cols</td><td>设置每列的最大字符数</td></tr><tr><td>-l</td><td>使用详细格式显示程序状态</td><td>--headers</td><td>重复显示标题列</td></tr><tr><td>-p</td><td>指定程序识别码并显示该程序的状态</td><td>--help</td><td>显示帮助信息</td></tr><tr><td>-r</td><td>仅显示终端主机正在执行中的程序</td><td>--info</td><td>显示排错信息</td></tr><tr><td>-s</td><td data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5">使用程序信号格式显示程序状态</td><td>--lines</td><td>设置显示画面的列数</td></tr><tr><td>-S</td><td data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5">显示包括已中断的子程序的状态</td><td>--version</td><td data-immersive-translate-effect="1" data-immersive_translate_walked="81ace535-7488-4eec-8e3e-38a3e5da32d5">显示版本信息</td></tr></tbody></table>

```shell
# ps aux
USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND 
root 2 0.0 0.0 0 0 ? S 20:05 0:00 [kthreadd]
```

| 参数    | 说明                                  |
| ------- | ------------------------------------- |
| USER    | 启动进程的用户名                      |
| PID     | 进程ID                                |
| %CPU    | 进程占用的CPU百分比                   |
| %MEM    | 进程使用的物理内存百分比              |
| VSZ     | 进程使用的虚拟内存总量 KB             |
| RSS     | 进程使用的、未被换出的物理内存大小 KB |
| TTY     | 终端ID                                |
| STAT    | 进程状态                              |
| START   | 启动进程的时间                        |
| TIME    | 进程消耗CPU的时间                     |
| COMMAND | 启动命令的名称和参数                  |

## top 实时状态监视

- <span name="top">top</span>：系统实时状态监视，动态交互命令，默认每5秒刷新一次。

<table><tbody><tr><td data-immersive-translate-effect="1" data-immersive_translate_walked="e068191a-3cc0-4de8-88e8-6dffdc1d64f3">-a</td><td>按内存使用情况排序</td><td rowspan="7">&nbsp;</td><td>-n</td><td>设置显示的总次数，完成后自动退出</td></tr><tr><td>-b</td><td>使用批处理模式，不进行交互式显示</td><td>-p</td><td>仅显示指定进程ID</td></tr><tr><td>-c</td><td>使用显示模式</td><td>-s</td><td>使用安全模式，不允许交互式指令</td></tr><tr><td>-d</td><td>设置显示的更新速度</td><td>-u</td><td data-immersive-translate-effect="1" data-immersive_translate_walked="e068191a-3cc0-4de8-88e8-6dffdc1d64f3">仅显示与指定用户ID</td></tr><tr><td>-h</td><td>显示帮助信息</td><td>-v</td><td>使用线程模式</td></tr><tr><td>-i</td><td>不显示任何闲置或僵死的行程</td><td>-w</td><td>设置显示的宽度</td></tr><tr><td>-M</td><td>显示内存单位</td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table>

```shell
# top
top - 09:59:27 up  1:07,  1 user,  load average: 0.78, 0.44, 0.41
Tasks: 384 total,   1 running, 383 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.4 us,  0.8 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  15381.9 total,   8103.5 free,   3652.5 used,   3626.0 buff/cache
MiB Swap:  15625.0 total,  15625.0 free,      0.0 used.  10799.0 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                
   6591 zjk       20   0  659868  73692  58712 S   6.2   0.5   0:03.80 gnome-terminal-                                                        
      1 root      20   0  167120  11592   8136 S   0.0   0.1   0:01.43 systemd                                                                
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kthreadd         
```

| 参数                           | 说明                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| top - 09:59:27                 | 当前时间                                                     |
| up  1:07                       | 系统已启动时间（minute）                                     |
| 1 user                         | 当前登录到系统的用户数                                       |
| load average: 0.78, 0.44, 0.41 | 系统负载值：1分钟、5分钟、15分钟<br />若超过CPU个数的2倍，则为高负载；若小于CPU个数，则为正常状态 |
| Tasks                          | 所有进程状态统计                                             |
| %Cpu (s)                       | CPU使用情况                                                  |
| KiB Mem                        | 内存使用情况；buff/cache 用于缓存文件系统的内存              |
| KiB Swap                       | 交换空间使用情况；avail Mem 用于缓存文件内容的交换空间       |

| %Cpu参数 | 说明                                     |
| -------- | ---------------------------------------- |
| us       | 用户态程序使用的时间                     |
| sy       | 内核态程序使用的时间                     |
| ni       | nice优先级调整过的用户态程序使用的时间   |
| id       | CPU空闲时间                              |
| wa       | CPU等待系统IO的时间                      |
| hi       | CPU处理硬件中断的时间                    |
| si       | CPU处理软件中断的时间                    |
| st       | 使用虚拟CPU时，指示被虚拟机偷掉的CPU时间 |

- 应用程序实际占用的内存：MemTotal - MemFree - Buffer - Cached （KB）而不是MemUsed。

# 进程控制

## sleep 睡眠

- sleep：进程没有置入后台时，在当前的CLI睡眠，直到该进程睡眠结束才可以在该CLI上输入下一个命令。睡眠结束时，若进程在后台，则直接恢复到前台。

## coproc 协程

- coproc（协程）：同时处理两件事情，后台生成一个子shell并在该子shell中执行命令。

```shell
coproc 进程名 { 命令; 命令; }
```

## 前台与后台进程

| 进程 | 终端窗口 | 启动            |
| ---- | -------- | --------------- |
| 前台 | 占用     | 正常启动        |
| 后台 | 不占用   | 启动命令加上`$` |

| 命令 | 说明                       |
| ---- | -------------------------- |
| jobs | 获取当前存在的进程的作业号 |
| bg   | 从前台进程切换到后台       |
| fg   | 从后台进程切换到前台       |

- Ctrl + Z 让正在执行的前台进程暂停。

## kill、killall 终止进程

- 只有进程的属主或root用户可以杀死该进程
- 父进程被终止时，子进程也被终止；而子进程的终止不会导致父进程的终止

| 命令    | 说明                         |
| ------- | ---------------------------- |
| kill    | 按PID杀死单个进程。          |
| killall | 按进程名杀死同名的所有进程。 |

<table><tbody><tr><td>-a</td><td>不限制命令名与进程号的对应关系</td><td rowspan="2">&nbsp;</td><td>-p</td><td>不发送任何信号</td></tr><tr><td>-l</td><td>显示系统支持的信号列表</td><td>-s</td><td data-immersive-translate-effect="1" data-immersive_translate_walked="54491993-7fc2-439e-ac75-c9e05e42b08c">设置向进程发送的信号</td></tr></tbody></table>

| 序号 | 常用信号 | 说明                                |
| ---- | -------- | ----------------------------------- |
| 15   | SIGTERM  | kill、killall命令预设终止程序的信号 |
| 9    | SIGKILL  | 强制删除程序，尽量避免使用          |

## 进程优先级

- 进程的优先级：

1. 优先级的数值为-20\~19，数值越小优先级越高；启动进程时，其默认优先级是0；仅有系统管理者可以设置负数等级
2. 进程的优先级是父进程shell优先级的值与（nice命令）所指定优先级的值相加和
3. 指定优先级时：`nice -19 进程`表示优先级是19而不是-19；如果要-19，则`nice --19 进程`；也可以使用`nice -n -19 进程`表示-19

### nice

- nice：创建进程时指定进程的优先级，指定的并不就是该进程的优先级，而是一个增量。

<table><tbody><tr><td>-g</td><td>匹配进程组ID</td></tr><tr><td>-n</td><td>设置优先级别</td></tr><tr><td>-p</td><td>匹配进程ID</td></tr><tr><td>-u</td><td>匹配用户ID</td></tr><tr><td>--help</td><td>显示帮助信息</td></tr><tr><td>--version</td><td>显示版本信息</td></tr></tbody></table>

### renice

- renice：修改正在运行的进程的调度优先级；只有系统管理者可以改变其他用户程序的优先权。

<table><tbody><tr><td> -g </td><td>指定进程组id</td></tr><tr><td> -p </td><td>改变该程序的优先权等级，此参数为预设值</td></tr><tr><td> -u </td><td>指定开启进程的用户名</td></tr></tbody></table>

```shell
# 将行程id为987及32的进程与进程拥有者为daemon及root的优先序号码加1
renice +1 987 -u daemon root -p 32
```
