# SQL概述

| DML、DDL、DCL                           | 说明                                                                              |
| ------------------------------------- | ------------------------------------------------------------------------------- |
| DML（data manipulation language）数据操纵语言 | 对数据库的数据进行一些操作<br />DML会对每个语句的每条记录都做日志记录以便于回滚。<br />insert、update、delete、select。 |
| DDL（data definition language）数据库定义语言  | 定义或改变表的结构，数据类型，表之间的链接和约束等初始化工作。<br />create、alter、drop。                         |
| DCL （data control language) 数据库操纵语言   | grant、revoke、commit、rollback、savepoint、lock。                                    |

# 事务

- 事务会将所有在事务中被修改的数据行加上锁（行级锁），来阻止其它人（会话）同时对这些数据的修改操作。当事务被提交或回滚后，这些数据才会被释放锁。事务分为：一个或多个DML语句、一个DDL语句、一个DCL语句。
- DML事务（一般事务）由以下情况之一结束：commit、rollback；DDL(自动提交)；用户会话正常结束；系统异常终止。
- commit、rollback提供了：数据完整性、数据改变被提交之前预览、将逻辑上的操作分组。

<table>
    <tr>
        <th width="20%">事务进程（数据状态）</th>
        <th>情况</th>
    </tr>
    <tr>
        <td>提交/回滚前</td>
        <td>1. 改变前的数据状态是可以改变的。<br/>2. 执行DML操作的用户可以通过select语句查询之前的修正。<br/>3. 其他用户不能看到当前用户所做的改变，直到当前用户结束事务。<br/>4. DML语句所涉及的行被锁定，其他用户不能操作。</td>
    </tr>
    <tr>
        <td>提交后</td>
        <td>1. 数据的改变保存到数据库中。<br/>2. 改变前的数据已经丢失。<br/>3. 所有用户可以看到结果。<br/>4. 所有保存点被释放。</td>
    </tr>
    <tr>
        <td>回滚后</td>
        <td>1. 数据改变被取消。<br/>2. 修改前的数据状态被恢复。<br/>3. 锁被释放。</td>
    </tr>
</table>

# 事务提交 commit

## 显式提交、隐式提交

| 提交   | 说明                                                                                                        |
| ---- | --------------------------------------------------------------------------------------------------------- |
| 显式提交 | commit语句。                                                                                                 |
| 隐式提交 | 无需显示执行commit语句，session中的操作被自动提交到数据库的过程。<br />此隐式提交是在自己的session，如果在其他人的session中正在修改相同的数据，则引起隐式提交的语句则必须等待。s |

> 触发隐式提交的SQL：alter，audit，comment，connect，create，disconnect，drop，exit，grant，noaudit，quit，revoke，rename。

| 隐式提交       | 说明                                |
| ---------- | --------------------------------- |
| 正常执行完DDL语句 | create、alter、drop、truncate、rename |
| 正常执行完DCL语句 | grant、revoke                      |
| 正常退出       | 没有明确发出commit/rollback             |

- 执行DDL语句时（即使DDL语句执行失败），其之前的DML操作也会被提交到数据库中：为了避免隐式提交或者回滚，尽量保证一条或者几条DML操作完成后有显示的提交/回滚，防止后续执行的DCL或者DDL自动提交前期的DML操作。

- 事务读一致性：commit之前的数据，其他用户不可见。执行DDL语句时，Oracle需要在它的系统表中进行元数据的记录操作，如果不隐式提交就无法保证一致性。

## 自动提交 autocommit

- 自动提交：autocommit设置为on，则DML语句执行后，系统将自动进行提交。

```sql
set autocommit on；
```

```sql
-- 查看当前是否是自动提交：
show autocommit；
```

## 保存点 savepoint

```sql
-- 设置保存点：当事物提交后保存点也被清除，需要重新设置
savepoint 保存点名称;         
```

```sql
-- 回滚到保存点
rollback to savepoint 保存点名称; 
```

# 权限管理概述

- sysdba &gt; sysoper（超级权限）：同属于系统权限（system Privileges），Oracle允许拥有该权限的用户在数据库未打开的情况下访问实例、执行重大的数据库操作（数据库启动、关闭等）。

<table>
	<thead>
		<tr>
			<th width="40%">sysdba可执行任务</th>
			<th width="60%">说明</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>startup、shutdown</td>
			<td>启动、关闭数据库</td>
		</tr>
		<tr>
			<td>alter database</td>
			<td>修改数据库
				<br />打开、装载、备份、改变字符集等
			</td>
		</tr>
		<tr>
			<td>create database</td>
			<td>创建数据库</td>
		</tr>
		<tr>
			<td>drop database</td>
			<td>删除数据库</td>
		</tr>
		<tr>
			<td>create spfile</td>
			<td>创建服务器参数文件</td>
		</tr>
		<tr>
			<td>alter database archivelog</td>
			<td>改变归档模式</td>
		</tr>
		<tr>
			<td>alter database recover</td>
			<td>执行数据库恢复</td>
		</tr>
	</tbody>
</table>

```shell
# 以sysdba登录数据库
sqlplus sys/change_on_install[@orcl] as sysdba
```

# 数据库安全性

- 数据库安全性：用户、角色、概要文件。

> 数据库安全性、系统安全性、数据安全性。

## 用户

### 创建用户

- 创建用户需要DBA权限。

#### 11g

```sql
create user user_name
identitied by password;
```

#### 19c

##### 创建普通（LOCAL）用户 PDB

- 假设要在单个PDB（可插拔数据库）中创建一个本地用户，并为其分配连接权限及默认表空间

```sql
-- 登录到Oracle数据库，通常是通过SQL*Plus命令行工具
sqlplus / as sysdba

-- 切换至目标PDB（例如，PDB名为pdb1）
alter session set container=pdb1;

-- 创建本地用户，并为其设置密码、默认表空间和临时表空间
CREATE USER scott IDENTIFIED BY tiger DEFAULT TABLESPACE users TEMPORARY TABLESPACE temp;

-- 授予连接权限（这是用户能够登录的最基本权限）
GRANT CREATE SESSION TO scott;

-- 根据需要授予其他权限，如资源和数据操作权限
GRANT RESOURCE, CREATE TABLE TO scott;

-- 如果需要用户能创建其他用户，可以授予相应权限（通常只在特定场景下需要）
GRANT CREATE USER TO scott;

-- 刷新权限使其立即生效（虽然不是总是必需，但在某些情况下会用到）
ALTER USER scott IDENTIFIED BY tiger PASSWORD EXPIRE;
COMMIT;
```

##### 创建公共（COMMON）用户 CDB

- 在CDB（容器数据库）级别创建一个公共用户

```sql
-- 登录到CDB根目录
sqlplus / as sysdba

-- 创建公共用户，公共用户名称必须以"C##"或"c##"开头
CREATE USER C##common_username IDENTIFIED BY common_password;

-- 公共用户通常不直接分配表空间，而是在每个PDB中获得相应的权限
-- 你需要在每个PDB中执行类似下面的授权语句
ALTER PLUGGABLE DATABASE ALL ENABLE CONTAINER DATA FOR C##common_username;

-- 授予连接权限给公共用户
GRANT CREATE SESSION TO C##common_username;

-- 其他权限的授予与上述本地用户相同
```

### 用户解锁

```sql
alter user scott  
identitied by tiger 
account unlock;
```

### 用户信息

```sql
-- 查看当前用户名
show user
```

```sql
-- 查看所有用户名 all_users
select *
from all_users
```

### 用户密码

- 可用户自己修改

```sql
alter user user_name
identitied by password;
```

### 切换用户

```sql
connect scott/tiger@orcl
```

### 常见错误

- `ORA-65096: invalid common user or role name`：无效的公共用户或角色名。尝试在Oracle数据库中创建、修改或赋予权限给不符合多租户环境下的公共用户或角色命名规则时发生。

## 角色

- 角色可以像用户一样被赋予权限和收回权限，当角色被赋予某个用户时，其权限也被赋予给用户。因此，一个用户的权限=其本身的权限\+其拥有的角色的权限。

### 创建角色

```sql
create role 角色名
```

### 常用角色

<table>
	<thead>
		<tr>
			<th width="10%" align="left">角色</th>
			<th width="90%" align="left">拥有的权限</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td align="left">connect</td>
			<td align="left">连接数据库</td>
		</tr>
		<tr>
			<td align="left">resource</td>
			<td align="left">使用数据库资源</td>
		</tr>
	</tbody>
</table>

# 权限管理

1. 不同对象具有不同的对象权限。
2. 对象的拥有者或sysdba/system用户拥有所有的权限。
3. 对象的拥有者可以向外分配权限。

## public 公共用户

- 向public分配/收回权限，相当于向所有用户（包括还未创建的和已经创建的用户）分配/收回权限。

## SQL标准权限

<table>
	<thead>
		<tr>
			<th width="15%" align="left">权限</th>
			<th width="85%" align="left">权限</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td align="left">select</td>
			<td align="left">查询</td>
		</tr>
		<tr>
			<td align="left">insert</td>
			<td align="left">插入</td>
		</tr>
		<tr>
			<td align="left">update</td>
			<td align="left">更新</td>
		</tr>
		<tr>
			<td align="left">delete</td>
			<td align="left">删除</td>
		</tr>
		<tr>
			<td align="left">all [privilege]</td>
			<td align="left">以上所有</td>
		</tr>
	</tbody>
</table>

## 权限管理命令

### grant 赋予权限

```sql
grant 权限列表
[on [模式.]关系/视图]
to 用户/角色列表
[with grant option] -- 获得分配权限的能力
[by current_role] -- 通过角色授权，避免级联收权
```

```sql
-- 先设置与当前会话关联的角色（默认空）必须是该授权用户拥有的角色
set role 角色
```

### revoke 收回对象权限

```sql
revoke [grant option for] 权限列表 -- grant option for 仅收回分配权
[on [模式.]关系/视图]
from 用户/角色列表
[restrict] -- 阻止级联收权
```

- restrict阻止级联收权，如果发生级联授权，则使这次收权失败。grant授权时，通常会产生一个授权图。当revoke收回权限时，默认级联收权：即a授权给b，b授权给c时，如果收回b的权限，则c的权限也被收回。

## 行级授权

### VPD Oracle虚拟私有数据库

- VPD（Oracle虚拟私有数据库）将函数和关系相关联，该函数返回一个谓词，并自动将该谓词添加到使用该关系的任何查询。

> 隐患：可能会改变查询的含义。

## 权限分配情况

<table>
	<thead>
		<tr>
			<th width="25%" align="left">数据库字典</th>
			<th width="75%" align="left">权限描述</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td align="left">role_sys_privs</td>
			<td align="left">角色拥有的系统权限</td>
		</tr>
		<tr>
			<td align="left">role_tab_privs</td>
			<td align="left">角色拥有的对象权限</td>
		</tr>
		<tr>
			<td align="left">user_rol_privs</td>
			<td align="left">用户拥有的角色</td>
		</tr>
		<tr>
			<td align="left">user_tab_privs_made</td>
			<td align="left">用户分配的关于表对象权限</td>
		</tr>
		<tr>
			<td align="left">user_tab_privs_recd</td>
			<td align="left">用户拥有的关于表对象权限</td>
		</tr>
		<tr>
			<td align="left">user_col_privs_made</td>
			<td align="left">用户分配的关于列的对象权限</td>
		</tr>
		<tr>
			<td align="left">user_col_privs_recd</td>
			<td align="left">用户拥有的关于列的对象权限</td>
		</tr>
		<tr>
			<td align="left">user_sys_privs</td>
			<td align="left">用户拥有的系统权限</td>
		</tr>
	</tbody>
</table>

