# 数据库启动

## Oracle数据库启动阶段

<table>
    <thead>Oracle数据库的启动经历三个阶段</thead>
    <tr>
        <th width="100%"><a href="#NOMOUNT">NOMOUNT</a> 启动实例 (Start An Instance）</th>
    </tr>
    <tr>
        <td>Oracle根据参数文件（PFILE、SPFILE）中的参数，分配相应大小的一片内存区域（系统全局区，SGA）</td>
    </tr>
    <tr>
        <td>然后启动一系列的后台进程（DBWR：数据库写入进程、LGWR：日志写入程序、CKPT：检查点进程、SMON：系统监控进程、PMON：进程监控进程、ARCH：归档进程等)，这些内存和进程合起来组成实例（Oracle Instance）</td>
    </tr>
    <tr>
        <td>Oracle还依据参数文件（PFILE、SPFILE）进行其他一些设置（初始化参数）</td>
    </tr>
    <tr>
        <th><a href="#MOUNT">MOUNT</a> 装载数据库（Mount The Database）</th>
    </tr>
    <tr>
        <td>在这个阶段中，Oracle根据参数文件（PFILE或者SPFILE）中的参数（<code>CONTROL_FILES</code>）找到控制文件（Control File），然后打开控制文件，从控制文件中获得数据文件（Datafile）和重做日志文件（Redo Log File）的名字及位置</td>
    </tr>
    <tr>
        <td>这个时候，Oracle已经把实例（Instance）和数据库关联起来。但对于普通用户来说，数据库还是不可访问</td>
    </tr>
    <tr>
        <th><a href="#OPEN">OPEN</a> 打开数据库（Open The Database）</th>
    </tr>
    <tr>
        <td>当打开数据库的时候，Oracle打开数据文件(Datafiles)和重做日志文件(Redo Log File)</td>
    </tr>
    <tr>
        <td>这时候，数据库可以使用。普通用户可以登录数据库，并对数据库进行操作</td>
    </tr>
</table>


### SPFILE、PFILE

- 当启动一个实例时，Oracle会读取一个参数文件，这个文件可以是初始化参数文件（PFILE），也可以是服务器端参数文件（SPFILE），通常，我们把两者都称为参数文件（Parameter File）。
- 参数文件（PFILE或者SPFILE）指定了控制文件（Control File）的位置。

<table>
    <tr>
        <td>初始化参数文件（PFILE）</td>
        <td></td>
    </tr>
    <tr>
        <td>服务器端参数文件（SPFILE）</td>
        <td></td>
    </tr>
</table>
### 实例

- Oracle Instance：Oracle的内存和进程构成了实例（Oracle Instance）。一台机器上可以同时运行多个实例。每个实例都有自己的名字（SID）。实例是用来驱动数据库的，在RAC（Real Application Cluster，集群）环境中，多个实例可以同时驱动一个数据库。
- 实例启动完成以后，数据库就处于`NOMOUNT`状态。在实例启动完成以后，数据库还没有和实例关联。此时，数据库不可访问。该阶段主要用于数据库的维护（如重建控制文件等）。

## 启动阶段对应的状态

### <span name="NOMOUNT">NOMOUNT</span> 非装载状态

- MOMOUNT（非装载状态）：只启动实例。

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 启动数据库到NOMOUNT状态

```sql
STARTUP NOMOUNT
```

```shell
SQL> STARTUP NOMOUNT
ORACLE 例程已经启动。

Total System Global Area 1720328192 bytes
Fixed Size                  2176448 bytes
Variable Size            1174407744 bytes
Database Buffers          536870912 bytes
Redo Buffers                6873088 bytes
```

### <span name="MOUNT">MOUNT</span> 装载状态

- MOUNT（装载状态）：打开控制文件，读取数据文件和重做日志文件的名称和位置。处于MOUNT阶段的数据库，主要用于数据库的维护（如恢复数据库等）。

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 启动数据库到MOUNT状态

```sql
STARTUP MOUNT
```

```shell
SQL> STARTUP MOUNT
ORACLE 例程已经启动。

Total System Global Area 1720328192 bytes
Fixed Size                  2176448 bytes
Variable Size            1174407744 bytes
Database Buffers          536870912 bytes
Redo Buffers                6873088 bytes
数据库装载完毕。
```

- 如果数据库处于NOMOUNT状态

```sql
ALTER DATABASE MOUNT;
```

### <span name="OPEN">OPEN 打开数据库</span>

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 启动数据库

```
STARTUP
```

```
SQL> STARTUP
ORACLE 例程已经启动。

Total System Global Area 1720328192 bytes
Fixed Size                  2176448 bytes
Variable Size            1174407744 bytes
Database Buffers          536870912 bytes
Redo Buffers                6873088 bytes
数据库装载完毕。
数据库已经打开。
```

- 如果数据库处于MOUNT状态

```sql
ALTER DATABASE OPEN;
```

- 如果数据库处于NOMOUNT状态

```sql
ALTER DATABASE MOUNT; 
ALTER DATABASE OPEN;
```

## 数据库启动到只读模式

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以只读方式启动数据库

```sql
STARTUP OPEN READ ONLY;
```

3. V$DATABASE 检查数据库是否以只读方式打开

```sql
SELECT open_mode
FROM V$DATABASE;
```

## Windows 自动启动/关闭

1. 将Oracle的服务设置为自动启动
2. 编辑注册表
    1. 运行\-\-\>regedit命令
    2. 进入`HKEY_LOCAL_MACHINE\ORACLE\ORACLE_HOME_NAME`
3. 将数据库设置成自动启动。将参数`ORA_SID_AUTOSTART`设置为TRUE。`ORA_SID_AUTOSTART=TRUE`表示操作系统启动时，将自动启动Oracle数据库。

4. 把数据库设置成自动关闭。
    - 将参数`ORA_SID_SHUTDOWN`设置为TRUE。`ORA_SID_SHUTDOWN=TRUE`表示操作系统关闭时，将自动关闭Oracle数据库。
    - 将参数`ORA_SID_SHUTDOWNTYPE`设置成IMMEDIATE。`ORA_SID_SHUTDOWNTYPE`于设置数据库的关闭方式。
3. 创建SPFILE（如果SPFILE不存在）
4. 重启Windows
5. 测试数据库是否能自动启动

# 数据库关闭

## 数据库关闭原理

<table>
    <thead>数据库启动要经历三个阶段，数据库关闭也要经历三个阶段</thead>
    <tr>
        <th>阶段一：关闭数据库（Close The Database）</th>
    </tr>
    <tr>
        <td>关闭数据库的时候，Oracle首先把SGA中的数据写到数据文件和重做日志文件中</td>
    </tr>
    <tr>
        <td>然后，Oracle关闭所有的数据文件和重做日志文件。这时候，数据库已经不可访问</td>
    </tr>
    <tr>
        <td>这个阶段完成以后，控制文件仍然处在打开状态</td>
    </tr>
    <tr>
        <th>阶段二：卸载数据库（Unmount The Database）</th>
    </tr>
    <tr>
        <td>数据库关闭完成以后，Oracle将分离数据库和实例之间的联系，这个阶段叫“卸载数据库”或者叫“UNMOUNT数据库”</td>
    </tr>
    <tr>
        <td>这个阶段仅仅是卸载数据库，实例仍然存活在内存中</td>
    </tr>
    <tr>
        <th>阶段三：关闭实例（Shut Down The Instance）</th>
    </tr>
    <tr>
        <td>Oracle将从内存中移出SGA并终止正在运行的后台进程</td>
    </tr>
    <tr>
        <td>至此，数据库关闭已经完成</td>
    </tr>
</table>

- 数据库关闭有四种方式：NORMAL、IMMEDIATE、TRANSACTIONAL、ABORT。

## 数据库关闭方式

### IMMEDIATE

- IMMEDIATE方式是数据库关闭使用频率最高的方式。

- 以IMMEDIATE方式关闭数库时，会发生下面的事情：

1. 新的用户不能注册（登录）数据库。
2. 未提交的事务将被回滚(Rolled Back)。
3. Oracle不会等待所有的用户（连接）退出数据库。

- 以IMMEDIATE方式关闭数据库具有以下特点：

1. 以IMMEDIATE方式关闭数据库不需要实例恢复(Instance Recovery)。
2. `SHUTDOWN IMMEDIATE`是最安全的数据库关闭方式。
3. 使用`SHUTDOWN IMMEDIATE`关闭数据库的过程比较慢。

- 使用IMMEDIATE方式关闭数据库的过程说明如下：

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以IMMEDIATE方式关闭数据库

```sql
SHUTDOWN IMMEDIATE;
```

### ABORT

- ABORT方式是关闭数据库最快的方式，不推荐使用这种方式关闭数据库。

- 以ABORT方式关闭数据库时，会发生下面的事情：

1. 不允许启动新的连接（New Connections）和新的事务（New Transactions）。
2. 客户端的SQL语句（Client SQL Statements）立刻中止。
3. 未提交的事务不被回滚（RolIBack）。
4. Oracle立刻中止所有连接（会话）。

- 以ABORT方式关闭数据库具有以下特点：

1. 只有数据库出现问题的时候，才使用这种方式关闭数据库。

2. 这是一种最不安全的关闭方式，数据库重启时需要实例恢复(Oracle后台进行)。

- 以ABORT方式关闭数据库的过程说明如下：

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以ABORT方式关闭数据库

```sql
SHUTDOWN ABORT;
```

### NORMAL

- NORMAL方式（默认）是关闭数据库最慢的方式。以NORMAL关闭数据库时，不需要实例恢复(Instance Recovery)。

- 使用NORMAL方式关闭数据库时，有以下特点：

1. 允许新的用户注册（登录）数据库。

2. 要等所有的用户自动退出Oracle以后，Oracle才关闭数据库。如果数据库中存在一个用户，那么Oracle就一直等待，直到该用户退出，Oracle才关闭数据库。因此，如果使用NORMAL方式关闭数据库，也许有的数据库永远也不能关闭。

- 使用NORMAL方式关闭数据库的过程说明如下。

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以NORMAL方式关闭数据库

```sql
SHUTDOWN NORMAL;
```

### TRANSACTIONAL

- 以TRANSACTIONAL方式关闭数据库时，会发生下面的事情：

1. 不允许新的用户注册（登录）数据库
2. 不允许建立新的事务（New Transactions）
3. 所有的事务（Transactions）完成以后才关闭数据库
4. 一个用户（会话）执行完手里的事务（Transactions）后将被强行断开与数据库的联机

- 以这种方式关闭数据库有以下特点：

1. 这种关闭方式不会使客户端的数据丢失；
2. 这种关闭方式不需要实例恢复（Instance Recovery）；
3. 使用SHUTDOWN TRANSACTIONAL命令关闭数据库的过程比较慢。

- 使用TRANSACTIONAL方式关闭数据库的过程说明如下：

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以TRANSACTIONAL方式关闭数据库

```
SHUTDOWN TRANSACTIONAL;
```

# 重启数据库

- 重启数据库会执行实例恢复的过程系统，正常运行的情况下，不推荐重启。

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 重启数据库

```sql
STARTUP FORCE;
```

# 故障排除

- 数据启动故障诊断由两个阶段组成：

<table>
    <tr>
        <td width="20%" rowspann="2">检查数据库</td>
        <td width="80%">警报日志文件（Alert Log）</td>
    </tr>
    <tr>
        <td rowspan="2">检查操作系统</td>
        <td>跟踪日志文件（Trace Log）</td>
    </tr>
    <tr>
        <td>操作系统的日志文件</td>
    </tr>
</table>

## 警报日志文件（Alert Log）

- 警报日志文件，用于记录数据库的重大活动和发生的错误。特别注意的是，警报日志文件除了记录数据库中发生的错误外，还记录数据库中发生的重大事件。警报日志文件按照时间的先后记录发生的事件。
- 警报日志文件的名字的格式是`alertSID.log`，其中，SID表示实例名（Instance）。警报文件的位置由初始化参数`BACKGROUND DUMP DEST`指定。

- 警报日志文件记录的内容如下：

1. 每次数据库启动（STARTUP）和关闭（SHUTDOWN）的详细信息。
2. DBA执行的某些管理操作，如`ALTER SYSTEM`，`ALTER DATABASE`。
3. 某些数据库错误，如Oracle的内部错误（ORA-600），空间错误等。
4. 共享服务器相关的信息和错误。
5. 值是非默认值的初始化参数（Initialization Parameters）信息。
6. 物化视图（Materialized View）自动刷新产生的错误。

## 跟踪日志文件（Trace Log）

- 每个服务器进程和后台进程都写跟踪日志文件。当一个后台进程检测到错误的时候，Oracle会把错误信息写到跟踪日志文件中。

- 跟踪信息被写到两个目录中，和后台进程（Background Processes）相关的信息被写到初始化参数`DIAGNOSTIC_DEST`指定目录，和服务器进程（Server Procee）相关的信息被写到初始化参数`USER_DUMP_DEST`指定的目录。

- 跟踪日志文件的名字在每种操作系统上会有所不同，但是，每个跟踪日志文件的名宇都包含进程的名字。

- 如果数据库长时间运行，跟踪日志文件会变得越来越大。此时，需要手工清除跟踪日志文件、或限制跟踪日志文件的大小，
  

1. Oracle的初始化参数`MAX_DUMP_FILE_SIZE`用于限制跟踪日志文件的大小。
2. `MAX_DUMP_FILE_SIZE`的格式如下：`MAX_DUMP_FILE_SIZE = { 大小 [K | M] | UNLIMITED}`

## 查看操作系统的日志文件
