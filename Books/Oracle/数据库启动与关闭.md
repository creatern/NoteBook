# 数据库启动

- Oracle数据库的启动经历三个阶段：
1. 启动实例 (Start An Instance)
- 当启动一个实例时，Oracle会读取一个参数文件，这个文件可以是初始化参数文件（PFILE），也可以是服务器端参数文件(SPFILE)，通常，我们把两者都称为参数文件(Parameter File),
- Oracle根据参数文件(PFILE、SPFILE)中的参数，分配相应大小的一片内存区域叫系统全局区(SGA),然后启动一系列的后台进程（DBWR：数据库写入进程、LGWR：日志写入程序、CKPT：检查点进程、SMON：系统监控进程、PMON：进程监控进程、ARCH：归档进程等)。这些内存和进程合起来组成实例(Oracle Instance)。Oracle还依据参数文件(PFILE、SPFILE)进行其他一些设置（初始化参数）
  - **Oracle的内存和进程构成了实例**。一台机器上可以同时运行多个实例。每个实例都有自己的名字(SD)。实例是用来驱动数据库的，在RAC(Real Application Cluster,集群)环境中，多个实例可以同时驱动一个数据库。实例启动完成以后，数据库就处于**NOMOUNT状态**。在实例启动完成以后，数据库还没有和实例关联。这时候，数据库不可访问。这个阶段主要用于数据库的维护（如重建控制文件等）。
  - 参数文件(PFILE或者SPFILE)指定了控制文件(Control File)的位置。
2. 装载数据库 (Mount The Database)
- 在这个阶段中，Oracle根据参数文件(PFILE或者SPFILE)中的参数(CONTROL_FILES)找到控制文件(Control File)，然后打开控制文件。从控制文件中获得数据文件(Datafile)和重做日志文件(Redo Log File)的名字及位置。
- 这个时候，Oracle已经把实例(Instance)和数据库关联起来。对于普通用户来说，数据库还是不可访问。
- 处于MOUNT阶段的数据库，主要用于数据库的维护（如恢复数据库等）。
3. 打开数据库 (Open The Database)
- 当打开数据库的时候，Oracle打开数据文件(Datafiles)和重做日志文件(Redo Log File)。
- 这时候，数据库可以使用。普通用户可以登录数据库，并对数据库进行操作。

## NOMOUNT 非装载状态（只启动实例）

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 启动数据库到NOMOUNT状态

```
STARTUP NOMOUNT
```

```
SQL> STARTUP NOMOUNT
ORACLE 例程已经启动。

Total System Global Area 1720328192 bytes
Fixed Size                  2176448 bytes
Variable Size            1174407744 bytes
Database Buffers          536870912 bytes
Redo Buffers                6873088 bytes
```

## MOUNT 装载状态（打开控制文件，读取数据文件和重做日志文件的名称和位置）

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 启动数据库到MOUNT状态

```
STARTUP MOUNT
```

```
SQL> STARTUP MOUNT
ORACLE 例程已经启动。

Total System Global Area 1720328192 bytes
Fixed Size                  2176448 bytes
Variable Size            1174407744 bytes
Database Buffers          536870912 bytes
Redo Buffers                6873088 bytes
数据库装载完毕。
```

- 如果数据库处于NOMOUNT状态

```
ALTER DATABASE MOUNT;
```

## OPEN 打开数据库

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 启动数据库

```
STARTUP
```

```
SQL> STARTUP
ORACLE 例程已经启动。

Total System Global Area 1720328192 bytes
Fixed Size                  2176448 bytes
Variable Size            1174407744 bytes
Database Buffers          536870912 bytes
Redo Buffers                6873088 bytes
数据库装载完毕。
数据库已经打开。
```

- 如果数据库处于MOUNT状态

```
ALTER DATABASE OPEN;
```

- 如果数据库处于NOMOUNT状态

```
ALTER DATABASE MOUNT; 
ALTER DATABASE OPEN;
```

## 重启数据库

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 重启数据库

```
STARTUP FORCE;
```

- 会执行实例恢复的过程系统，正常运行的情况下，不推荐

## 将数据库启动到只读模式

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以只读方式启动数据库

```sql
STARTUP OPEN READ ONLY;
```

3. V$DATABASE 检查数据库是否以只读方式打开

```sql
SELECT open_mode
FROM V$DATABASE;
```

## Windows 自动启动/关闭

**1. 将Oracle的服务设置为自动启动**

**2. 编辑注册表**

1. 运行-->regedit命令

2. 进入HKEY_LOCAL_MACHINE\ORACLE\ORACLE_HOME_NAME

3. 将数据库设置成自动启动。
   
   - 将参数ORA_SID_AUTOSTART设置为TRUE。ORA_SID_AUTOSTART=TRUE表示操作系统启动时，将自动启动Oracle数据库。

4. 把数据库设置成自动关闭。
   
   - 将参数ORA_SID_SHUTDOWN设置为TRUE。ORA_SID_SHUTDOWN=TRUE表示操作系统关闭时，将自动关闭Oracle数据库。
   
   - 将ORA_SID_SHUTDOWNTYPE设置成IMMEDIATE。ORA_SID_SHUTDOWNTYPE于设置数据库的关闭方式。

**3. 创建SPFILE(如果SPFILE不存在)**

**4. 重启Windows**

**5. 测试数据库是否能自动启动**

# 数据库关闭

## 数据库关闭原理

**数据库启动要经历三个阶段，数据库关闭也要经历三个阶段。**

- 阶段一：关闭数据库(Close The Database);
  - 关闭数据库的时候，Oracle首先把SGA中的数据写到数据文件和重做日志文件中。
  - 然后，Oracle关闭所有的数据文件和重做日志文件。这时候，数据库已经不可访问。
  - 这个阶段完成以后，控制文件仍然处在打开状态。
- 阶段二：卸载数据库(Unmount The Database);
  - 数据库关闭完成以后，Oracle将分离数据库和实例之间的联系，这个阶段叫“卸载数据库”或者叫“UNMOUNT数据库”。
  - 这个阶段仅仅是卸载数据库，实例仍然存活在内存中。
- 阶段三：关闭实例(Shut Down The Instance)。
  - Oracle将从内存中移出SGA并终止正在运行的后台进程。
  - 至此，数据库关闭已经完成。

**数据库关闭有四种方式**：

- NORMAL
- IMMEDIATE
- TRANSACTIONAL
- ABORT

## IMMEDIATE方式是数据库关闭使用频率最高的方式。

**以IMMEDIATE方式关闭数库时，会发生下面的事情：**

- 新的用户不能注册（登录）数据库。
- 未提交的事务将被回滚(Rolled Back)。
- Oracle不会等待所有的用户（连接）退出数据库。

**以IMMEDIATE方式关闭数据库具有以下特点：**

- 以IMMEDIATE方式关闭数据库不需要实例恢复(Instance Recovery)。
- `SHUTDOWN IMMEDIATE`是最安全的数据库关闭方式。
- 使用`SHUTDOWN IMMEDIATE`关闭数据库的过程比较慢。

**使用IMMEDIATE方式关闭数据库的过程说明如下。**

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以IMMEDIATE方式关闭数据库

```
SHUTDOWN IMMEDIATE;
```

## ABORT方式是关闭数据库最快的方式。

**以ABORT方式关闭数据库时，会发生下面的事情：**

- 不允许启动新的连接(New Connections)和新的事务(New Transactions)。
- 客户端的SQL语句(Client SQL Statements)立刻中止。
- 未提交的事务不被回滚(RolIBack)。
- Oracle立刻中止所有连接（会话)。

**以ABORT方式关闭数据库具有以下特点：**

- 只有数据库出现问题的时候，才使用这种方式关闭数据库。
- 这是一种最不安全的关闭方式，数据库重启时需要实例恢复(Oracle后台进行)。
  - 不推荐使用这种方式关闭数据库。

**以ABORT方式关闭数据库的过程说明如下。**

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以ABORT方式关闭数据库

```sql
SHUTDOWN ABORT;
```

## NORMAL方式(默认)是关闭数据库最慢的方式

- 以NORMAL关闭数据库时，不需要实例恢复(Instance Recovery)。

**使用NORMAL方式关闭数据库时，有以下特点：**

- 允许新的用户注册（登录）数据库。
- 要等所有的用户自动退出Oracle以后，Oracle才关闭数据库。所以，如果数据库中存在一个用户，那么，Oracle就一直等待，直到该用户退出，Oracle才关闭数据库。
  - 如果使用NORMAL方式关闭数据库，也许有的数据库永远也不能关闭。
  - `SHUTDOWN NORMAL`是最慢的一种数据库关闭方式。

**使用NORMAL方式关闭数据库的过程说明如下。**

1. 以SYSDBA的身份登录数据库

```sql
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以NORMAL方式关闭数据库

```sql
SHUTDOWN NORMAL;
```

## TRANSACTIONAL方式关闭数据库

**以TRANSACTIONAL方式关闭数据库时，会发生下面的事情：**

- 不允许新的用户注册（登录）数据库：
- 不允许建立新的事务(New Transactions):
- 所有的事务(Transactions)完成以后才关闭数据库；
- 一个用户（会话）执行完手里的事务(Transactions)后将被强行断开与数据库的联机。

**以这种方式关闭数据库有以下特点：**

- 这种关闭方式不会使客户端的数据丢失；
- 这种关闭方式不需要实例恢复(Instance Recovery);
- 使用SHUTDOWN TRANSACTIONAL命令关闭数据库的过程比较慢。

**使用TRANSACTIONAL方式关闭数据库的过程说明如下。**

1. 以SYSDBA的身份登录数据库

```
CONNECT sys/change_on_install AS SYSDBA;
```

2. 以TRANSACTIONAL方式关闭数据库

```
SHUTDOWN TRANSACTIONAL;
```

# 故障排除

**数据启动故障诊断由两个阶段组成：**

- 检查数据库
  - 警报日志文件(Alert Log)
  - 跟踪日志文件(Trace Log)）
- 检查操作系统
  - 操作系统的日志文件

## 警报日志文件(Alert Log)

- 警报日志文件，用于记录数据库的重大活动和发生的错误
  - 特别注意的是，警报日志文件除了记录数据库中发生的错误外，还记录数据库中发生的重大事件。
- 警报日志文件按照时间的先后记录发生的事件。
- 警报日志文件的名字的格式是alertSID.log,其中，SID表示实例名(Instance)。
- 警报文件的位置由初始化参数BACKGROUND DUMP DEST指定。

**警报日志文件记录的内容如下：**

- 每次数据库启动(STARTUP)和关闭(SHUTDOWN)的详细信息。
- DBA执行的某些管理操作，如ALTER SYSTEM，ALTER DATABASE。
- 某些数据库错误，如Oracle的内部错误(ORA-600)，空间错误等。
- 共享服务器相关的信息和错误。
- 值是非默认值的初始化参数（Initialization Parameters)信息。
- 物化视图(Materialized View)自动刷新产生的错误。

## 跟踪日志文件(Trace Log)

- 每个服务器进程和后台进程都写跟踪日志文件。

- 当一个后台进程检测到错误的时候，Oracle会把错误信息写到跟踪日志文件中。

- 跟踪信息被写到两个目录中，
  
  - 和后台进程(Background Processes)相关的信息被写到初始化参数DIAGNOSTIC_DEST指定目录
  - 和服务器进程(Server Procee)相关的信息被写到初始化参数USER_DUMP_DEST指定的目录。

- 跟踪日志文件的名字在每种操作系统上会有所不同，但是，每个跟踪日志文件的名宇都包含进程的名字。

- 如果数据库长时间运行，跟踪日志文件会变得越来越大。手工清除跟踪日志文件，或限制跟踪日志文件的大小，
  
  - Oracle的初始化参数MAX_DUMP_FILE_SIZE用于限制跟踪日志文件的大小。
  - MAX_DUMP_FILE_SIZE的格式如下：`MAX_DUMP_FILE_SIZE = { 大小 [K | M] | UNLIMITED}`

## 查看操作系统的日志文件
