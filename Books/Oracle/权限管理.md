# 权限管理概述

- sysdba &gt; sysoper（超级权限）：同属于系统权限（system Privileges），Oracle允许拥有该权限的用户在数据库未打开的情况下访问实例、执行重大的数据库操作（数据库启动、关闭等）。

<table>
	<thead>
		<tr>
			<th width="40%">sysdba可执行任务</th>
			<th width="60%">说明</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>startup、shutdown</td>
			<td>启动、关闭数据库</td>
		</tr>
		<tr>
			<td>alter database</td>
			<td>修改数据库
				<br />打开、装载、备份、改变字符集等
			</td>
		</tr>
		<tr>
			<td>create database</td>
			<td>创建数据库</td>
		</tr>
		<tr>
			<td>drop database</td>
			<td>删除数据库</td>
		</tr>
		<tr>
			<td>create spfile</td>
			<td>创建服务器参数文件</td>
		</tr>
		<tr>
			<td>alter database archivelog</td>
			<td>改变归档模式</td>
		</tr>
		<tr>
			<td>alter database recover</td>
			<td>执行数据库恢复</td>
		</tr>
	</tbody>
</table>

```shell
# 以sysdba登录数据库
sqlplus sys/change_on_install[@orcl] as sysdba
```

# 数据库安全性

- 数据库安全性：用户、角色、概要文件。

> 数据库安全性、系统安全性、数据安全性。

## 用户

### 创建用户

- 创建用户需要DBA权限。

#### 11g

```sql
create user user_name
identitied by password;
```

#### 19c

##### 创建普通（LOCAL）用户 PDB

- 假设要在单个PDB（可插拔数据库）中创建一个本地用户，并为其分配连接权限及默认表空间

```sql
-- 登录到Oracle数据库，通常是通过SQL*Plus命令行工具
sqlplus / as sysdba

-- 切换至目标PDB（例如，PDB名为pdb1）
alter session set container=pdb1;

-- 创建本地用户，并为其设置密码、默认表空间和临时表空间
CREATE USER scott IDENTIFIED BY tiger DEFAULT TABLESPACE users TEMPORARY TABLESPACE temp;

-- 授予连接权限（这是用户能够登录的最基本权限）
GRANT CREATE SESSION TO scott;

-- 根据需要授予其他权限，如资源和数据操作权限
GRANT RESOURCE, CREATE TABLE TO scott;

-- 如果需要用户能创建其他用户，可以授予相应权限（通常只在特定场景下需要）
GRANT CREATE USER TO scott;

-- 刷新权限使其立即生效（虽然不是总是必需，但在某些情况下会用到）
ALTER USER scott IDENTIFIED BY tiger PASSWORD EXPIRE;
COMMIT;
```

##### 创建公共（COMMON）用户 CDB

- 在CDB（容器数据库）级别创建一个公共用户

```sql
-- 登录到CDB根目录
sqlplus / as sysdba

-- 创建公共用户，公共用户名称必须以"C##"或"c##"开头
CREATE USER C##common_username IDENTIFIED BY common_password;

-- 公共用户通常不直接分配表空间，而是在每个PDB中获得相应的权限
-- 你需要在每个PDB中执行类似下面的授权语句
ALTER PLUGGABLE DATABASE ALL ENABLE CONTAINER DATA FOR C##common_username;

-- 授予连接权限给公共用户
GRANT CREATE SESSION TO C##common_username;

-- 其他权限的授予与上述本地用户相同
```

### 用户解锁

```sql
alter user scott  
identitied by tiger 
account unlock;
```

### 用户信息

```sql
-- 查看当前用户名
show user
```

```sql
-- 查看所有用户名 all_users
select *
from all_users
```

### 用户密码

- 可用户自己修改

```sql
alter user user_name
identitied by password;
```

### 切换用户

```sql
connect scott/tiger@orcl
```

### 常见错误

- `ORA-65096: invalid common user or role name`：无效的公共用户或角色名。尝试在Oracle数据库中创建、修改或赋予权限给不符合多租户环境下的公共用户或角色命名规则时发生。

## 角色

- 角色可以像用户一样被赋予权限和收回权限，当角色被赋予某个用户时，其权限也被赋予给用户。因此，一个用户的权限=其本身的权限\+其拥有的角色的权限。

### 创建角色

```sql
create role 角色名
```

### 常用角色

<table>
	<thead>
		<tr>
			<th width="10%" align="left">角色</th>
			<th width="90%" align="left">拥有的权限</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td align="left">connect</td>
			<td align="left">连接数据库</td>
		</tr>
		<tr>
			<td align="left">resource</td>
			<td align="left">使用数据库资源</td>
		</tr>
	</tbody>
</table>

# 权限管理

1. 不同对象具有不同的对象权限。
2. 对象的拥有者或sysdba/system用户拥有所有的权限。
3. 对象的拥有者可以向外分配权限。

## public 公共用户

- 向public分配/收回权限，相当于向所有用户（包括还未创建的和已经创建的用户）分配/收回权限。

## SQL标准权限

<table>
	<thead>
		<tr>
			<th width="15%" align="left">权限</th>
			<th width="85%" align="left">权限</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td align="left">select</td>
			<td align="left">查询</td>
		</tr>
		<tr>
			<td align="left">insert</td>
			<td align="left">插入</td>
		</tr>
		<tr>
			<td align="left">update</td>
			<td align="left">更新</td>
		</tr>
		<tr>
			<td align="left">delete</td>
			<td align="left">删除</td>
		</tr>
		<tr>
			<td align="left">all [privilege]</td>
			<td align="left">以上所有</td>
		</tr>
	</tbody>
</table>

## 权限管理命令

### grant 赋予权限

```sql
grant 权限列表
[on [模式.]关系/视图]
to 用户/角色列表
[with grant option] -- 获得分配权限的能力
[by current_role] -- 通过角色授权，避免级联收权
```

```sql
-- 先设置与当前会话关联的角色（默认空）必须是该授权用户拥有的角色
set role 角色
```

### revoke 收回对象权限

```sql
revoke [grant option for] 权限列表 -- grant option for 仅收回分配权
[on [模式.]关系/视图]
from 用户/角色列表
[restrict] -- 阻止级联收权
```

- restrict阻止级联收权，如果发生级联授权，则使这次收权失败。grant授权时，通常会产生一个授权图。当revoke收回权限时，默认级联收权：即a授权给b，b授权给c时，如果收回b的权限，则c的权限也被收回。

## 行级授权

### VPD Oracle虚拟私有数据库

- VPD（Oracle虚拟私有数据库）将函数和关系相关联，该函数返回一个谓词，并自动将该谓词添加到使用该关系的任何查询。

> 隐患：可能会改变查询的含义。

## 权限分配情况

<table>
	<thead>
		<tr>
			<th width="25%" align="left">数据库字典</th>
			<th width="75%" align="left">权限描述</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td align="left">role_sys_privs</td>
			<td align="left">角色拥有的系统权限</td>
		</tr>
		<tr>
			<td align="left">role_tab_privs</td>
			<td align="left">角色拥有的对象权限</td>
		</tr>
		<tr>
			<td align="left">user_rol_privs</td>
			<td align="left">用户拥有的角色</td>
		</tr>
		<tr>
			<td align="left">user_tab_privs_made</td>
			<td align="left">用户分配的关于表对象权限</td>
		</tr>
		<tr>
			<td align="left">user_tab_privs_recd</td>
			<td align="left">用户拥有的关于表对象权限</td>
		</tr>
		<tr>
			<td align="left">user_col_privs_made</td>
			<td align="left">用户分配的关于列的对象权限</td>
		</tr>
		<tr>
			<td align="left">user_col_privs_recd</td>
			<td align="left">用户拥有的关于列的对象权限</td>
		</tr>
		<tr>
			<td align="left">user_sys_privs</td>
			<td align="left">用户拥有的系统权限</td>
		</tr>
	</tbody>
</table>

