# SQL概述

| DML、DDL、DCL                                 | 说明                                                         |
| --------------------------------------------- | ------------------------------------------------------------ |
| DML（data manipulation language）数据操纵语言 | 对数据库的数据进行一些操作<br />DML会对每个语句的每条记录都做日志记录以便于回滚。<br />insert、update、delete、select。 |
| DDL（data definition language）数据库定义语言 | 定义或改变表的结构，数据类型，表之间的链接和约束等初始化工作。<br />create、alter、drop。 |
| DCL （data control language) 数据库操纵语言   | grant、revoke、commit、rollback、savepoint、lock。           |

# 事务

- 事务会将所有在事务中被修改的数据行加上锁（行级锁），来阻止其它人（会话）同时对这些数据的修改操作。当事务被提交或回滚后，这些数据才会被释放锁。事务分为：一个或多个DML语句、一个DDL语句、一个DCL语句。


- DML事务（一般事务）由以下情况之一结束：commit、rollback；DDL(自动提交)；用户会话正常结束；系统异常终止。

- commit、rollback提供了：数据完整性、数据改变被提交之前预览、将逻辑上的操作分组。

| 事务进程（数据状态） | 说明                                                         |
| -------------------- | ------------------------------------------------------------ |
| 提交/回滚前          | 1. 改变前的数据状态是可以改变的。<br/>2. 执行DML操作的用户可以通过select语句查询之前的修正。<br/>3. 其他用户不能看到当前用户所做的改变，直到当前用户结束事务。<br/>4. DML语句所涉及的行被锁定，其他用户不能操作。 |
| 提交后               | 1. 数据的改变保存到数据库中。<br/>2. 改变前的数据已经丢失。<br/>3. 所有用户可以看到结果。<br/>4. 所有保存点被释放。 |
| 回滚后               | 1. 数据改变被取消。<br/>2. 修改前的数据状态被恢复。<br/>3. 锁被释放。 |

# 提交 commit

## 显式提交、隐式提交

| 提交     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 显式提交 | commit语句。                                                 |
| 隐式提交 | 无需显示执行commit语句，session中的操作被自动提交到数据库的过程。<br />此隐式提交是在自己的session，如果在其他人的session中正在修改相同的数据，则引起隐式提交的语句则必须等待。s |

> 触发隐式提交的SQL：alter，audit，comment，connect，create，disconnect，drop，exit，grant，noaudit，quit，revoke，rename。

| 隐式提交          | 说明                                  |
| ----------------- | ------------------------------------- |
| 正常执行完DDL语句 | create、alter、drop、truncate、rename |
| 正常执行完DCL语句 | grant、revoke                         |
| 正常退出          | 没有明确发出commit/rollback           |

- 执行DDL语句时（即使DDL语句执行失败），其之前的DML操作也会被提交到数据库中：为了避免隐式提交或者回滚，尽量保证一条或者几条DML操作完成后有显示的提交/回滚，防止后续执行的DCL或者DDL自动提交前期的DML操作。

- 事务读一致性：commit之前的数据，其他用户不可见。执行DDL语句时，Oracle需要在它的系统表中进行元数据的记录操作，如果不隐式提交就无法保证一致性。

## 自动提交 autocommit

- 自动提交：autocommit设置为on，则DML语句执行后，系统将自动进行提交。

```sql
set autocommit on；
```

```sql
-- 查看当前是否是自动提交：
show autocommit；
```

## 保存点 savepoint

```sql
-- 设置保存点：当事物提交后保存点也被清除，需要重新设置
savepoint 保存点名称;         
```

```sql
-- 回滚到保存点
rollback to savepoint 保存点名称; 
```
