# DBAS生命周期模型

- DBAS（DataBase Application System，数据库应用系统）的生命周期由项目规划、需求分析、系统设计、实现与部署、运行与维护五个基本活动组成。

<img src="../../pictures/数据库系统概念-DBAS生命周期.drawio.svg" width="700"/> 

<img src="../../pictures/数据库系统概念-规划与分析的主要工作.drawio.svg" width="500"/> 

# 需求分析

- 需求分析阶段主要的任务是编写需求说明书、构建功能模型（DFD、IDEF0等）、收集各类应用域与问题域的报表等。

- DFD图和IDEF0图的比较：
1. DFD图强调数据流或顺序；而IDEF0图强调数据约束。
2. IDEF模型结构清楚，组成元素简单，更适合大型复杂系统的建模。

## [DFD 数据流图](../MIS/DFD.md)

## [IDEF0](../MIS/IDEF.md)

## [UML的用例模型](../UML/用例视图.md)

# 数据库结构设计

## 概念设计

- 概念设计面向现实世界，通常采用自底向上的方法，通过对需求分析阶段的文档（需求说明书、功能模型DFD/IDEF0等）的分析和理解，抽象出数据的结构、语义、数据之间的相互联系以及数据满足的约束条件，从而构建信息模型，编写数据库概念设计说明书。

### 实体/联系矩阵

- 实体/联系矩阵是标识实体集之间关系的简单方法，如果两个实体集之间存在联系（指的是直接联系），则在矩阵中它们的交叉位置上画叉；若不存在联系，则空白标注。

<img src="../../pictures/数据库系统概念-实体-联系矩阵.drawio.svg" width="300"/> 

### 数据建模方法

#### [E-R 关系数据模型](./数据库设计与应用程序开发.md#E-R模型)

#### [IDEF1X 数据建模方法](../MIS/IDEF.md)

## 逻辑设计

<img src="../../pictures/数据库系统概念-逻辑设计阶段.drawio.svg" width="500"/> 

## 物理设计

### 物理设计概述

- 数据库物理设计的目的是将数据的逻辑描述转换为实现技术规范，其目标是设计数据存储方案，以便提供足够好的性能并确保数据库数据的完整性、安全性和可恢复性。通常，<b>数据库物理设计并不包括文件和数据库的具体实现细节</b>，而是需要了解不同文件组织方式、索引技术及其使用方法。
- 数据库中的应用数据是以文件形式存储在外设存储介质上的，文件在逻辑上组织成记录的序列，文件中的每个逻辑记录被映射到某个特定的磁盘块上。而文件的逻辑记录与磁盘块间的映射关系是由操作系统或DBMS来管理的。
1. 文件的组织
2. 文件的结构
3. 文件的存取
4. 索引技术（Indexing）

### 索引 index

- 索引（index）是记录域（查找码）取值到记录的物理地址间的映射关系。查找码是用于查询的条件所对应的，可以不是主键。索引建立在查找码上。
- 索引加快了数据查询速度，却减慢了数据更新速度（数据更新时需要维护索引），索引本身还会占用一定的存储空间。

#### 索引文件机制

- 索引文件机制（有序索引技术，Ordered Index）利用<b>索引文件（Index File）</b>实现记录域（查找码、排序域）到记录物理地址间的映射关系。（通常情况下，数据库会采用顺序文件结构）
- 索引文件由索引记录（Index Record）组成，每个记录中记载着一个索引项（Index Entry），索引项记录了某个特定的查找码值和具有该值的数据文件记录的物理地址。
- 一个数据库文件上可以建立多个索引文件，数据文件和每个索引文件都根据各自的查找码有序地组织为顺序文件。

##### 聚集索引和非聚集索引

- 对数据文件和它的一个特定的索引文件，如果数据文件中数据记录的排序顺序与索引文件中索引项的排序顺序一致，就称该索引文件为<b>聚集索引（Clustering Index）</b>；否则为<b>非聚集索引（Non-clustering Index）</b>。
- 索引顺序文件（Index-Sequential File）是按照某个查找码组织为顺序文件，且建有聚集索引的数据文件。
- 一个基本表上除了可以建立一个聚集索引外，还可以建立多个非聚集索引。

##### 稠密索引和稀疏索引

- 如果数据文件中的每个查找码值在索引文件中都对应一个索引记录，则该索引被称为<b>稠密索引（Dense Index）</b>；如果只有一部分对应，则称为<b>稀疏索引（Sparse Index）</b>。

##### 主索引和辅索引

- 在数据文件的主码属性集上建立的索引被称为<b>主索引（Primary Key）</b>，而在其他属性集上建立的索引被称为<b>辅索引（Secondary Key）</b>。
- 在RDBMS中，通常按照主码值的顺序将元组有序存储在数据文件中，并以主码作为查找码建立索引文件（即是主索引，也是聚集索引）。

##### 唯一索引

- 唯一索引可以确保索引列不包含重复的值。在多列唯一索引的情况下，可以确保索引列中的每个值的组合都是唯一的。

##### 单层索引和多层索引

- 单层索引（线性索引）根据键值在索引文件中顺序排列，组织成一堆线性结构，每个索引项直接指向数据文件的数据记录。（之前的索引都是单层索引）
- 多层索引是对索引文件中的索引项本身再建立一级稀疏索引。

#### 哈希索引机制

- 哈希(Hash)索引机制（散列技术）利用<b>散列函数（Hash Function）</b>实现记录域（查找码、散列域、排序域）到记录物理地址间的直接映射关系。
- 当需要访问数据文件中查找码值为s<sub>i</sub>的某个或某些目标记录时，将s<sub>i</sub>作为散列函数h的输入，计算得出的散列函数输出值h(s<sub>i</sub>)就是目标记录在数据文件中的物理地址。

### 物理设计内容

- 数据库物理设计主要包括以下环节，每个环节包含若干设计内容：数据库逻辑模式描述、文件组织与存取设计、数据分布设计、确定系统配置、物理模式评估。最终形成<b>数据库物理设计文档</b>。

#### 数据库逻辑模式描述

- 数据库物理设计需要根据数据库逻辑结构信息设计目标DBMS平台可支持的关系表（基本表）的模式信息，代表了所要开发的具体目标数据库的结构。
1. 面向目标数据库描述基本表和视图。不同的RDBMS提供的建立数据库及其数据库对象的语言各不相同（SQL Plus、PL/SQL）。
2. 设计基本表业务规则（完整性约束）。

#### DB文件组织与存取设计

- 根据事务数据访问特性分析结果，可以对基本表设计成更加有效的文件组织和索引方式。

##### 事务-基本表交叉引用矩阵

- 事务-基本表交叉引用矩阵，分析系统内（部分重要的）数据库事务对各个基本表的访问情况，确定事务访问了哪些基本表，对这些基本表执行何种操作，并进一步分析各操作涉及的基本表属性。

<img src="../../pictures/2024-03-20_20-38.png" width="600"/> 

##### 事务的执行频率

1. 估计各事务的执行频率，并分析事务上的每个数据访问操作对各个基本表中的相关属性的操作频率。
2. 对每张基本表，汇总所有作用于该表上的各事务的操作频率信息，得到相关的数据访问估计信息。

##### 选择文件结构的原则

- 为基本表选择合适的文件结构的原则：
1. 如果数据库中的一个基本表中的数据量很少，并且插入、删除、更新等操作非常频繁，则该基本表可以采用<b>堆文件组织方式</b>。

2. <b>顺序文件</b>支持基于查找码的顺序访问，也支持快速的二分查找。

3. 如果用户查询是基于散列域值的等值匹配，特别是如果访问顺序是随机的，则<b>散列文件</b>比较合适。
   
   - 散列文件组织不适合的情况：
   1. 基于散列域值的非精确查询。
   2. 基于非散列域进行的查询。

4. <b>B-树和B<sup>+</sup>树</b>属于动态索引，是实际数据库系统中使用非常广泛的索引文件结构。适合于定义在大数据量基本表、基于查找码的等值查询、范围查询、模糊查询和部分查询。

5. 某些频繁执行且需要进行多表连接操作的查询，可以将这些基本表组织为<b>聚集文件</b>。

##### 设计存取路径以及建立索引的原则

- 设计存取路径的内容包括为数据库文件设计合理的物理存储位置和为基本表设计索引。
- 为基本表建立索引的原则：对于经常需要进行查询、连接、统计操作，且数据量大的基本表可考虑建立索引；而经常执行插入、删除、更新操作或小数据量的基本表应尽量避免建立索引。
- 对于基本表，可考虑在下面一些属性上建立索引：
1. 表的主码，大部分RDBMS会自动为主码建立唯一索引。
2. 在WHERE子句中引用率较高的属性。
3. 参与连接操作的属性。
4. 在ORDER BY子句、GROUP BY子句中出现的属性。
5. 在某一范围内频繁搜索的属性，但只有当使用索引的查询的结果不超过记录总数的20%时，索引才会有明显的效果。
6. 如果在WHERE子句中同时包含一个表中的多个属性，则可以考虑在这些属性上建立多属性索引。如果数据库文件需要频繁执行精确匹配查询，则可考虑建立散列索引；而B<sup>+</sup>树等有序索引更适合于范围查询。
7. 当一个属性有相对较多的不同值时，使用索引有明显的作用；当一个属性的不同值很少时，使用索引没有好处。
8. 对包含大量空值的属性建立索引时需要谨慎考虑，因为大多数的DBMS中的索引不引用具有空值的行，对空值的查找需要使用全表扫描来实现。

#### 数据分布设计

##### 不同类型数据的物理分布

- 不同类型数据的物理分布：各种数据在系统中的作用不同，使用的频率也不同，应根据实际使用情况存放在合适的物理介质，以优化系统I/O性能。
1. 数据库备份数据、日志文件备份数据用于故障恢复，使用频率低，而且数据量大，可以存储在磁带中。

2. 应用数据、索引和日志则使用频繁，要求的响应时间短，必须放在支持直接存取（Direct Access）的磁盘存储介质上。
- 当使用RAID等多磁盘存储系统时，可以将基本表和建立在表上的索引（以及其他可以独立的数据）分别放在不同的磁盘上。这样，存放数据和存放索引的磁盘驱动器并行工作，可以得到较快的文件读写速度。

##### 应用数据的划分与分布

- 可以将一些较大的基本表划分为若干分区，各分区数据分别存储在不同位置的磁盘上，并可采用不同的物理组织方式。
1. 根据数据的使用特征划分。频繁使用分区和非频繁使用分区。
2. 根据时间、地点属性划分。
3. 分布式数据库系统（Distributed DataBase System，DDBS）中的数据划分，原则是数据应靠近起使用者。
   1. 水平划分：将一张基本表划分为多张具有系统属性、结构完全相同的子表，子表包含的元组是基本表中元组的子集（可以有公共元组）。
   2. 垂直划分：将一张基本表划分为多张子表，每张子表包含的属性是原基本表的子集。

##### 派生属性数据分布

##### 关系模式的去规范化

#### 确定系统配置

#### 物理模式评估

# DBAS功能设计与实施

## 软件架构与设计过程

### 软件架构

- 软件体系结构（软件架构）= <code>{构件, 连接件, 约束}</code>，是一种可预制和可重构的软件框架结构。

<table>
    <tr>
        <td width="30%">构件 Component</td>
        <td width="70%">组成系统的具有一定独立功能的不同粒度的程序模块</td>
    </tr>
    <tr>
        <td>连接件 Connector</td>
        <td>将不同的构件连接起来，表示了构件之间的相互作用（通信、调用等）</td>
    </tr>
    <tr>
        <td>约束 Constraint</td>
        <td>一般为对象连接时的规则，或指明了构件连接的条件</td>
    </tr>
</table>

###  软件设计过程

<table>
    <tr>
        <td width="30%">总体结构设计<br/>Architectural Design</td>
        <td width="70%">旨在确定组成软件系统的各主要部件及其相互间关系</td>
    </tr>
    <tr>
        <td>过程设计<br/>Procedural Design</td>
        <td>完成对每一部件的过程化描述</td>
    </tr>
    <tr>
        <td>数据定义<br/>Data Design</td>
        <td>定义了为实现软件所需要的数据结构</td>
    </tr>
</table>

- 从工程管理的角度，软件设计可分为概要设计和详细设计两大步骤。

## DBAS总体设计

- DBAS设计包括结构设计、过程设计、数据设计三个方面，依据自上而下、循序渐进、逐步求精的原则。

### DBAS体系结构设计

- 确定DBAS体系结构是指将系统从功能、层次/结构、地理分布等角度进行分解，划分为多个子系统，定义各子系统应实现的功能；设计系统的全局控制，明确各子系统间的交互和接口关系。

### DBAS软件总体设计

- DBAS软件包括操作系统、数据库管理系统、开发环境、中间件、应用软件（数据库事务和应用程序）。
- 应用软件总体设计从需求分析阶段得到的数据流图、事务规范、业务规则需求分析出发，得到的系统总体结构和分层模块结构可以用<b>模块结构图</b>来表示。
- 在应用软件总体之后的设计工作，数据库事务和应用程序的概要设计和详细设计，均属于数据库应用系统功能设计范畴。

#### [模块结构图](../MIS/模块结构图.md)

### 软硬件选型与配置设计

### 业务规则初步设计

- 数据库应用软件的动态行为体现为各个系统元素相互间的组合、控制和信息传递，可表示为一系列实现系统功能的业务流程和运行控制。这种动态行为实现了应用领域特定的业务规则。

#### [业务流程图 TFD](../MIS/TFD.md)

-  通常DBAS的各项作业活动具有逻辑上的先后关系，因此可表示成一个操作序列，并用业务流程图的形式展示。

## 功能概要设计

### DBAS软件4层架构

<table>
    <caption>DBAS软件4层架构</caption>
    <tr>
        <td rowspan="4" width="40%"><img src="../../pictures/数据库系统概念-DBAS软件4层架构.drawio.svg" width="100%"/></td>
        <td width="15%">表示层</td>
        <td width="45%"></td>
    </tr>
    <tr>
        <td>业务逻辑层</td>
        <td>高内聚、松耦合</td>
    </tr>
    <tr>
        <td>数据访问层</td>
        <td><b>事务概要设计</b>，采用面向数据流的程序设计方法（结构设计方法，SD方法），内容包括事务名称、事务所访问的关系表及关系属性、事务处理逻辑、事务用户（使用、启动、调用该事务的软件模块或系统）</td>
    </tr>
    <tr>
        <td>数据持久层</td>
        <td></td>
    </tr>
</table>

### 事务概要设计

<img src="../../pictures/2024-03-21_09-46.png" width="600"/> 

- 根据事务概要设计的结果，检查关系表对数据库事务的支持性。

1. 对每一个事务，根据需求分析阶段的事务分析，列出该事务所访问的各个数据项。
2. 列出事务访问的数据项所在的关系表和对应的关系属性。
3. 如果事务访问的数据项同时出现在多个表中，检查这些关系表间的关联关系，如主码/外码关联。
4. 检查是否存在某些事务，这些事务所访问的一些数据项未出现在任何关系表中。对这些事务，需要重新修改数据库的概念模型或逻辑结构，或者重新设计事务，以保证DB能够支持所有的数据库事务。

## 功能详细设计

### 表示层详细设计

- 表示层详细设计主要是人机交互界面的设计，通常采用原型迭代法。

<img src="../../pictures/数据库系统概念-基于原型迭代法的用户界面设计.drawio.svg" width="800"/> 

### 业务逻辑层详细设计

## 应用系统安全架构设计

### 数据安全设计

- 从数据存储安全角度出发：

1. 安全性保护
2. 完整性保护
3. 并发控制
4. 数据库的备份和恢复
5. 数据加密传输

#### 数据库的并发控制：封锁技术

- 封锁技术是在某一时间内禁止某一用户对数据对象做某些操作以避免产生数据不一致的问题，主要分为排它锁（x 锁）、共享锁（s锁）。

#####  死锁

- 避免死锁的原则：

1. 按同一顺序访问资源
2. 避免事务中的用户交互
3. 采用小事务模式，尽量缩短事务的长度，减少占有锁的时间
4. 使用绑定连接，是同一应用程序所打开的两个或多个连接可以相互合作。次级连接获得的任何锁可以像由主连接获得的锁那样持有，反之亦然。

#### 数据库的备份和恢复

1. 双机热备：基于Active/Standy方式的服务器热备。
2. 数据转储（数据备份）。
3. 数据加密存储。

#### 数据加密传输

- 常用的数据加密传输手段：数字安全证书、对称密钥加密、数字签名、数字信封。 

### 环境安全设计

1. 漏洞和补丁
2. 计算机病毒防护
3. 网络环境安全：防火墙、IDS（入侵检测系统）、网络隔离。
4. 物理环境安全

### 制度安全设计

- 制度安全设计通常是管理层面的，不是设计人员应该考虑的。

## DBAS实施

- DBAS的实施阶段主要包括：

1. 创建数据库
2. 装载数据
3. 编写与调试应用程序
4. 数据库试运行

<img src="../../pictures/数据库系统概念-DBAS的实施.drawio.svg" width="500"/> 

# 数据库及数据库对象

- 数据库是存储数据及各种数据库对象的容器。

## 数据库文件

## 分区表

- 分区表是将表中的数据按<b>水平方式</b>划分成不同的子集，这些数据子集存储在数据库的一个或多个文件组中，而在逻辑上仍然是一个表。
- 通常，如果某个大型表同时满足如下条件，则适于创建分区表：

1. 包含（或将包含）以多种不同方式使用的大量数据。
2. 数据是分段的（时间、地区等类型的数据）。

## 索引

### 索引视图（物化视图）

- 标准视图（虚拟表）的结果集并不永久地存储在数据库中，每次通过标准视图查询数据时，DBMS都会在内部将视图的定义替换为对基本表的查询语句。
- 物化视图（索引视图）是建有唯一聚集索引的视图。对视图创建唯一聚集索引后，视图的结果集将存储在数据库中。在对基本表的数据更改时，也会将这些更改反映到索引视图存储的数据中。

1. 如果很少更新基础数据，则索引视图的效果最佳；而如果经常更新数据，则需要考虑维护索引视图的成本。
2. 对于经常使用批处理方式定期更新的数据，可以在更新前删除索引视图，再在更新后重新建立索引视图。

- 索引视图通常不会提高以下查询类型的性能：

1. 具有大量写操作的OLTP系统。
2. 具有大量更新操作的数据库。
3. 不涉及聚合或连接的查询。
4.  <code>GROUP BY</code>列具有高基数度（列包含许多不同的值）的数据聚合。

# 安全管理

## 安全控制

<table>
    <tr>
        <td width="20%">安全性 Security</td>
        <td width="80%">保护数据以防止不合法用户故意造成的破坏</td>
    </tr>
    <tr>
        <td>完整性 Integrity</td>
        <td>保护数据以防止合法用户无意中造成的破坏</td>
    </tr>
</table>

- DBA（ DataBase Administrator，数据库管理员）负责数据库系统的安全，任何需要访问数据库的用户（组）都必须首先向DBA申请账户。DBMS中采用了一个加密表来保存用户的账户和密码信息。

<img src="../../pictures/数据库系统概念-计算机系统的安全控制模型.drawio.svg" width="700"/> 

## 存取控制

<table>
    <caption>DBMS的存取控制方式</caption>
    <tr>
        <td width="20%">自主存取控制<br/>Discretionary Control</td>
        <td width="80%">用户对不同的数据对象具有不同的存取权限，而没有固定的关于哪些用户对哪些对象具有哪些存取权限的限制</td>
    </tr>
    <tr>
        <td>强制存取控制<br/>Mandatory Control</td>
        <td>每个数据对象（客体）都被标以一定的密级，每个用户（主体）也都被授予一个许可级别。对于任意对象，只有具有合法许可证的用户才可以存取。具有分层的特点，相对较严格</td>
    </tr>
</table>

### 自主存取控制

- 自主存取控制通过授权机制来控制对敏感数据的访问。

- 权限类型：

1. 对DBMS进行维护的权限
2. 对数据库中的对象和数据进行操作的权限
   1. 语句权限：对数据库对象的操作权限，包括创建、输出、修改数据库对象
   2. 对象权限：对数据库数据的操作权限，包括对表、视图数据的增删改查权限，存储过程的执行权等。
3. 隐含权限：数据库对象拥有者自动具有所拥有对象的全部权限，这一点不能被更改。

- 用户分类：

1. 系统管理员：在数据库服务器上具有全部的权限，系统不会对其权限进行检验。
2. 数据库对象拥有者：创建数据库对象的用户具有该数据库对象的全部权限。
3. 普通用户：只拥有对数据库数据的操作权限。

### 强制存取控制

- 在强制存取控制中，DBMS将全部实体划分为主体和客体。主体是系统中的活动实体，而客体是受主体操纵的被动实体。对于主体和客体，DBMS为它们的每个实例指派一个敏感度标记（Label），主体被指派的是许可证级别（Clearance Level），而客体被指派的是密级（Classificaion Level）。

1. 仅当主体的许可正级别大于或等于客体的密级时，该主体才能读取相应的客体。
2. 仅当主体的许可证级别等于客体的密级时，主体才可以写相应的客体；禁止了高许可证级别的主体更新低密级的数据对象。在有些系统中，允许小于等于客体的密级的写入，也就是说，用户可以为写入的数据对象赋予高于自己的许可证级别的密级。这样，包括他自己也不能读取这个数据对象。

- 支持强制采取控制的DBMS也称为多级安全系统（Multi-Level Secure System）或可信系统（Trusted System）。

### 通用安全型分级模式

> 美国国防部颁布了“橘皮书”和“紫皮书”对强制存取控制作了全面的描述和定义，“橘皮书”定义了任意“可信橘色基”（Trusted Cimpution Base，TCB）应当遵从一系列安全性要求；而“紫皮书”则定义了这些要求在数据库系统中的相应解释。上述两份文献给出了通用安全性分级模式。

- 通用安全型分级模式共定义了D、C、B、A四类安全级别，从D类到A类级别依次增高。D类提供最小（Minimal）保护、C类提供自主（Discretionary）保护、B类提供强制（Mandatory）保护、A类提供验证（Verified）保护。

1. 自主保护。C类分为两个子类C1和C2，C1安全级别低于C2。每个子类都支持自主存取控制，即存取权限由数据对象的所有者决定。
   1. C1子类对所有权与存取权限加以区分，虽然它允许用户拥有自己的私有数据，但仍然支持共享数据的概念。
   2. C2子类还要求通过注册、审计及资源隔离以支持责任说明（Accountability）。
2. 强制保护。B类分为三个子类B1、B2、B3，B1安全级别最低，B3最高。
   1. B1 子类要求“标识化安全保护”，并要求每个数据对象都必须标以一定的密级，同时还要求安全策略的非形式化说明。
   2. B2子类要求安全策略的形式化（formal）说明，能识别并消除隐蔽通道（covert channel)。隐蔽通道的例子有：从合法查询的结果中推断出不合法查询的结果；通过合法的计算推断出敏感信息。
   3. B3子类要求支持审计和恢复以及指定安全管理者。
3. 验证保护。A类要求安全机制是可靠的且足够支持对指定的安全策略给出严格的数学证明。

## 审计跟踪

- 审计跟踪实质上是一种特殊的文件或数据库，系统在上面自动记录用户对常规数据的所有操作。不同系统中的审计跟踪与事务日志是否集成也不同。
- 典型的审计跟踪记录包含的信息如下：操作请求、操作终端、操作人、操作日前和时间、元组,属性和影响、旧值、新值。

## 统计数据库的安全性

- 统计数据库提供基于各种不同标准的统计信息或汇总数据（聚集类信息），但不允许查询单条信息。而在统计数据库中可能存在隐藏的信息通道（从合法的查询中推导出不合法的查询）。

## Oracle的安全管理

- Oracle的安全控制机制可分为数据库级、表级、行级、列级的安全控制。

# 数据库运行维护与优化

## 数据库运行维护基本工作

- 一般来说，维护工作主要包括：数据库的转储和恢复；数据库的安全性和完整性控制；数据库性能的监控分析和改进；数据库的重组和重构。
- 数据库的重新组织并不改变数据库原有设计的逻辑结构和物理结构，而数据库的重构会部分修改数据库的模式和内模式。

## 运行状态监控与分析

- 根据监控分析实现方法的不同，监控分析机制分为两种，由数据库系统建立的自动监控机制、由管理员手动实施的监控机制。
- 根据监控对象的不同，监控分析分为，对数据库架构体系的监控、对数据库性能的监控。

## 数据库存储空间管理

- 数据库的存储结构一般分为逻辑存储结构和物理存储结构，其物理存储结构决定了存储数据时数据文件所占用空间的大小以及分布。

<img src="../../pictures/数据库系统概念-Oracle数据库的存储结构.drawio.svg" width="330"/> 

- 在进行数据库设计时，还需要对数据所需使用的空间进行预测，预测出数据库中初始阶段要存放的数据量，并计算出数据库近两年所需要的空间。在实施阶段就必须以这些空间量为参数，在软硬件环境中为数据库预留出足的空间。

## 数据库性能优化

- 数据库性能优化一般可以从数据库运行环境、数据库参数调整、模式调整、数据库存储优化、查询优化方面考虑。

### 数据库运行环境与参数调整

### 模式调整与优化

- 规范化关系解决了数据维护的异常，并是冗余最小化，然而可能出现数据处理性能下降的问题。
- 而反规范化是将规范化关系转换为非规范化关系的过程，以满足特定的性能优化需要。

<table>
    <caption>反规范化的方式</caption>
    <tr>
        <td width="20%">增加派生性冗余列</td>
        <td width="80%">可以在查询时减少连接操作，避免使用聚合函数；以空间换时间</td>
    </tr>
    <tr>
        <td rowspan="3">增加冗余列</td>
        <td>在多个表中增加具有相同语义的列（非键字段），常用来在查询是避免连接操作。</td>
    </tr>
    <tr>
        <td>主码和外码在多表中的重复出现不属于冗余列</td>
    </tr>
    <tr>
        <td>前提条件是要保证冗余列及其对于数据的一致性</td>
    </tr>
    <tr>
        <td>重新组表</td>
        <td>需要考虑当相关表中的数据变化时，刷新表P的代价</td>
    </tr>
    <tr>
        <td>分割表</td>
        <td>表分割具有水平分割、垂直分割两种方式</td>
    </tr>
    <tr>
        <td>新增汇总表</td>
        <td>将频繁使用的统计操作的中间结果或最终解雇存储在汇总表中</td>
    </tr>
</table>

### 存储优化

#### 物化视图

- 物化视图是包括一个查询结果的数据库对象（可由系统定期刷新其中的数据），物化视图不是在使用时才读取的，而是预先计算并保存表连接或聚集等耗时较多的查询结果。

1. 适合于多个数据量较大的表进行连接操作及分布式数据库中需要进行分布在多站点的表进行连接操作时使用。
2. 物化视图还可以进行远程数据的本地复制（作为快照），主要由于实施数据库间的同步。

#### 聚集

- 聚集（Cluster）是物理存储表中数据的可选择的方法。一个聚集是一组表，可将经常一起使用的具有<b>同一公共列值</b>的多个表中的数据行存储在一起，由它们的公共列构成聚集码。
- 聚集码（Cluster Key）是多表中相关的列，在将记录插入聚集的表中之前，必须要为聚集对象建立一个聚集索引（Cluster Index），且按聚集码进行索引；对于聚集中的多个表，聚集值只存储一次。
- 聚集表的插入、更新、删除性能较差。

### 查询优化

1. 合理使用索引
2. 避免或简化排序
3. 消除对大型表数据的顺序存取
4. 避免复杂的正则表达式
5. 使用临时表加速查询
6. 用排序取代非顺序磁盘存取
7. 不充分的连接条件
8. 存储过程的使用
9. 不要随意使用游标
10. 事务处理

# 故障管理

## 故障的类型与解决

- 在数据库系统中大致存在四类故障，事务（内部的）故障、系统故障、介质故障、计算机病毒故障。

### 事务故障

- 事务内部的故障分为与预期的、非预期的。表明事务没有提交或撤销就结束了，数据库可能处于不准确状态。此时，恢复程序必须强行执行回滚事务，利用日志文件撤销其对数据库的修改。
- 事务故障是由系统自动完成的，对用户透明。

### 系统故障

- 系统故障（软故障）是指数据在运行过程中，由于硬件故障、数据库软件及操作系统的漏洞、突然停电等情况，导致系统停止运转，所有正在运行的事务以非正常方式终止，需要系统重启动的一类故障。这类故障影响正在运行的所有事务。

1. 系统故障将导致易失性存储器内容的丢失，而非易失性存储器内容仍然完好。因此，当发生系统故障时，由于数据库系统会将部分数据缓冲在内存中，一些尚未完成的事务可能已经修改了数据库，还有可能一些已完成的事务的结果尚在内存，没有来得及写回数据库中，从而造成数据库中的数据可能处于不正确的状态。
2. 在计算机系统重新启动后，对于未完成的事务可能已经写入数据库的内容，<b>回滚所有未完成的事务</b>写的结果，以保证数据库中数据的一致性；对于已完成的事务可能部分或全部留在缓冲区的结果，需要<b>重做所有已提交的事务</b>，以将数据库真正恢复到一致状态。

### 介质故障

- 介质故障（硬故障）主要指数据库在运行过程中，由于物理上的情况（现实环境，如火灾、磁盘损坏等），使得数据库中的数据部分或全部丢失的一类故障。

1. 介质故障可能导致物理存储设备损坏，使数据库文件及数据全部丢失。所以，虽然它比前几类故障发生的可能性小，但破坏性最大。
2. 介质故障的容灾对策采用两种方式，一种是软件容错，一种是硬件容错。

<table>
    <caption>介质故障的容灾对策</caption>
    <tr>
        <td rowspan="2" width="10%">软件容错</td>
        <td colspan="2">使用数据库备份及事务日志文件，通过恢复技术，恢复数据库到备份结束时的状态。</td>
    </tr>
    <tr>
        <td colspan="2">对于重要的数据，软件容错有其局限性。如果介质故障真的导致数据库物理存储设备损坏、事务日志文件丢失，那么采用软件容错几乎不能达到数据库的完全恢复，只能恢复到备份数据库后的某个时间点</td>
    </tr>
    <tr>
        <td rowspan="4">硬件容错</td>
        <td colspan="2">硬件容错可以保证介质故障下的数据库能够完全恢复</td>
    </tr>
    <tr>
        <td width="15%" rowspan="2">双物理存储设备</td>
        <td width="75%">例如，双硬盘镜像，使两个硬盘存储内容相同，当一个硬盘出现介质故障时，另一个硬盘中的数据没有被破坏，从而达到数据库完全恢复的效果</td>
    </tr>
    <tr>
        <td>在较高级别的硬件容错方案中需要使用专用的存储设备，由存储设备对其存储的内容实施同步，同时需要考虑将存储设备放置在异地，防止由于自然灾害导致两个存储同时损坏</td>
    </tr>
    <tr>
        <td>双数据库系统</td>
        <td>设计两套相同的数据库系统，通过数据库软件机制，同步变化数据，两套系统空间上有一定的距离，这样当发生自然灾害时，由于两套数据库系统具有空间距离，因此同时破坏两套系统的概率极低，这样就能达到数据库的完全安全</td>
    </tr>
</table>

### 计算机病毒故障

## 数据库恢复技术

- 恢复的基本原理在于数据的冗余。
- 数据库必须具备在故障发生时，能够利用存储在系统其他地方的冗余数据来重建数据中的受损/异常数据，将数据库从错误状态恢复到指定的一个正确状态。
- 在DBMS中，数据库恢复子系统通常占整个系统代码的10%以上。

1. 如何建立冗余数据？
2. 如何利用这些冗余数据实施数据库恢复？

- 最常用的恢复技术是，数据备份（数据转储）和日志文件。

### 数据转储（数据备份）

- 数据转储（数据备份）就是指DBA或数据库管理系统定期复制数据库，并将复制得到的数据存放到其他介质中的过程。保存到其他介质上的副本被称为后援副本或后备副本。
- 在不借助日志文件的情况下，数据库最多只能恢复到最后一次转储时的状态。要想恢复到故障之前的状态，需要结合日志文件进行分析，并参考执行故障之前的所有事务。

#### 静态转储和动态转储

<table>
    <tr>
        <td width="10%">静态转储</td>
        <td width="90%">在静态转储的过程中系统不能运行其他事务，转储前后系统必须处于一个一致性的状态</td>
    </tr>
    <tr>
        <td>动态转储</td>
        <td>允许转储操作和用户事务并发执行，允许转储前后系统的状态不一致，即允许转储期间存在数据更新操作</td>
    </tr>
</table>

- 如果引入日志文件（Log FIle）来记录转储期间各事务对数据库的修改活动记录，然后使用动态转储的备份副本加上日志文件就可以将数据库恢复到某一时刻的正确状态。

#### 数据转储机制

<table>
    <tr>
        <td width="10%">完全转储</td>
        <td width="40%">对数据库中所有数据进行转储</td>
        <td width="50%">转储需要最多的时间和空间；可以用作<b>故障恢复的基础</b>，故障恢复所需的时间最短，</td>
    </tr>
    <tr>
        <td>增量转储</td>
        <td>只复制<b>上次转储后</b>发生变化的文件或数据块</td>
        <td>转储需要最少的时间和空间；但只有搭配完全转储才能对数据库进行恢复，故障恢复所需的时间最长</td>
    </tr>
    <tr>
        <td>差量转储<br/>差异转储</td>
        <td>对<b>最近一次数据库完全转储</b>以来发生的数据变化进行转储</td>
        <td>基于以上二者之间</td>
    </tr>
</table>

- 可以搭配多种转储机制，但不管何种搭配，都需要完全转储作为基础。例如，定期进行完全转储，而其余时间可以选择不转储、增量转储、差量转储等操作。

### 日志文件

#### 日志文件的具体作用

- 日志文件记录每个事务对数据库的修改操作。数据库系统在运行过程中，将所有事务的修改操作登记到日志文件中。

##### 事务故障恢复和系统故障恢复必须使用日志文件

<table>
    <caption>事务故障重做</caption>
    <tr>
        <th width="13.75%">UNDO(T<sub>i</sub>)</th>
        <th width="35%">撤销事务T<sub>i</sub></th>
        <th rowspan="5" width="2.5%"></th>
        <th width="13.75%">REDO(T<sub>i</sub>)</th>
        <th width="35%">重做事务T<sub>i</sub></th>
    </tr>
    <tr>
        <td colspan="2">1. 反向扫描日志文件，找到需要撤销的事务的更新操作</td>
        <td colspan="2">1. 正向扫描日志文件，找到需要重做的事务的更新操作</td>
    </tr>
    <Tr>
        <td colspan="2">2. 对事务T<sub>i</sub>的更新操作执行逆操作（将日志文件中“更新前的值”写入）</td>
        <td colspan="2">2. 对事务T<Sub>i</Sub>重新执行日志文件登记的操作（将日志文件中“更新后的值”写入）</td>
    </Tr>
    <tr>
        <td colspan="2">3. 继续反向查找该事务的其他更新操作，并执行相应的逆操作</td>
        <td colspan="2">3. 继续正向查找该事务的其他更新操作，并重新执行</td>
    </tr>
    <tr>
        <td colspan="2">4. 重复执行步骤3，直至遇到该事务的开始记录</td>
        <td colspan="2">4. 重复执行步骤3，直至遇到该事务的提交记录</td>
    </tr>
</table>
<table>
    <Caption>系统故障重做</Caption>
    <tr>
        <td width="5%">1.</td>
        <td width="95%">正向扫描日志文件，找到系统故障前发生的所有事务，如果该事务没有完成，将其事务标记加入撤销队列；如果该事务已经完成，则将其事务标记加入重做队列</td>
    </tr>
    <Tr>
        <td>2.</td>
        <td>对撤销队列中的所有事务做撤销操作UNDO</td>
    </Tr>
    <tr>
        <td>3.</td>
        <td>对重做队列中的所有事务做重做重做REDO</td>
    </tr>
</table>
##### 在动态转储方式中必须建立日志文件

- 在动态转储中，利用转储文件只能将数据库恢复到转储过程中的某个状态，且转储文件中的数据可能处于不一致状态。只有结合日志文件的使用，才能将数据恢复到一致状态或故障发生前的状态。

##### 在静态转储方式中，也可以使用日志文件

- 在静态转储方式中，当数据库毁坏后，可使用转储文件将数据库恢复到转储结束时刻的状态，然后利用日志文件，把已经完成的事务进行重做处理，对故障发生时尚未完成的事务进行撤销处理。

<img src="../../pictures/数据库系统概念-日志文件的恢复.drawio.svg" width="500"/> 

#### 日志文件的格式与内容

- 不同数据库系统使用的日志文件并不完全一致，日志文件主要有两种格式，以记录为单位的日志文件、以数据块为单位的日志文件。

##### 以记录为单位的日志文件

- 以记录为单位的日志文件内容包括每个事务的开始标记、每个事务的结束标记（包括事务提交记录或事务终止记录），以及每个事务的所有修改操作（标记和结束标记之间）。

<img src="../../pictures/2024-03-21_19-19.png" width="800"/> 

##### 以数据块为单位的日志文件

- 以数据块为单位的日志文件将更新前的整个块和更新后的整个块全都放在了日志文件中，日志记录的内容只需包括事务标记和被更新的数据块，而不需要包括操作类型和操作对象等信息。

#### 登记日志文件的原则

- 为保证数据库是可恢复的，登记日志文件必须遵循两条原则：

1. 登记的次序严格按并行事务执行的时间次序。保证了事务对数据操作的可再现性和正确性。
2. 必须先写日志文件后写数据库。故障的发生是不可预料的，为了数据库的安全，必须先写日志；防止有完成事务因为没有被登记到日志中而无法恢复该事务。

#### 检查点

##### 检查点的意义

- 检查点最大限度地减少了数据库完全恢复时所必须执行的日志部分。
- 检查点记录：在日志文件中引入检查点记录，增加一个“<b>重新开始文件</b>”（用于记录各个检查记录在日志文件中的地址），并让恢复子系统在登录日志文件期间<b>动态地维护日志</b>。检查点记录包括如下内容：

1. 建立检查点时刻所有正在执行的事务清单。
2. 这些事务最近一个日志记录的地址。

##### 动态维护日志文件

- 动态维护日志文件的方法是周期性地执行如下操作：建立检查点、保存数据库状态。恢复子系统可以定期或不定期地建立检查点来保存数据库状态。

1. 将当前日志缓冲中的所有日志记录写入磁盘的日志文件上。
2. 在日志文件中写入一个检查点记录。
3. 将当前数据缓冲的所有数据记录写入磁盘的数据库中。
4. 把检查点记录在日志文件中的地址写入一个“重新开始文件”。

##### 基于检查点的恢复

- 系统出现故障时，恢复子系统将根据事务的不同状态采取不同的恢复策略：

1. 如果事务在故障发生时未完成，则应该予以撤销（UNDO）。
2. 如果事务在检查点之后才提交，它们对数据库所做的修改在故障发生时可能还在缓冲区中，尚未写入数据库，则应该进行重做（REDO）。
3. 如果事务在检查点之前已经提交，则不必执行REDO。

- 系统使用检查点的方法进行恢复的步骤：

1. 从“重新开始文件”中找到最后一个检查点记录在日志文件中的地址，由该地址在日志文件中欧找到最后一个检查点记录。
2. 由检查点记录得到检查点建立时刻所有正在执行的事务清单（ACTIVE-LIST），并建立两个事务队列（UNDO-LIST、REDO-LIST）。
   - UNDO-LIST：需要执行UNDO操作的事务集合。
   - REDO-LIST：需要执行REDO操作的事务集合
3. 将ACTIVITE-LIST暂时放入UNDO-LIST队列，REDO队列暂时为空。
4. 从检查点开始正向扫描日志文件，并进行以下操作，直到日志文件结束。
   1. 如果有新开始的事务T<sub>i</sub>，则把 T<sub>i</sub>暂时放入UNDO-LIST队列。
   2. 如果有提交的事务T<sub>j</sub>，则把T<sub>j</sub>从UNDO-LIST队列移到REDO-LIST队列。
5. 对UNDO-LIST中每个事务执行UNDO操作；对REDO-LIST中的每个事务执行REDO操作。

## 硬件容错方案

### RAID 磁盘阵列

#### RAID概述

- RAID（Redundant Array of Independent Disks，磁盘阵列）是由多块磁盘构成的一个整体，RAID系统可以连接在主机系统上，作为存储数据的介质，具有设备虚拟化的能力。主机系统只能通过一个子系统RAID控制器与这些磁盘构成的虚拟设备进行交互。

<img src="../../pictures/数据库系统概念-RAID磁盘子系统.drawio.svg" width="480"/> 

- RAID依靠其冗余技术，在个别驱动器失败的情况下，数据仍然维持可访问性。

<table>
    <caption>RAID的冗余技术</caption>
    <tr>
        <td width="10%">镜像冗余</td>
        <td width="90%">把所有的数据复制到其他的设备上或其他地方</td>
    </tr>
    <tr>
        <td>校验冗余</td>
        <td>通过对成员磁盘上的数据执行XOR操作得到其校验值，并存放到另外的校验磁盘上（非必须，校验数据和数据也可以是分散到整个阵列中）</td>
    </tr>
</table>

#### RAID的级别

<table>
    <tr>
        <td rowspan="3" width="15%">RAID0</td>
        <td width="85%">向RAID0写入数据时，RAID0将数据分成许多块，然后并行地将它们写到RAID0中的各个硬盘上；读出数据时，RAID0从各个硬盘上读取数据，把这些数据恢复为原来顺序后传给主机</td>
    </tr>
    <tr>
        <td>采用数据分块、并行传送方式，能够提高读写速度</td>
    </tr>
    <tr>
        <td>RAID0中存储空间没有冗余，对系统的可靠性没有任何提高，任一个硬盘介质出现故障时，数据将无法恢复</td>
    </tr>
    <tr>
        <td rowspan="3">RAID1<br/>（ Mirror）</td>
        <td>RAID1中的硬盘分成相同的两组，互为镜像，当其中一块磁盘出现故障时，可以利用其镜像上的数据恢复，从而提高系统的容错能力</td>
    </tr>
    <Tr>
        <td>RAID1对数据的操作仍采用分块后并行传输方式，提高了读速度</td>
    </Tr>
    <tr>
        <td>磁盘的利用率低，冗余度为50%，并没有提供写速度（并行写入的都是相同的镜像数据）</td>
    </tr>
    <tr>
        <td rowspan="3">RAID5</td>
        <td>RAID5也采用数据分块并行传送的方法，但它在数据分块之后计算它们的奇偶校验和，然后把分块数据和奇偶校验信息一并写到硬盘阵列中，在写入时RAID5把奇偶校验信息交叉写到阵列中的每个硬盘上</td>
    </tr>
    <Tr>
        <Td>RAID5可以为系统提供数据安全保障，但保障程度要比RAID1低而磁盘空间利用率要比RAID1高<br/>由于多个数据对应一个奇偶校验信息，RAID5的磁盘空间利用率要比RAID1高，存储成本相对较低</Td>
    </Tr>
    <tr>
        <td>RAID5具有和RAIDO相近似的数据读取速度，只是多了一个奇偶校验信息，写入数据的速度比对单个磁盘进行写入操作稍慢</td>
    </tr>
    <tr>
        <td rowspan="2">RAID10</td>
        <td>RAID0与RAID1的组合体，继承了RAIDO的快速和RAID1的安全</td>
    </tr>
    <Tr>
        <Td>RAID10的冗余度为50%，同时读写速度均提高</Td>
    </Tr>
</table>

#### 软RAID和硬RAID

- RAID从实现上一般可以分为软RAID和硬RAID两种：

<table>
    <tr>
        <td width="10%">软RAID</td>
        <td width="90%">由操作系统或操作系统内专用的软件实现的RAID</td>
    </tr>
    <tr>
        <td>硬RAID</td>
        <td>由专用的硬件设备实现的RAID</td>
    </tr>
</table>

- 在数据库系统的服务器上，一般选择使用硬 RAID，因为硬 RAID一般采用专用的硬件芯片，计算速度快，性能高，维护简单，当磁盘出现故障时可以在不停机的情况下方便更换。同时在高端的硬RAID中，一般带有专用的缓存芯片，可以将部分操作数据缓存在RAID卡的内存中，以提高读写速度。
- 在数据库系统的数据存储中，在成本可以承受的情况下，一般建议采用RAID10，同时建议采用带有缓存的硬RAID。

## 服务器容错技术

### Active-Standby模式

<img src="../../pictures/数据库系统概念-Active-Standby模式架构.drawio.svg" width="500"/> 

- Active-Standby模式：采用两台相同的服务器，两台服务器共享存储设备，其中一台服务运行数据库系统，数据库数据存储在存储设备中。两台服务器之间使用专用的网络（私网）进行检测，当运行服务器出现问题时，由备用服务器接管数据库。由于数据库数据存储在存储设备中，因此，在备用服务器接管数据库业务时，数据库数据保持一致状态。

- 服务器接管过程：公有网络为客户端和数据库服务器连接的网络，私有网络为两台数据库服务器之间检测状态的网络（<b>心跳检测</b>）。当运行服务器出现故障时，备用服务器将自身角色转换为运行服务器，接管原有运行服务器的资源（共享存储资源、服务器IP地址）。客户端无需做任何操作。<b>运行服务器和备用服务器之间的切换本质上是数据库重新启动的过程</b>，会中断所有的数据库连接。
- 脑裂：如果私有网络出现故障，导致备用服务器无法连接到运行服务器，那么备用服务器会认为运行服务器异常。于是，备用服务器会启动接管过程，强行接管服务器IP地址和共享存储（脑裂）。而当备用服务器接管相关资源后，主服务器转变为备用服务器后，又会重复上述过程。（因此，还需要保证有多余的检测方式来避免脑裂的发生）
- Active-Standby工作模式一般和数据库系统无关，数据库系统无需了解自身运行于什么模式中，适用性强；但对计算机资源较浪费。

### Oracle RAC架构

## 数据库镜像与数据库容灾

