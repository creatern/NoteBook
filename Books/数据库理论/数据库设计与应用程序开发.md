# E-R模型

## 数据库设计过程概述

### 设计阶段

<table>
    <tr>
        <td width="15%">最初阶段</td>
        <td width="20%">用户需求规格说明</td>
        <td width="65%">完整地描述未来数据库用户的数据需求</td>
    </tr>
    <tr>
        <td rowspan="3">概念设计阶段<br/>（conceptual-design）</td>
        <td>概念模式</td>
        <td>概念模式明确规定了数据库中表示的实体、实体的属性、实体之间的联系，以及实体和联系上的约束</td>
    </tr>
    <tr>
        <td>E-R图</td>
        <td>通常该阶段会导致实体-联系图（E-R图）的构建，提供对模式的图形化支持</td>
    </tr>
    <tr>
        <td>功能需求规格说明<br />（specification of functional requirement）</td>
        <td>企业的功能需求，用户描述将在数据上执行的各类操作（事务）；设计者检查模式以确保其满足功能需求</td>
    </tr>
    <tr>
        <td>逻辑设计阶段<br />（logical-design phase）</td>
        <td>关系数据模型</td>
        <td>设计者将高层概念模式映射到将被使用的数据库系统具体实现的数据模型，通常是关系数据模型。通常包括将采用实体-联系模型定义的概念模式映射到关系模式</td>
    </tr>
    <tr>
        <td>物理设计阶段<br />（physical-design phase）</td>
        <td></td>
        <td>数据库的物理特性被具体说明</td>
    </tr>
</table>

### 设计选择

1. 冗余：信息的冗余表达最大的问题是，如果对一条信息进行了更新却没有更新其全部的拷贝，那么这条信息的拷贝将会不一致。
2. 不完整

## 实体-联系模型（E-R数据模型）

- 实体-联系模型（E-R数据模型）通过允许定义代表数据库全局逻辑的企业模式（enterprise schema）来方便数据库的设计。
- E-R数据模型采用了三个基本概念：实体集、联系集、属性；一种相关联的图形表示：E-R图（E-R diagram）。

<table>
    <tr>
        <td width="20%"><a href="#实体集">实体集</a><br/>（entity set）</td>
        <td width="40%">共享相同性质或属性的、具有相同类型的实体的集合</td>
        <td width="40%">矩形，第一部分表示实体集名称，第二部分表示实体集所有属性的名称（仅在第一次出现时列出该部分即可），后续再次出现相同的实体集，则应该只保留第一部分</td>
    </tr>
    <tr>
        <td><a href="#联系集">联系集</a><br />（relationship set）</td>
        <td>相同类型的联系的集合</td>
        <td>菱形，通过线条连接到多个不同的实体集</td>
    </tr>
    <tr>
        <td><a href="#属性">属性</a><br />（attribute）</td>
        <td>实体集中每个成员所拥有的描述性性质</td>
        <td></td>
    </tr>
</table>

<img src="../../pictures/数据库系统概念-E-R实体集和联系集.drawio.svg" width="450"/> 

### 实体集

- 实体（entity）：一个实体是现实中可区别于所有其他对象（唯一性）的一个“事物”或“对象”（具体、抽象）。每个实体有一组性质，并且某些性质集合的值必须唯一地标识一个实体。实体通过一组[属性](#属性)来表示。
- <span name="实体集">实体集（entity set）</span>：共享相同性质或属性的、具有相同类型的实体的集合。

- 实体集的外延（extension）：属于实体集的实体的实际集合。如大学中教师的实际集合构成了instructor实体集的外延。

### 联系集

- 联系（relationship）：多个实体间的相互关联。

- <span name="联系集">联系集</span>（relationship set）：相同类型联系的集合。
- 联系实例（relationship instance）：E-R模式中的一个联系实例表示在所建模的现实企业中被命名的实体之间的一种关联。
- 联系集是在n&ge;2个（可能相同的）实体集上的数学关系。如果E<sub>1</sub>,E<sub>2</sub>,...,E<sub>n</sub>为实体集，那么联系集R是<code>{(e<sub>1</sub>,e<sub>2</sub>,...e<sub>n</sub>)|e<sub>1</sub>&isin;E<sub>1</sub>,e<sub>2</sub>&isin;E<sub>2</sub>,...,e<sub>n</sub>&isin;E<sub>n</sub>}</code>的一个子集，其中（e<sub>1</sub>,e<sub>2</sub>,...,e<sub>n</sub>）是一个联系实例。
- 实体集之间的关联被称为参与（participate），即实体集E<sub>1</sub>,E<sub>2</sub>,...,E<sub>n</sub>参与联系集R。实体在联系中扮演的功能被称为实体的角色（role），在E-R图中实体集和联系集之间的连线上标注出角色。

1. 如果参与一个联系集的实体集是互异的，则角色通常是隐含的且并不指定。
2. 如果同样的实体集以不同的角色多次参与一个联系集，则有必要使用显式的角色名来指明实体是如何参与联系实例的，此类联系集也被称为递归的联系集（recursive）。

- 描述性属性（descriptive attribute）：联系也可以具有多个被称为描述性属性的属性。在E-R图中使用未分割的矩形来表示，使用虚线将该矩形与表示该联系集的菱形相连接。

<img src="../../pictures/数据库系统概念-E-R角色和描述性属性.drawio.svg" width="600"/> 

- 联系集的度（degree）：参与联系集的实体集的数目。二元联系集（binary relationship set）的度为2，三元联系集（ternary relationship set）的度为3。

### 属性

- <span name="属性">属性</span>（attribute）是实体集中每个成员所拥有的描述性性质。为实体集设计一个属性表明数据库存储关于该实体集中每个实体的类似信息，每个实体在他的每个属性都有一个值。

- 域（domain）或 值集（value set）：对于每个属性都有一个可取值的集合，称为该属性的域或值集。

<table>
    <tr>
        <td width="30%">简单属性（simple）</td>
        <td width="70%">不能被划分为子部分的属性</td>
    </tr>
    <tr>
        <td rowspan="2">复合属性（composite）</td>
        <td>可以被划分为子部分（其他属性）的属性，如电话号码可以被划分为区域号等部分</td>
    </tr>
    <tr>
        <td>若用户希望在一些场景中引用整个属性，而在另外的场景中仅引用属性的一部分，则可以选择采用复合属性</td>
    </tr>
    <tr>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>单值属性（single-valued）</td>
        <td>一个属性只对应一个值</td>    </tr>
    <tr>
        <td>多值属性（multivalued）</td>
        <td>一个属性可能对应于一组值（0..n）</td>
    </tr>
    <tr>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td rowspan="2">派生属性（derived attribute）</td>
        <td>该类属性的值可以从其他相关属性或实体的值派生出来。派生属性的值并不存储，而是在需要时被计算出来</td>
    </tr>
    <tr>
        <td>基属性（base）或存储的属性（stored），用于计算出派生属性的值</td>
    </tr>
</table>
<img src="../../pictures/数据库系统概念-复杂属性.drawio.svg" width="300"/> 

### 映射基数

- 映射基数（mapping cardinality，基数比率）表示一个实体能通过一个联系集关联的另一些实体的数量，可用于指定关于现实世界中允许哪些联系的约束。
- 对于实体集A和B之间的二元联系集R来说，映射基数必然是以下情况之一：一对一、一对多、多对一、多对多。

#### 有向线段或无向线段

- 在E-R图表示法中，通过在联系集和相关实体集之间绘制有向线段或无向线段来指明联系上的基数约束。

<img src="../../pictures/数据库系统概念-基数映射.drawio.svg" width="880"/> 

<table>
    <tr>
        <td width="10%">全部参与</td>
        <td width="80%">如果实体集E中的每个实体都必须参与到联系集R中的至少一个联系中，那么实体集E在联系集R中的参与就是全部的</td>
        <td width="10%">双线</td>
    </tr>
    <tr>
        <td>部分参与</td>
        <td>如果实体集E中的一些实体可能不参与到联系集R中的联系中，那么实体集E在联系集R中的参与就是部分的</td>
        <td>单线</td>
    </tr>
</table>

<img src="../../pictures/数据库系统概念-全部参与部分参与.drawio.svg" width="450"/> 

#### l..h

- 在E-R图中提供了描述更复杂的约束的方式，即限制了每个实体参与联系集中的联系的次数的约束。在线段上可以有一个关联的最小和最大基数，用`l..h`的形式表示，`l`表示最小基数、`h`表示最大基数。

1. 最小值为1表示实体集全部参与联系集，即实体集中的每个实体在该联系集中的至少一个联系中出现。
2. 最大值为1表示实体至多参与一个联系；而最大值为`*`则表示没有限制。

<img src="../../pictures/数据库系统概念-lh基数映射.drawio.svg" width="450"/> 

### 主码

#### 实体集

- [关系模式](./关系语言.md#码)中的超码、候选码、主码的概念适用于实体集。

#### 联系集

- 联系集主码的构成依赖于与联系集R相关联的属性集合。

##### 二元联系集

- 二元联系集主码的选择取决于联系集的映射基数。若存在联系集R涉及实体集E<sub>1</sub> E<sub>2</sub>,..,E<sub>n</sub>，实体集E<sub>i</sub>的主码为primary-key(E<sub>i</sub>)，则：

<table>
    <tr>
        <th>情况</th>
        <th>联系集的主码</th>
    </tr>
    <tr>
        <td width="10%">多对多</td>
        <td width="90%">primary-key(E<sub>1</sub>)&cup;primary-key(E<sub>2</sub>)&cup;..&cup;primary-key(E<sub>n</sub>)</td>
    </tr>
    <tr>
        <td>一对多<br/>多对一</td>
        <td>“多”方的主码是最小的超码，并作为联系集的主码</td>
    </tr>
    <tr>
        <td>一对一</td>
        <td>任一参与实体集的主码都构成最小超码，并可任意选择一个作为联系集的主码</td>
    </tr>
</table>

##### 非二元联系集

- 对于非二元联系集，如果不存在基数约束，那么其唯一的候选码就是primary-key(E<sub>1</sub>)&cup;primary-key(E<sub>2</sub>)&cup;..&cup;primary-key(E<sub>n</sub>)。
- 对于非二元联系集，如果存在基数约束，假设实体集E<sub>1</sub>、E<sub>2</sub>、E<sub>3</sub>、E<sub>4</sub>之间有联系集R，并且只有指向实体集E<sub>3</sub>和E<sub>4</sub>的边带箭头，那么

#### 弱实体集

- 弱实体集（weak entity set）存在依赖于标识性实体集（identifying entity set），标识性实体集被称为拥有它所标识的弱实体集。通过使用标识性实体集的主码以及被称为分辨符属性（discriminator attribute）的额外属性来唯一地标识弱实体（作为弱实体集的主码），而不是将主码与弱实体集相关联。非弱实体集的实体集被称为强实体集（strong entity set）。
- 标识性联系（identifying relationship）是将弱实体集与标识性实体集相关联的联系，是从弱实体集到标识性实体集的多对一联系，并且弱实体集在联系中的参与是全部的。标识性联系不应该有任何描述性属性。
- 弱实体集可以参与除标识性联系之外的其他联系。若实体集可以作为属主参与与一个弱实体集的标识性联系。一个弱实体集也可能与不止一个标识性实体集相关联。
- 在E-R图中，通过双边框的矩形描述弱实体集，其分辨符被加上虚的下划线。标识性联系使用双边框的菱形来表示。

<img src="../../pictures/数据库系统概念-弱实体集.drawio.svg" width="600"/> 

## 从实体集删除冗余属性

- 将实体集中的实体和另一个实体集中的实体的关联统一看成联系，通过联系集来实现，而不是作为它们的一个属性（导致冗余），从而使得逻辑关系明确，并有助于避免过早的假设基数约束。

## 将E-R图转换为关系模式

