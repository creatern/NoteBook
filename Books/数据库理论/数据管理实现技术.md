# 存储管理

- 尽管数据库系统提供了数据的高级视图，但最终必须将数据以位的形式存储在一个或多个存储设备上。数据库系统将数据提取到主存中进行处理，并将数据写回存储器以保持持久性。数据也被复制到磁带和其他备份设备以进行归档存储。

## [物理存储介质](../Computer/Memory.md)

## 记录

- 一个数据库被映射为多个不同的文件，这些文件由底层的操作系统来维护，并永久地驻留在磁盘（块）上。
- 一个文件在逻辑上被组织为记录的一个序列，每个文件还从逻辑上被分成定长的存储单元，也就是块（block）。块是存储分配和数据传输的单位，大多数数据库默认使用4KB至8KB的块规模。
- 一个块可能包含多条记录，要求每条记录被完全地包含在单个块中；一个块所包含的确切的数据集合是由所使用的物理数据组织形式来决定的。

> 对于一些大数据项可能比块要大的，通过存储其指针来处理。

### 定长记录

- 在关系数据库中，不同关系的元组通常具有不同的规模。把数据库映射到文件的一种方法使用多个文件（定长记录文件），在任意给定的文件中只存储一种固定长度的记录（定长记录）。另一种方法是构造自己的文件（变长记录文件）。

1. 一个块只分配它能完整容纳的最多记录的数目，余下的字节不使用。以避免有的记录被分为两个块来存储，而导致对一条记录需要进行两次访问。
2. 文件头（file header）：在文件的开头分配特定数量的字节作为文件头。文件头中包含有关文件的各种信息，其中存储着的包括内容被删除的第一条记录的地址（指针，pointer），并在这个被删除内容的记录位置存放下一个被删除内容的记录的地址，从而形成了一条自由链表（free list）。在插入一条新记录时，使用文件头所指向的记录，并改变文件头的指针以指向下一条可用（被删除内容的）记录，如果没有可用的空间，就把新记录加到文件末尾。

<img src="../../pictures/数据库系统概念-定长记录文件.drawio.svg" width="450"/> 

### 变长记录

#### 变长记录

- 变长记录（variable-length record）通常是为了处理变长域（字符串等）、包含重复域的记录类型（数组、多重集合等）、文件中多种记录类型的出现等。

- 具有变长属性的记录通常包含两个部分：

1. 首先是带有定长信息的初始部分。定长属性以正常形式存储；而变长属性在记录的初始部分中被表示为一个`(偏移量, 长度)`对，其中偏移量表示在记录中该属性的数据开始的部分，而长度表示变长属性的字节长度。
2. 紧接着变长属性的内容，被分配存储这些属性的值所需的字节数。多个变长属性的值是连续存储的。

<img src="../../pictures/数据库系统概念-变长记录文件.drawio.svg" width="700"/> 

- 空位图（null bitmap）表示记录的哪个属性是空值，对于取空值的属性根本不存储数据（值、偏移量、长度）。该方式以提取记录属性的额外工作为代价来节省存储空间。

#### 分槽的页结构

- 分槽的页结构（slotted-page structure）一般用于在块中组织记录。每个块的开始处有一个块头，其中包含以下信息：

1. 块中记录项的数量。
2. 块中自由空间的末尾处。
3. 一个由包含每条记录的位置和大小的项组成的数组。

<img src="../../pictures/数据库系统概念-分槽的页结构.drawio.svg" width="700"/> 

- 实际记录从块的末尾处开始在块中连续分配空间。块中的自由空间是连续的，位于块头数组的最后一项和第一条记录之间。如果插入一条记录，在自由空间的尾部给这条记录分配空间，并且将包含这条记录的大小和位置的项加到块头中。
- 如果一条记录被删除，其所占用的空间被释放，并且它的项被置为`deleted`；此外，块中位于被删除记录之前的记录将被移动（防止在块的内部存在碎片空间），使得由删除而产生的自由空间能被重新使用，并且所有自由空间仍然位于块头数组的最后一项和第一条记录之间；块头中的自由空间末尾指针也要适当修改。（移动记录的代价并不太高，因为块的大小是有限的）
- 分槽的页结构要求没有指针直接指向记录，而是让指针必须执行块头中记有记录实际位置的项（间接指针），从而允许移动记录。

### 大对象存储

- SQL支持二进制大对象数据类型（blob）、字符大对象数据类型（clob）。大部分的数据库限制一条记录的规模不能大于一个块的规模（以简化缓冲区管理），但允许记录在逻辑上包含大对象。一个指向大对象的（逻辑）指针被存储到包含该大对象的记录中。

- 大对象（large object）可以以文件形式存储在被数据库管理的一个文件系统区域中，或者作为文件结构（<a href="#B+树文件组织">B<sup>+</sup>树文件组织</a>）存储在数据库中并被数据库管理。

<table>
    <tr>
        <td rowspan="2" width="10%">存储在数据库内部</td>
        <td width="90%">存储在数据库中的大对象可以选用B<sup>+</sup>树文件组织来表示。B<sup>+</sup>树文件组织允许读取一个完整的对象、或对象中指定的字节范围，以及插入和删除对象的一部分</td>
    </tr>
    <tr>
        <td>通过数据库接口访问对象的效率是一个需要关注的问题；在数据库中存储大对象会导致数据库转储规模的大量增长</td>
    </tr>
    <tr>
        <td rowspan="3">存储在数据库之外</td>
        <td>应用程序可以将文件名（文件系统中的路径）存储为数据库中记录的一个属性。</td>
    </tr>
    <tr>
        <td>如果存储在数据库外部的文件并不存在（例如被删除），则会导致某种形式的外码约束冲突。此外，数据库授权不适用于存储在文件系统中的数据</td>
    </tr>
    <tr>
        <td>一些数据库支持文件系统和数据库的集成，以此满足约束（例如阻止文件的错误删除），并且确保访问授权被执行；文件能够通过文件系统接口和数据库SQL接口进行访问。Oracle通过SecureFiles和数据库文件系统特性来支持这种集成</td>
    </tr>
</table>
## 文件组织

### 堆文件组织

- 堆文件组织（heap file organization）：任意文件可以放在文件中的任何地方，只要哪个地方有空间存放这条记录。记录是没有顺序的。通常每个关系使用一个单独的文件或一个文件的集合。

### 顺序文件组织

- 顺序文件组织（sequential file organization）

### 多表聚簇文件组织

- 多表聚簇文件组织（multitable clustering file organization）

### B<sup>+</sup>树文件组织

- <span name="B+树文件组织">B<sup>+</sup>树文件组织</span>（B<sup>+</sup>-tree file organization）

### 散列文件组织

- 散列文件组织（hashing file organization）
