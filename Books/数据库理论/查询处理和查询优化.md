# 查询处理和查询优化概述

- 查询处理（query processing）是指从数据库中提取数据所涉及的一系列活动。这些活动包括：将用高层数据库语言表示的查询语句翻译为能在文件系统的物理层上使用的表达式、各种查询优化转换、以及查询的实际执行。
- 查询处理的基本步骤包括：语法分析与翻译、优化、执行。

 <img src="../../pictures/数据库系统概念-查询处理的步骤.drawio.svg" width="600"/>

1. 在查询处理开始之前，系统必须将查询语句翻译成可使用的形式（系统的内部表示形式）。
2. 在产生查询语句的系统内部表示形式的过程中，语法分析器检查用户查询的语法，验证出现在查询中的关系名就是数据库中的关系名等。
3. 系统构造该查询的语法分析树表示形式，然后将之翻译成[关系代数表达式](./形式化关系查询语言.md)。
4. 如果查询是用视图形式来表示的，在翻译阶段还要用定义该视图的关系代数表达式来替换所有对该视图的引用。
5. 如果物化视图，则定义视图的表达式已经执行并存储了结果。因此，可以使用存储的关系，而不是使用由定义视图的表达式来替换的视图。
6. 如果是递归视图，则通过不动点过程来处理。

> 一些数据库系统并不使用关系代数表示形式，而是采用基于给定的SQL查询结构、带注释的语法分析树表示形式。

- 给定一个查询，通常会有多种用于计算结果的方法。

1. 一个查询能够用几种不同的方式来表示，可以用其中的一种方式来将每条SQL查询本身翻译成关系代数表达式。
2. 此外，一个查询的关系代数表达式仅仅部分指定了如何执行查询；通常有多种方式来执行关系代数表达式。

- 为了全面说明如何执行一个查询，不仅要提供关系代数表达式，还要对表达式加上带指令的注释来说明如何执行每种运算。这些注释可以说明为一种具体运算所采用的算法，或要使用的一个具体索引或多个索引。

1. 带有“如何执行”注释的关系代数运算称为<b>执行原语（evaluation primitive）</b>。
2. 用于执行一个查询的原语操作序列称为<b>查询执行计划（query-execution plan、query-evaluation plan）</b>。
3. <b>查询执行引擎（query-execution engine）</b>接受一个查询执行计划，执行该计划并把结果返回给查询。

- 对于给定查询的不同执行计划会有不同的代价。而构造具有最小查询执行代价的查询执行计划应当是系统的责任，这也就是<b>查询优化（query optimization）</b>。一旦选定了查询计划，就用该计划来执行查询并输出查询的结果。

# 查询代价的度量

- 为了优化一个查询，查询优化器必须知晓每种运算的代价（尽管大多数只能是粗略的估计），以此来根据不同的代价来选择最佳的执行计划。
- 查询执行的代价可以以不同资源的形式来进行度量，这些资源包括产品存取、执行一个查询所用的CPU时间、并行和分布式数据库系统中的通信代价。

1. 对于驻留在磁盘上的大型数据库，从磁盘访问数据的I/O代价通常是最主要的代价。
2. 当数据驻留在内存或SSD中时，I/O代价并不总是最主要的代价，并且在计算查询执行代价时，必须包括CPU代价。CPU代价可以通过简单的估计来近似得出。数据库具有每种类似于PostgreSQL的代价模型中的代价的缺省值，这些缺省值可以分别乘以被处理元组的数量、被处理索引项的数量以及被执行算子和函数的数量等。缺省值可以作为配置参数被更改。

- 通常使用<q>从存储中传输的块数</q>以及<q>随机I/O访问数</q>作为估计查询执行计划的代价的两个重要因素，因为二者都需要在磁盘存储器上进行磁盘寻道。

1. 如果磁盘子系统传输一个数据块平均要花费t<sub>T</sub>秒，并且平均的块访问时间（磁盘寻道时间+旋转延迟）为t<sub>s</sub>秒，那么一个传输b个块并执行S次随机I/O访问的运算将要花费<code>b\*t<sub>T</sub> + S\*t<sub>S</sub></code>秒。
2. t<sub>T</sub>和t<sub>S</sub>的值必须针对所使用的磁盘系统进行标定。
   1. t<sub>T</sub> = 块规模 / 传输率
   2. t<sub>S</sub> = (1/N) - t<sub>T</sub> ，其中，N是设备所支持的每秒随机I/O操作数。一次随机I/O操作执行一次随机I/O访问，后接一个块的数据传输。

- 尽管SSD并不执行物理寻道操作，但SSD在启动I/O操作时有一个开销。
























