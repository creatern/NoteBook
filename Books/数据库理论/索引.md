# 索引概述

- 索引（index）对数据库中查询的高效处理至关重要，如果没有索引，每个查询最终都将读取它所使用的每个关系的全部内容。


1. 索引是记录域（查找码、搜索码）取值到记录的物理地址间的映射关系。搜索码是用于在文件中查找记录的属性或属性集，可以不是主键。索引建立在搜索码上，如果一个文件有多个索引，那么该文件就有多个搜索码。
2. 索引加快了数据查询速度，却减慢了数据更新速度（数据更新时需要维护索引），索引本身还会占用一定的存储空间。

<table>
    <caption>基本的索引类型</caption>
    <tr>
        <td width="25%">顺序索引（ordered index）</td>
        <td width="75%">基于值的顺序排序</td>
    </tr>
    <tr>
        <td>散列索引（hash index）</td>
        <td>基于将值平均分布到若干桶中，一个值所属的桶是由一个散列函数（hash function）决定的</td>
    </tr>
</table>

<table>
    <caption>对每种索引技术的评价都必须基于以下元素</caption>
    <tr>
        <td width="25%">访问类型（access type）</td>
        <td width="75%">能有效支持的访问类型，包括找到具有特定属性值的记录，以及找到属性值落在某个特定范围内的记录</td>
    </tr>
    <tr>
        <td>访问时间（access time）</td>
        <td>在查询中使用该技术找到一个特定数据项或数据项集所花费的时间</td>
    </tr>
    <tr>
        <td>插入时间（insertion time）</td>
        <td>插入一个新数据项所花费的时间，包括找到插入者这个数据项的正确位置所花费的时间，以及更新索引结构所花费的时间</td>
    </tr>
    <tr>
        <td>删除时间（deletion time）</td>
        <td>删除一个数据项所花费的时间，包括找到待删除项所花费的时间，以及更新索引结构所花费的时间</td>
    </tr>
    <tr>
        <td>空间开销（space overhead）</td>
        <td>索引结构所占用的额外空间。如果这种额外空间的规模适度，则通常值得牺牲一定的空间来换取性能的提升</td>
    </tr>
</table>

# 顺序索引

## 顺序索引和索引文件机制

-  顺序索引（ordered index）或索引文件机制（有序索引技术，Ordered Index）依照排好的顺序存储搜索码的值，并将每个搜索码与包含该搜索码的记录关联起来。

1. 索引文件机制利用索引文件（Index File）实现记录域（查找码、排序域）到记录物理地址间的映射关系。通常情况下，数据库会采用顺序文件结构，此时，使用顺序索引能极大地提升查询的效率。
2. 索引文件由索引记录（Index Record）组成，每个记录中记载着一个索引项（Index Entry），索引项记录了某个特定的查找码值和具有该值的数据文件记录的物理地址。
3. 一个数据库文件上可以建立多个索引文件，数据文件和每个索引文件都根据各自的查找码有序地组织为顺序文件。

- 索引项（index entry）或索引记录（ index record）由一个搜索码值和指针构成，这些指针指向具有该搜索码值的一条或多条记录。指向一条记录的指针由磁盘块的标识和标识出块内记录的磁盘块内偏移量所组成。

## 聚集索引和非聚集索引

- 对数据文件和它的一个特定的索引文件，如果数据文件中数据记录的排序顺序与索引文件中索引项的排序顺序一致，就称该索引文件为聚集索引（clustering index）或主索引（primary index）；否则为非聚集索引（non-clustering index）或辅助索引（secondary index）。也就是，<q>聚集的（clustered）</q>与<q>非聚集的（nonclustered）</q>。（主索引可以建立在任何索引码上，不仅仅是主码）
- 一个基本表上除了可以建立一个聚集索引外，还可以建立多个非聚集索引。

> 对于主索引和辅索引的另一种解释：
>
> 1. 在数据文件的主码属性集上建立的索引被称为主索引（Primary Key），而在其他属性集上建立的索引被称为辅索引（Secondary Key）。
> 2. 在RDBMS中，通常按照主码值的顺序将元组有序存储在数据文件中，并以主码作为查找码建立索引文件（即是主索引，也是聚集索引）。

### 顺序索引文件

- 索引顺序文件（index-sequence file）是按照某个查找码组织为顺序文件，且建有聚集索引的数据文件；是针对既需要顺序处理整个文件又需要随机访问单条记录的应用而设计的。假定所有文件都按照某种搜索码顺序存储，而在这种搜索码上有聚集索引的文件被称为索引顺序文件。

## 稠密索引和稀疏索引

- 如果数据文件中的每个搜索码值在索引文件中都对应一个索引记录（或索引项），则该索引被称为稠密索引（Dense Index）；如果只有一部分对应，则称为稀疏索引（Sparse Index）。

1. 在稠密聚集索引中，索引记录包括搜索码值以及指向具有该搜索码值的第一条数据记录的指针。具有相同搜索码值的其余记录会顺序地存储在第一条记录之后，且由于是聚集索引，记录还会根据相同的搜索码值进行排序。
2. 在稠密非聚集索引中，索引必须存储指向具有相同搜索码值的所有记录的指针列表。

- 稀疏索引只会为一部分搜索码值建立索引项，只有索引是聚集索引时才会使用稀疏索引。基于此，为了定位一条记录，需要进行如下步骤：

1. 找到所具有的最大搜索码值小于或等于所记录的搜索码值的索引项。
2. 从该索引项指向的记录开始，沿着文件的指针查找（因此需要索引项和数据项的次序一致，也就是聚集索引），直到找到索引记录为止。

- 稀疏索引占用的空间较小，所需的插入和删除时的维护开销也较小。

## 唯一索引

- 唯一索引可以确保索引列不包含重复的值。在多列唯一索引的情况下，可以确保索引列中的每个值的组合都是唯一的。

## 多级索引

- 单层索引（线性索引）根据键值在索引文件中顺序排列，组织成一堆线性结构，每个索引项直接指向数据文件的数据记录。（之前的索引都是单层索引）
- 多级索引（ multilevel indices）是具有两级或两级以上的索引，是对索引文件中的索引项本身再建立一级或多级的稀疏索引。像对待其他任何顺序文件一样对待索引（索引项总是有序的），并在原始的索引上（内层索引）构造一个稀疏的外层索引。
- 系统设计者必须在存取时间和空间开销之间进行权衡。尽管具体应用具体分析，但为每个块建立一个索引项的稀疏索引（多级索引）是一种较好的折中方案。因为处理一个数据库查询的开销主要是把块从磁盘读到主存中所花费的时间来决定，而一旦将块放入主存中，扫描整个块的时间就是可以忽略的。通过使用多级索引（在索引项上建立的稀疏索引），可以定位到包含所要查找的记录的块。只要记录不在一个溢出块中，就能使块访问次数最小，同时能保持索引的规模（以及空间开销）尽可能小。

## 索引的更新算法

- 在文件中的记录被更新的情况下，其搜索码值受更新影响的任何索引也必须更新。如果一个文件有多个索引，则无论何时修改该文件，都必须更新每个索引。
- 对于索引的更新算法，多级索引和单级索引的本质是一样的。多级索引只不过是在内层索引执行完更新算法后，再将内层索引当作数据文件，继续让外层索引执行更新算法，以此向外一级级地更新。

### 插入

- 系统首先用出现在待插入记录中的搜索码值执行查找，系统根据索引是稠密的还是稀疏的来进行下一步操作。
- 稠密索引：

1. 如果该搜索码值并未出现在索引中，系统就在索引中适当的位置插入带有该搜索码值的索引项。否则执行如下操作。
2. 如果索引项存储的是指向具有相同搜索码值的所有记录的指针，那么系统就在索引项中增加一个指向新记录的指针。
3. 否则，索引项存储一个仅指向具有相同搜索码值的第一条记录的指针，系统把待插入的记录放到具有相同搜索码值的其他记录之后。

- 稀疏索引：假设索引为每个块保存一个索引项。

1. 如果系统创建了一个新的块，那么它会将出现在新块中的第一个搜索码值（按照搜索码的次序）插入索引中。
2. 如果这条新插入的记录具有它所在块中的最小搜索值，那么系统就更新指向该块的索引项；否则，系统对索引不做任何改动。

### 删除

- 为了删除一条记录，系统首先要找到待删除的记录。系统下一步要执行的操作取决于索引是稠密的还是稀疏的。
- 稠密索引：

1. 如果待删除的记录是具有这个特定搜索码值的唯一的一条记录，则系统就从索引中删除相应的索引项。否则执行如下操作。
2. 如果索引项存储的是指向具有相同搜索码值的所有记录的指针，那么系统就从索引项中删除指向待删除记录的指针。
3. 否则，索引项存储一个仅指向具有该搜索码值的第一条记录的指针。在这种情况下，如果待删除的记录是具有该搜索码值的第一条记录，系统就更新索引项，使其指向下一条记录

- 稀疏索引:

1. 如果索引中并不包含具有待删除记录搜索码值的索引项，则索引不必做任何改动。否则系统执行如下操作。
2. 如果待删除记录是具有该搜索码值的唯一记录，则系统用下一个搜索码值（按搜索码次序）的索引记录来替换相应的索引记录。如果下一个搜索码值已经有了一个索引项，则删除而不是替换该索引项。
3. 否则，如果该搜索码值的索引项指向待删除的记录，系统就更新索引项，使其指向具有相同搜索码值的下一条记录。

## 辅助索引

- 辅助索引（非聚集索引）必须是稠密的，对每个搜索码值都有一个索引项，并且对文件中的每条记录都有一个指针。

1. 聚集索引可以是稀疏的，只存储部分搜索码值，通过顺序访问文件的一部分，总可以找到带有中间搜索码值的记录。但如果辅助索引只存储部分搜索码值，则具有中间搜索码值的记录可能存在于文件中的任何位置，通常只能通过扫描整个文件才能找到它们。
2. 也就是说，如果辅助索引的搜索码不是候选码，则仅仅指向具有每个搜索码值的第一条记录是不够的。具有相同搜索码值的其余记录可能分布在文件的任何位置（非顺序存放），因为记录是按聚集索引用搜索码而不是按辅助索引的搜索码次序存放的。因此，辅助索引必须包含指向所有记录的指针。

- 非唯一性搜索码（nonunique search key）：如果一种关系可以有不止一条包含相同搜索码值的记录（即两条或多条记录对于索引算性可以具有相同的值），则搜索码被称为非唯一性搜索码（nonunique search key）。
- 在非唯一性搜索码上实现辅助索引的一种方式如下，与主索引的情况不同，这种辅助索引中的指针并不直接指向记录。相反，索引中的每个指针都指向一个桶（附加的间接指针层），该桶继而又包含指向文件的指针。

1. 由于附加的间接指针层可能需要随机I/O操作，因此，索引访问需要花费更长的时间。
2. 如果一个码很少或没有重复，那么将整个块分配给其关联的桶会浪费大量的空间。

- 对于聚集索引的更新算法也适用于辅助索引。
- 辅助索引提高了使用除了聚集索引的搜索码外的码的查询性能，但是会给修改数据库带来很大的开销。

## 多码索引

- 一个搜索码可以有多个属性，而包含多个属性（属性列表）的搜索码被称为复合搜索码（composite search key）。

1. 复合搜索码可以表示为形如<code>(a<sub>1</sub>,..., a<sub>n</sub>) </code>的值的元组，其中索引属性是<code>A<sub>1</sub>, ..., A<sub>n</sub>。
2. 搜索码值按照字典序（lexicographic ordering）排列，字典序和单词的字母次序基本一致。例如，对于具有两个属性的搜索码的情况，如果<code>a<sub>1</sub>&lt;b<sub>1</sub>，或a<sub>1</sub>=b<sub>1</sub>且a<sub>2</sub>&lt;b<sub>2</sub>，则(a<sub>1</sub>, a<sub>2</sub>)&lt;(b<sub>1</sub>, b<sub>2</sub>)</code>。

# B<sup>+</sup>树索引文件



# 散列索引（哈希索引机制）

- 哈希(Hash)索引机制（散列技术）利用<b>散列函数（Hash Function）</b>实现记录域（查找码、散列域、排序域）到记录物理地址间的直接映射关系。
- 当需要访问数据文件中查找码值为s<sub>i</sub>的某个或某些目标记录时，将s<sub>i</sub>作为散列函数h的输入，计算得出的散列函数输出值h(s<sub>i</sub>)就是目标记录在数据文件中的物理地址。
