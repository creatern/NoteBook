# 源码导出
## user\_source数据字典导出

- all\_source、dba\_source。
- xxx\_source数据字典中没有存放触发器的源代码。

``` plsql
select line, text
from user_source
where lower(name) = 存储过程名|存储函数名|软件包名
```

## 导出触发器的类型/触发事件/描述/代码

- user\_objects：对象数据字典

```sql
select object_name, object_type, created, status, last_ddl_time  --最后使用时间    
from user_objects
where object_type = 'TRIGGER';
```

- user\_triggers。

```sql
select trigger_name, table_name, triggering_event, status
from user_triggers;
```

```sql
-- 触发器的描述
select description
from user_triggers
where lower(trigger_name) = '触发器名';

-- 获取触发器的源代码
select trigger_body
from user_triggers
where lower(trigger_name) = '触发器名';
```

# PL/SQL源代码加密及动态加密

- Oracle使用模糊（Obfuscation）或封装（wrapping）的技术来加密PL/SQL程序代码，隐藏PL/SQL源代码的处理。可以防止其他人真正看到源程序代码，任何人也无法通过数据字典user\_source、all\_source、dba\_source看到源代码。SQL\*PIus可以处理模糊的（加密的）源文件，并且导入（Import）和导出（Export）实用程序也接受封装的（加密的）文件。

- Oracle中既可以使用软件包dbms\_ddl的子程序加密（封装）PL/SQL源代码，也可以使用封装实用程序（wrap utility）加密PL/SQL源代码。通常使用软件包dbms\_ddl的子程序加密（封装）一个单独的PL/SQL程序单元，而封装实用程序（wrap utility）是以命令行的方式。

| 加密方式        | 说明                                                         |
| --------------- | ------------------------------------------------------------ |
| wrap实用程序    | 处理一个输入的SQL文件，并只将该文件中的PL/SQL程序单元加密（模糊）。<br />可加密的PL/SQL程序单元包括：软件包说明和体、过程和函数、类型说明和类型体。<br />不能加密（模糊）文件中的如下内容：匿名PL/SQL程序块、触发器、非PL/SQL代码。 |
| 软件包dbms\_ddl | 加密（模糊）在另一个程序单元中动态产生的程序单元 。<br />dbms_ddl中的子程序每次执行时只接受一个create or replace语句，无法一次加密多个程序单元。 |

- 在加密（封装）一个软件包时，只能加密这个软件包体，不能加密这个软件包说明，因为其他程序员在使用该软件包时需要知道公有变量和子程序等信息。以这样的方式加密软件包，其他程序员或用户可以使用这个软件包，但是他们无法了解软件包实现的细节（程序的逻辑流程)。
- 加密（封装）程序（包括软件包dbms_ddl中的加密子程序和wrap实用程序）只能探测到语法错误，不能探测到语义错误，因为加密（封装）程序无法解析外部引用。然而，PL/SQL编译器会解析外部引用。因此，语义错误是指加密输出文件(plb文件)被编译时报告的。
- 由于加密后的输出文件无法编辑，所以必须保留并维护原始的PL/SOL程序源代码。如果需要（如一个引用的对象发生了变化），将修改源代码并重新加密修改后的源代码。
- 确保加密源代码的所有重要部分，并在发布应用程序之前使用正文编辑器浏览加密后的文件以确认没有遗漏。

## dbms_ddl软件包

- 动态加密：在创建一个PL/SQL程序单元的同时对这个程序单元的源代码进行加密。调用软件包dbms\_ddl中的两个子程序实现的（create_wrapped过程、wrap函数）。

| 子程序              | 说明                                                         |
| ------------------- | ------------------------------------------------------------ |
| create\_wrapped过程 | 将一个单独的create or replace语句作为输入。<br />PL/SQL源代码正文已经被加密（模糊）并执行这个新产生的语句。 |
| wrap函数            | 将一个单独的create or replace语句作为输入，允许比create_wrapped过程更大的输入 。<br />这个语句中PL/SQL程序单元的正文已经被加密（模糊）。 |

> 被加密的create or replace语句可以是创建一个PL/SQL软件包说明、一个软件包体、函数、过程、类型说明或类型体。

```plsql
begin 
  dbms_ddl.create_wrapped('加密的代码');
  -- 加密的代码可以先放在一个字符串常量里面；
end;
```

```plsql
begin
 dbms_ddl.create_wrapped ('
   create or replace procedure show_time is
   begin
     dbms_output.put_line(''当前时间：''||sysdate);
   end;
 ');
end;
```

```plsql
declare
  c_code constant varchar2(10000) := '
   create or replace procedure show_time is
    begin
      dbms_output.put_line(''当前时间：''||sysdate);
    end;
  ';
begin
  dbms_ddl.create_wrapped(c_code);
end;
```

## wrap PL/SQL封装实用程序

- PL/SQL的封装实用程序（Wrap Utility）是一个独立的实用程序，将PL/SQL的源代码转换成可移植的目标代码（portable object code）。利用这一实用程序，能够以一种不暴露源程序代码的方式交付PL/SQL应用程序。

- 封装（加密）后的程序代码具有以下一些特殊性质：

1. 独立于任何IT平台，因此一个编译的程序单元只需发布一个版本。
2. 允许动态装入，因此用户在添加一个新特性时不需要关闭和重新启动系统。
3. 允许动态绑定，因此外部引用的解析是在装入时进行的。
4. 提供了严格的依赖检查，因此无效的程序单元在调用时被自动地重新编译。
5. 支持正常的导入和导出操作，因此导入/导出（import/export）实用程序可以处理封装（加密)的文件。

```shell
# 系统控制台中操作 不能有空格，也别加分号；不然会认为文件名里面也有分号
wrap iname=输入文件名 [oname=输出文件名]
```

- 输入文件可以包括任何SQL语句的组合，然而PL/SQL封装程序只封装（加密）如下的create语句：
1. create \[or replace\] type
2. create \[or replace\] type body
3. create \[or replace\] package
4. create \[or replace\] package body
5. create \[or replace\] function
6. create \[or replace\] procedure
- 除了以上列出的create语句之外，所有其他的SQL create语句都被原样存入输出文件（即没有加密)。

**在使用以上命令加密一个操作系统文件时，Oracle系统有如下约定：**

1. 只有iname参数是必需的。如果没有说明oname参数，那么输出文件的名字与输入文件相同，但是其文件的扩展名为plb。
2. 输入文件的扩展名可以是任意的扩展名，但是默认扩展名为\.\$sql。
3. name和oname参数的值（即输入文件名和输出文件名）是否区分大小写取决于使用的操作系统。
4. 通常输出文件要比输入文件大许多。
5. 在name和oname之间的等号两边不能有任何空格。

- 当封装（加密）的文件创建成功之后，要在SQL\*Plus中执行这个加密后的\.plb文件以编译加密后的源代码并将其存储在数据库中，其执行方法与执行SQL脚本文件一模一样。

- 当一个文件被封装（加密）之后，其中的对象类型、子程序具有如下形式：头，紧跟一个单词，wrapped，随后是加密的程序体。

```
g:\sqlTest>wrap iname=wraptest.sql oname=testout.pld;

PL/SQL wrapper: Release 11.2.0.1.0- 64bit Production on 星期六 10月 15 19:04:52 2022
Copyright (c) 1993, 2009, Oracle.  all rights reserved.
Processing wraptest.sql to testout.pld;

g:\sqlTest>type testout.pld
create or replace procedure show_name wrapped
a000000
354
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
abcd
7
5f 9e
vyFRGoGq/9HR5cTR1Eu3tRhA6D0wg5nnm7+fMr2ywFwW/4WW0HIMRy5DJY8J523+x9IyXOfH
dMAzuHRlJXxlUF0lXZt0iwm4wDL+0oYJpuEfSZqPMLVQyKlQLwDKSv4I0sc9qRF3oisJuIHH
LcmmpvpLBBA=

g:\sqlTest>notepad testout.pld
--记事本打开也是加密

SQL> @G:\sqlTest\testout.pld

过程已创建。
```
