- 在日志表中，自治事务使得创建独立的事务成为可能。一个自治事务（AT）是一个由另外一个主事务（Main Transaction，MT）开启的独立事务，自治事务是使用`pragma autonomous_transaction`定义的。

- `pragma autonomous_transaction`指示PL/SQL编译器将一个例行程序标记为自治的（独立的），可以声明在一个例行程序的声明段中的任意位置，一般放在声明段的最上方。

> 例行程序：最外层的匿名PL/SQL程序块、本地的/独立的/软件包的函数和过程、一个SQL对象类型的方法、数据库触发器。

```plsql
create or replace procedure sal_between
 (
  v_min_sal number
 ,v_max_sal number
 )
 is
  pragma autonomous_transaction;
--自治事物
  cursor emp_id_cursor is
   select employee_id
   from copy_emp
   where salary between v_min_sal and v_max_sal;

  begin
    for c in emp_id_cursor loop
      dbms_output.put_line(c.employee_id);
    end loop;
    commit;
  end;

***********
create or replace procedure test_pro
is
 begin
  sal_between(1000,2000);
  rollback
 end;
```

- 主事务与自治事务之间的关系，具体操作顺序如下：

1. 主事务开始。
2. 主事务调用存储过程以启动自治事务。
3. 主事务处于挂起状态。
4. 自治事务操作开始。
5. 自治事务以一个commit或rollback语句结束。
6. 主事务操作被恢复。
7. 主事务结束。

- 自治事务的特性和限制如下：

1. 虽然是在一个事务中调用，但是自治事务是独立（不依赖）于主事务的，即主事务与自治事务不是嵌套事务（没有嵌套关系）。
2. 如果主事务回滚，那么自治事务并不回滚。
3. 当一个自治事务提交时，其他事务可以看见该自治事务所做的改变。
4. 主事务与自治事务的操作方式类似堆栈，在任何给定的时间只有“最上层”的事务可以访问。当自治事务结束时，该自治事务被弹出，并且调用事务（主事务）被恢复。
5. 自治事务可以被递归地调用，而且除了受限于资源之外，对于递归调用的层数没有任何限制。
6. 不能使用关键字pragma将一个软件包中的子程序标记为自治的，只能将独立的子程序标记为自治的。
7. 不能将一个嵌套的PL/SQL程序块、或匿名的PL/SQL程序块标记为自治的。

- 自治事务的使用好处：

1. 当一个自治事务开始之后是完全独立的，该自治事务不依赖于主事务的提交，也不与主事务共享锁或其他资源。
2. 自治事务可以帮助创建模块化和能够重用的软件组件。

> 例如，一些存储过程可以开始和完成它们自己的自治事务。一个调用应用程序不需要知道有一个过程的自治操作，并且这个过程也不需要知道该应用程序的事务操作情况。这使得自治事务比普通的事务产生错误的几率更低，而且更容易使用。
